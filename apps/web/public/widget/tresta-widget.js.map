{"version":3,"file":"tresta-widget.js","sources":["../src/types/index.ts","../src/styles/theme-manager.ts","../src/styles/style-manager.ts","../src/api/network.ts","../src/api/retry.ts","../src/api/rate-limiter.ts","../src/utils/logger.ts","../src/api/client.ts","../src/storage/indexeddb.ts","../src/storage/localstorage.ts","../src/storage/cache-manager.ts","../src/components/error-state.ts","../src/telemetry/sampler.ts","../src/telemetry/tracker.ts","../src/components/testimonial-card.ts","../src/layouts/carousel.ts","../src/layouts/grid.ts","../src/layouts/masonry.ts","../src/layouts/wall.ts","../src/layouts/list.ts","../src/layouts/index.ts","../src/utils/testimonial-limiter.ts","../src/security/csp-validator.ts","../src/core/widget.ts","../src/core/loader.ts","../src/core/config.ts","../src/index.ts"],"sourcesContent":["/**\r\n * Core type definitions for the Tresta Widget System\r\n */\r\n\r\nexport interface WidgetConfig {\r\n  widgetId: string;\r\n  apiKey: string;\r\n  container?: string | HTMLElement;\r\n  debug?: boolean;\r\n  telemetry?: boolean;\r\n  version?: string;\r\n  theme?: ThemeConfig;\r\n  errorMessage?: string;\r\n  emptyMessage?: string;\r\n  apiUrl?: string;\r\n  lang?: string; // Language code for localization (e.g., 'en', 'es', 'fr')\r\n  useShadowDOM?: boolean; // Whether to use Shadow DOM for style isolation (default: true)\r\n  nonce?: string; // CSP nonce propagated from host environments\r\n}\r\n\r\nexport interface WidgetInstance {\r\n  mount(container: HTMLElement): Promise<void>;\r\n  unmount(): void;\r\n  refresh(): Promise<void>;\r\n  getState(): WidgetState;\r\n}\r\n\r\nexport interface WidgetState {\r\n  mounted: boolean;\r\n  loading: boolean;\r\n  error: Error | null;\r\n  data: WidgetData | null;\r\n}\r\n\r\nexport interface WidgetData {\r\n  widgetId: string;\r\n  config: WidgetDisplayConfig;\r\n  testimonials: Testimonial[];\r\n}\r\n\r\nexport interface WidgetDisplayConfig {\r\n  layout: LayoutConfig;\r\n  theme: ThemeConfig;\r\n  display: DisplayOptions;\r\n}\r\n\r\nexport interface LayoutConfig {\r\n  type: 'carousel' | 'grid' | 'masonry' | 'wall' | 'list';\r\n  maxTestimonials?: number;\r\n  autoRotate?: boolean;\r\n  rotateInterval?: number;\r\n  showNavigation?: boolean;\r\n  columns?: number;\r\n}\r\n\r\nexport interface ThemeConfig {\r\n  mode: 'light' | 'dark' | 'auto';\r\n  primaryColor: string;\r\n  secondaryColor: string;\r\n  fontFamily?: string;\r\n  cardStyle: 'default' | 'minimal' | 'bordered';\r\n}\r\n\r\nexport interface DisplayOptions {\r\n  showRating: boolean;\r\n  showDate: boolean;\r\n  showAvatar: boolean;\r\n  showAuthorRole: boolean;\r\n  showAuthorCompany: boolean;\r\n  maxTestimonials?: number;\r\n}\r\n\r\nexport interface Testimonial {\r\n  id: string;\r\n  content: string;\r\n  rating: number;\r\n  createdAt: string;\r\n  isPublished: boolean;\r\n  isApproved: boolean;\r\n  isOAuthVerified: boolean;\r\n  oauthProvider?: string;\r\n  author: {\r\n    name: string;\r\n    email?: string;\r\n    avatar?: string;\r\n    role?: string;\r\n    company?: string;\r\n  };\r\n  media?: {\r\n    type: 'image' | 'video';\r\n    url: string;\r\n    thumbnail?: string;\r\n  };\r\n}\r\n\r\nexport enum WidgetErrorCode {\r\n  INVALID_WIDGET_ID = 'INVALID_WIDGET_ID',\r\n  API_TIMEOUT = 'API_TIMEOUT',\r\n  API_ERROR = 'API_ERROR',\r\n  NETWORK_ERROR = 'NETWORK_ERROR',\r\n  RATE_LIMITED = 'RATE_LIMITED',\r\n  UNAUTHORIZED = 'UNAUTHORIZED',\r\n  PARSE_ERROR = 'PARSE_ERROR',\r\n  RENDER_ERROR = 'RENDER_ERROR',\r\n}\r\n\r\nexport class WidgetError extends Error {\r\n  constructor(\r\n    public code: WidgetErrorCode,\r\n    message: string,\r\n    public recoverable: boolean = true\r\n  ) {\r\n    super(message);\r\n    this.name = 'WidgetError';\r\n  }\r\n}\r\n","/**\r\n * Theme Manager - Handles theme configuration and CSS custom properties\r\n */\r\n\r\nimport type { ThemeConfig } from '../types';\r\n\r\nexport interface ThemeManagerConfig {\r\n  theme?: ThemeConfig;\r\n  debug?: boolean;\r\n}\r\n\r\nexport class ThemeManager {\r\n  private theme: ThemeConfig;\r\n  private debug: boolean;\r\n\r\n  constructor(config: ThemeManagerConfig = {}) {\r\n    this.theme = config.theme ?? this.getDefaultTheme();\r\n    this.debug = config.debug ?? false;\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] ThemeManager initialized with theme:', this.theme);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get default theme configuration\r\n   */\r\n  private getDefaultTheme(): ThemeConfig {\r\n    return {\r\n      mode: 'light',\r\n      primaryColor: '#3b82f6',\r\n      secondaryColor: '#64748b',\r\n      cardStyle: 'default',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Apply theme to a root element\r\n   */\r\n  applyTheme(root: HTMLElement): void {\r\n    // Apply theme mode\r\n    this.applyThemeMode(root);\r\n\r\n    // Apply colors\r\n    this.applyColors(root);\r\n\r\n    // Apply font family\r\n    this.applyFontFamily(root);\r\n\r\n    // Apply card style\r\n    this.applyCardStyle(root);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Theme applied to root element');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply theme mode (light/dark/auto)\r\n   */\r\n  private applyThemeMode(root: HTMLElement): void {\r\n    let effectiveMode = this.theme.mode;\r\n\r\n    // Handle auto mode\r\n    if (effectiveMode === 'auto') {\r\n      effectiveMode = this.detectPreferredColorScheme();\r\n    }\r\n\r\n    root.setAttribute('data-theme', effectiveMode);\r\n  }\r\n\r\n  /**\r\n   * Detect user's preferred color scheme\r\n   */\r\n  private detectPreferredColorScheme(): 'light' | 'dark' {\r\n    if (typeof window !== 'undefined' && window.matchMedia) {\r\n      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\r\n      return prefersDark ? 'dark' : 'light';\r\n    }\r\n    return 'light';\r\n  }\r\n\r\n  /**\r\n   * Apply primary and secondary colors via CSS custom properties\r\n   */\r\n  private applyColors(root: HTMLElement): void {\r\n    root.style.setProperty('--tresta-primary-color', this.theme.primaryColor);\r\n    root.style.setProperty('--tresta-secondary-color', this.theme.secondaryColor);\r\n  }\r\n\r\n  /**\r\n   * Apply custom font family with fallback\r\n   */\r\n  private applyFontFamily(root: HTMLElement): void {\r\n    if (this.theme.fontFamily) {\r\n      // Add fallback fonts for better compatibility\r\n      const fontFamilyWithFallback = `${this.theme.fontFamily}, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;\r\n      root.style.setProperty('--tresta-font-family', fontFamilyWithFallback);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply card style\r\n   */\r\n  private applyCardStyle(root: HTMLElement): void {\r\n    root.setAttribute('data-card-style', this.theme.cardStyle);\r\n  }\r\n\r\n  /**\r\n   * Update theme configuration\r\n   */\r\n  updateTheme(theme: Partial<ThemeConfig>): void {\r\n    this.theme = {\r\n      ...this.theme,\r\n      ...theme,\r\n    };\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Theme updated:', this.theme);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current theme configuration\r\n   */\r\n  getTheme(): ThemeConfig {\r\n    return { ...this.theme };\r\n  }\r\n\r\n  /**\r\n   * Parse theme configuration from data attributes\r\n   */\r\n  static parseThemeFromElement(element: HTMLElement): Partial<ThemeConfig> {\r\n    const theme: Partial<ThemeConfig> = {};\r\n\r\n    // Parse theme mode\r\n    const mode = element.getAttribute('data-theme-mode');\r\n    if (mode === 'light' || mode === 'dark' || mode === 'auto') {\r\n      theme.mode = mode;\r\n    }\r\n\r\n    // Parse primary color\r\n    const primaryColor = element.getAttribute('data-primary-color');\r\n    if (primaryColor) {\r\n      theme.primaryColor = primaryColor;\r\n    }\r\n\r\n    // Parse secondary color\r\n    const secondaryColor = element.getAttribute('data-secondary-color');\r\n    if (secondaryColor) {\r\n      theme.secondaryColor = secondaryColor;\r\n    }\r\n\r\n    // Parse font family\r\n    const fontFamily = element.getAttribute('data-font-family');\r\n    if (fontFamily) {\r\n      theme.fontFamily = fontFamily;\r\n    }\r\n\r\n    // Parse card style\r\n    const cardStyle = element.getAttribute('data-card-style');\r\n    if (cardStyle === 'default' || cardStyle === 'minimal' || cardStyle === 'bordered') {\r\n      theme.cardStyle = cardStyle;\r\n    }\r\n\r\n    return theme;\r\n  }\r\n}\r\n","/**\r\n * Style Manager - Handles Shadow DOM and CSS isolation\r\n */\r\n\r\nimport baseStyles from './base.css?inline';\r\nimport testimonialCardStyles from '../components/testimonial-card.css?inline';\r\nimport errorStateStyles from '../components/error-state.css?inline';\r\nimport listStyles from '../layouts/list.css?inline';\r\nimport gridStyles from '../layouts/grid.css?inline';\r\nimport masonryStyles from '../layouts/masonry.css?inline';\r\nimport wallStyles from '../layouts/wall.css?inline';\r\nimport carouselStyles from '../layouts/carousel.css?inline';\r\nimport { ThemeManager, type ThemeManagerConfig } from './theme-manager';\r\n\r\n// Combine all styles\r\nconst BASE_STYLES = `\r\n${baseStyles}\r\n\r\n${testimonialCardStyles}\r\n\r\n${errorStateStyles}\r\n\r\n${listStyles}\r\n\r\n${gridStyles}\r\n\r\n${masonryStyles}\r\n\r\n${wallStyles}\r\n\r\n${carouselStyles}\r\n`.trim();\r\n\r\nexport interface StyleManagerConfig {\r\n  useShadowDOM?: boolean;\r\n  debug?: boolean;\r\n  theme?: ThemeManagerConfig['theme'];\r\n  nonceApplier?: ((element: HTMLElement) => void) | undefined;\r\n}\r\n\r\nexport class StyleManager {\r\n  private shadowRoot: ShadowRoot | null = null;\r\n  private useShadowDOM: boolean;\r\n  private debug: boolean;\r\n  private themeManager: ThemeManager;\r\n  private nonceApplier?: ((element: HTMLElement) => void) | undefined;\r\n\r\n  constructor(config: StyleManagerConfig = {}) {\r\n    this.useShadowDOM = config.useShadowDOM ?? this.detectShadowDOMSupport();\r\n    this.debug = config.debug ?? false;\r\n    this.nonceApplier = config.nonceApplier;\r\n    \r\n    const themeConfig: ThemeManagerConfig = { debug: this.debug };\r\n    if (config.theme) {\r\n      themeConfig.theme = config.theme;\r\n    }\r\n    this.themeManager = new ThemeManager(themeConfig);\r\n\r\n    if (this.debug) {\r\n      console.log(`[TrestaWidget] StyleManager initialized with Shadow DOM: ${this.useShadowDOM}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detect if Shadow DOM is supported\r\n   */\r\n  private detectShadowDOMSupport(): boolean {\r\n    return 'attachShadow' in Element.prototype;\r\n  }\r\n\r\n  /**\r\n   * Initialize styles for the widget\r\n   * Returns the root element where content should be rendered\r\n   */\r\n  initializeStyles(container: HTMLElement): HTMLElement {\r\n    if (this.useShadowDOM) {\r\n      return this.initializeShadowDOM(container);\r\n    } else {\r\n      return this.initializeNamespacedCSS(container);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize Shadow DOM with encapsulated styles\r\n   */\r\n  private initializeShadowDOM(container: HTMLElement): HTMLElement {\r\n    // Attach shadow root\r\n    this.shadowRoot = container.attachShadow({ mode: 'open' });\r\n\r\n    // Create style element\r\n    const styleElement = document.createElement('style');\r\n    this.applyNonce(styleElement);\r\n    styleElement.textContent = this.getShadowDOMStyles();\r\n    this.shadowRoot.appendChild(styleElement);\r\n\r\n    // Create content wrapper\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.setAttribute('data-tresta-widget-root', 'true');\r\n    contentWrapper.setAttribute('data-tresta-widget', 'true');\r\n    this.shadowRoot.appendChild(contentWrapper);\r\n\r\n    // Apply theme\r\n    this.themeManager.applyTheme(contentWrapper);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Shadow DOM initialized');\r\n    }\r\n\r\n    return contentWrapper;\r\n  }\r\n\r\n  /**\r\n   * Initialize namespaced CSS fallback for older browsers\r\n   */\r\n  private initializeNamespacedCSS(container: HTMLElement): HTMLElement {\r\n    // Add namespaced class to container\r\n    container.classList.add('tresta-widget');\r\n\r\n    // Inject namespaced styles if not already present\r\n    if (!document.getElementById('tresta-widget-styles')) {\r\n      const styleElement = document.createElement('style');\r\n      styleElement.id = 'tresta-widget-styles';\r\n      this.applyNonce(styleElement);\r\n      styleElement.textContent = this.getNamespacedStyles();\r\n      document.head.appendChild(styleElement);\r\n    }\r\n\r\n    // Create content wrapper\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.setAttribute('data-tresta-widget-root', 'true');\r\n    contentWrapper.setAttribute('data-tresta-widget', 'true');\r\n    contentWrapper.classList.add('tresta-widget-root');\r\n    container.appendChild(contentWrapper);\r\n\r\n    // Apply theme\r\n    this.themeManager.applyTheme(contentWrapper);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Namespaced CSS initialized');\r\n    }\r\n\r\n    return contentWrapper;\r\n  }\r\n\r\n  /**\r\n   * Get styles for Shadow DOM (no namespacing needed)\r\n   */\r\n  private getShadowDOMStyles(): string {\r\n    return BASE_STYLES;\r\n  }\r\n\r\n  /**\r\n   * Get namespaced styles for fallback mode\r\n   */\r\n  private getNamespacedStyles(): string {\r\n    // Transform base styles to be namespaced\r\n    // Replace :root with .tresta-widget\r\n    // Replace [data-tresta-widget] with .tresta-widget-root\r\n    let namespacedStyles = BASE_STYLES\r\n      .replace(/:root\\s*{/g, '.tresta-widget {')\r\n      .replace(/\\[data-tresta-widget\\]/g, '.tresta-widget-root');\r\n\r\n    // Add high specificity to prevent host page overrides\r\n    namespacedStyles = `.tresta-widget { all: initial; }\\n${namespacedStyles}`;\r\n\r\n    return namespacedStyles;\r\n  }\r\n\r\n  /**\r\n   * Clean up styles\r\n   */\r\n  cleanup(): void {\r\n    this.shadowRoot = null;\r\n    \r\n    // Note: We don't remove the global style element in namespaced mode\r\n    // because other widget instances might be using it\r\n  }\r\n\r\n  /**\r\n   * Get the theme manager\r\n   */\r\n  getThemeManager(): ThemeManager {\r\n    return this.themeManager;\r\n  }\r\n\r\n  /**\r\n   * Check if Shadow DOM is being used\r\n   */\r\n  isShadowDOM(): boolean {\r\n    return this.useShadowDOM;\r\n  }\r\n\r\n  /**\r\n   * Get the shadow root (if using Shadow DOM)\r\n   */\r\n  getShadowRoot(): ShadowRoot | null {\r\n    return this.shadowRoot;\r\n  }\r\n\r\n  /**\r\n   * Apply CSP nonce when provided\r\n   */\r\n  private applyNonce(element: HTMLElement): void {\r\n    if (this.nonceApplier) {\r\n      this.nonceApplier(element);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Network layer with fetch and timeout support\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\nimport type { RequestOptions, APIResponse } from './types';\r\n\r\n/**\r\n * Create a fetch request with timeout support\r\n */\r\nexport async function fetchWithTimeout<T>(\r\n  url: string,\r\n  options: RequestOptions = {}\r\n): Promise<APIResponse<T>> {\r\n  const {\r\n    method = 'GET',\r\n    headers = {},\r\n    body,\r\n    timeout = 10000, // 10 second default timeout\r\n  } = options;\r\n\r\n  // Create an AbortController for timeout\r\n  const controller = new AbortController();\r\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n  try {\r\n    const fetchOptions: RequestInit = {\r\n      method,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...headers,\r\n      },\r\n      signal: controller.signal,\r\n      credentials: 'omit', // Never send credentials (withCredentials: false)\r\n    };\r\n\r\n    if (body && method !== 'GET') {\r\n      fetchOptions.body = JSON.stringify(body);\r\n    }\r\n\r\n    const response = await fetch(url, fetchOptions);\r\n\r\n    clearTimeout(timeoutId);\r\n\r\n    // Parse response\r\n    let data: T;\r\n    const contentType = response.headers.get('content-type');\r\n    \r\n    if (contentType && contentType.includes('application/json')) {\r\n      data = await response.json();\r\n    } else {\r\n      data = (await response.text()) as unknown as T;\r\n    }\r\n\r\n    return {\r\n      data,\r\n      status: response.status,\r\n      headers: response.headers,\r\n    };\r\n  } catch (error) {\r\n    clearTimeout(timeoutId);\r\n\r\n    // Handle abort (timeout)\r\n    if (error instanceof Error && error.name === 'AbortError') {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.API_TIMEOUT,\r\n        `Request timed out after ${timeout}ms`,\r\n        true\r\n      );\r\n    }\r\n\r\n    // Handle network errors\r\n    if (error instanceof TypeError) {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.NETWORK_ERROR,\r\n        'Network request failed. Please check your connection.',\r\n        true\r\n      );\r\n    }\r\n\r\n    // Re-throw other errors\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Request interceptor - can be used to modify requests before sending\r\n */\r\nexport type RequestInterceptor = (\r\n  url: string,\r\n  options: RequestOptions\r\n) => { url: string; options: RequestOptions } | Promise<{ url: string; options: RequestOptions }>;\r\n\r\n/**\r\n * Response interceptor - can be used to modify responses after receiving\r\n */\r\nexport type ResponseInterceptor = <T>(\r\n  response: APIResponse<T>\r\n) => APIResponse<T> | Promise<APIResponse<T>>;\r\n\r\n/**\r\n * Network client with interceptor support\r\n */\r\nexport class NetworkClient {\r\n  private requestInterceptors: RequestInterceptor[] = [];\r\n  private responseInterceptors: ResponseInterceptor[] = [];\r\n\r\n  /**\r\n   * Add a request interceptor\r\n   */\r\n  addRequestInterceptor(interceptor: RequestInterceptor): void {\r\n    this.requestInterceptors.push(interceptor);\r\n  }\r\n\r\n  /**\r\n   * Add a response interceptor\r\n   */\r\n  addResponseInterceptor(interceptor: ResponseInterceptor): void {\r\n    this.responseInterceptors.push(interceptor);\r\n  }\r\n\r\n  /**\r\n   * Execute a request with interceptors\r\n   */\r\n  async request<T>(url: string, options: RequestOptions = {}): Promise<APIResponse<T>> {\r\n    // Apply request interceptors\r\n    let modifiedUrl = url;\r\n    let modifiedOptions = options;\r\n\r\n    for (const interceptor of this.requestInterceptors) {\r\n      const result = await interceptor(modifiedUrl, modifiedOptions);\r\n      modifiedUrl = result.url;\r\n      modifiedOptions = result.options;\r\n    }\r\n\r\n    // Execute request\r\n    let response = await fetchWithTimeout<T>(modifiedUrl, modifiedOptions);\r\n\r\n    // Apply response interceptors\r\n    for (const interceptor of this.responseInterceptors) {\r\n      response = await interceptor(response);\r\n    }\r\n\r\n    return response;\r\n  }\r\n}\r\n","/**\r\n * Retry logic with exponential backoff and jitter\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\n\r\nexport interface RetryConfig {\r\n  maxRetries: number;\r\n  baseDelay: number; // Base delay in milliseconds\r\n  maxDelay: number; // Maximum delay in milliseconds\r\n  jitter: number; // Jitter in milliseconds\r\n}\r\n\r\nconst DEFAULT_RETRY_CONFIG: RetryConfig = {\r\n  maxRetries: 3,\r\n  baseDelay: 1000, // 1 second\r\n  maxDelay: 10000, // 10 seconds\r\n  jitter: 1000, // 1 second\r\n};\r\n\r\n/**\r\n * Calculate delay with exponential backoff and jitter\r\n * Formula: delay = base * 2^attempt + random(0, jitter)\r\n */\r\nfunction calculateDelay(attempt: number, config: RetryConfig): number {\r\n  const exponentialDelay = config.baseDelay * Math.pow(2, attempt);\r\n  const jitter = Math.random() * config.jitter;\r\n  const delay = Math.min(exponentialDelay + jitter, config.maxDelay);\r\n  return delay;\r\n}\r\n\r\n/**\r\n * Sleep for a specified duration\r\n */\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Determine if an error is retryable\r\n */\r\nfunction isRetryableError(error: unknown): boolean {\r\n  if (error instanceof WidgetError) {\r\n    // Only retry if the error is marked as recoverable\r\n    // Retryable error codes: API_TIMEOUT, NETWORK_ERROR, API_ERROR\r\n    // Note: RATE_LIMITED is NOT retried - it should fail immediately\r\n    const retryableCodes = [\r\n      WidgetErrorCode.API_TIMEOUT,\r\n      WidgetErrorCode.NETWORK_ERROR,\r\n      WidgetErrorCode.API_ERROR,\r\n    ];\r\n    return error.recoverable && retryableCodes.includes(error.code);\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Retry a function with exponential backoff\r\n */\r\nexport async function retry<T>(\r\n  fn: () => Promise<T>,\r\n  config: Partial<RetryConfig> = {}\r\n): Promise<T> {\r\n  const retryConfig = { ...DEFAULT_RETRY_CONFIG, ...config };\r\n  let lastError: unknown;\r\n\r\n  for (let attempt = 0; attempt < retryConfig.maxRetries; attempt++) {\r\n    try {\r\n      return await fn();\r\n    } catch (error) {\r\n      lastError = error;\r\n\r\n      // Check if we should retry\r\n      if (!isRetryableError(error)) {\r\n        throw error;\r\n      }\r\n\r\n      // Check if we've exhausted retries\r\n      if (attempt === retryConfig.maxRetries - 1) {\r\n        throw error;\r\n      }\r\n\r\n      // Calculate delay and wait\r\n      const delay = calculateDelay(attempt, retryConfig);\r\n      \r\n      if (error instanceof WidgetError) {\r\n        console.warn(\r\n          `[TrestaWidget] Request failed (attempt ${attempt + 1}/${retryConfig.maxRetries}): ${error.message}. Retrying in ${Math.round(delay)}ms...`\r\n        );\r\n      }\r\n\r\n      await sleep(delay);\r\n    }\r\n  }\r\n\r\n  // This should never be reached, but TypeScript needs it\r\n  throw lastError;\r\n}\r\n\r\n/**\r\n * Retry helper class for more complex retry scenarios\r\n */\r\nexport class RetryHelper {\r\n  private config: RetryConfig;\r\n\r\n  constructor(config: Partial<RetryConfig> = {}) {\r\n    this.config = { ...DEFAULT_RETRY_CONFIG, ...config };\r\n  }\r\n\r\n  /**\r\n   * Execute a function with retry logic\r\n   */\r\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\r\n    return retry(fn, this.config);\r\n  }\r\n\r\n  /**\r\n   * Update retry configuration\r\n   */\r\n  updateConfig(config: Partial<RetryConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): RetryConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * Rate limiter for client-side throttling\r\n * Implements 100 requests per minute per widgetId\r\n */\r\n\r\nexport interface RateLimiterConfig {\r\n  maxRequests: number; // Maximum requests per window\r\n  windowMs: number; // Time window in milliseconds\r\n}\r\n\r\nconst DEFAULT_RATE_LIMITER_CONFIG: RateLimiterConfig = {\r\n  maxRequests: 100,\r\n  windowMs: 60000, // 1 minute\r\n};\r\n\r\ninterface RequestRecord {\r\n  timestamps: number[];\r\n}\r\n\r\n/**\r\n * Rate limiter using sliding window algorithm\r\n */\r\nexport class RateLimiter {\r\n  private config: RateLimiterConfig;\r\n  private records: Map<string, RequestRecord> = new Map();\r\n\r\n  constructor(config: Partial<RateLimiterConfig> = {}) {\r\n    this.config = { ...DEFAULT_RATE_LIMITER_CONFIG, ...config };\r\n  }\r\n\r\n  /**\r\n   * Check if a request is allowed for the given key (widgetId)\r\n   * Returns true if allowed, false if rate limited\r\n   */\r\n  isAllowed(key: string): boolean {\r\n    const now = Date.now();\r\n    const record = this.getOrCreateRecord(key);\r\n\r\n    // Remove timestamps outside the current window\r\n    record.timestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    // Check if we're under the limit\r\n    if (record.timestamps.length < this.config.maxRequests) {\r\n      record.timestamps.push(now);\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Get the time until the next request is allowed (in milliseconds)\r\n   * Returns 0 if a request is currently allowed\r\n   */\r\n  getRetryAfter(key: string): number {\r\n    const now = Date.now();\r\n    const record = this.records.get(key);\r\n\r\n    if (!record || record.timestamps.length === 0) {\r\n      return 0;\r\n    }\r\n\r\n    // Remove timestamps outside the current window\r\n    record.timestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    // If we're under the limit, no wait needed\r\n    if (record.timestamps.length < this.config.maxRequests) {\r\n      return 0;\r\n    }\r\n\r\n    // Calculate when the oldest request will expire\r\n    const oldestTimestamp = record.timestamps[0];\r\n    if (!oldestTimestamp) {\r\n      return 0;\r\n    }\r\n    \r\n    const retryAfter = oldestTimestamp + this.config.windowMs - now;\r\n\r\n    return Math.max(0, retryAfter);\r\n  }\r\n\r\n  /**\r\n   * Reset rate limit for a specific key\r\n   */\r\n  reset(key: string): void {\r\n    this.records.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Reset all rate limits\r\n   */\r\n  resetAll(): void {\r\n    this.records.clear();\r\n  }\r\n\r\n  /**\r\n   * Get current request count for a key\r\n   */\r\n  getRequestCount(key: string): number {\r\n    const now = Date.now();\r\n    const record = this.records.get(key);\r\n\r\n    if (!record) {\r\n      return 0;\r\n    }\r\n\r\n    // Filter to only count requests in current window\r\n    const validTimestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    return validTimestamps.length;\r\n  }\r\n\r\n  /**\r\n   * Get or create a record for a key\r\n   */\r\n  private getOrCreateRecord(key: string): RequestRecord {\r\n    let record = this.records.get(key);\r\n\r\n    if (!record) {\r\n      record = { timestamps: [] };\r\n      this.records.set(key, record);\r\n    }\r\n\r\n    return record;\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  updateConfig(config: Partial<RateLimiterConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): RateLimiterConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * Centralized logging utility with debug mode support\r\n * \r\n * In production builds, console.debug calls are automatically removed by Terser\r\n * via the drop_console configuration in vite.config.ts\r\n */\r\n\r\nconst WIDGET_VERSION = '1.0.0';\r\n\r\nexport class Logger {\r\n  private widgetId: string;\r\n  private version: string;\r\n  private debugEnabled: boolean;\r\n\r\n  constructor(widgetId: string, version: string = WIDGET_VERSION, debugEnabled: boolean = false) {\r\n    this.widgetId = widgetId;\r\n    this.version = version;\r\n    this.debugEnabled = debugEnabled;\r\n  }\r\n\r\n  /**\r\n   * Log debug messages (only in debug mode, tree-shaken in production)\r\n   */\r\n  debug(message: string, ...args: any[]): void {\r\n    if (this.debugEnabled) {\r\n      console.debug(`[TrestaWidget v${this.version}]`, message, ...args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log info messages (always shown)\r\n   */\r\n  info(message: string, ...args: any[]): void {\r\n    console.log(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log warning messages (always shown)\r\n   */\r\n  warn(message: string, ...args: any[]): void {\r\n    console.warn(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log error messages (always shown)\r\n   */\r\n  error(message: string, ...args: any[]): void {\r\n    console.error(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log empty state (special case for requirement 20.4)\r\n   */\r\n  logEmpty(): void {\r\n    if (this.debugEnabled) {\r\n      console.debug(`[TrestaWidget v${this.version}] empty`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if debug mode is enabled\r\n   */\r\n  isDebugEnabled(): boolean {\r\n    return this.debugEnabled;\r\n  }\r\n\r\n  /**\r\n   * Get the widget ID\r\n   */\r\n  getWidgetId(): string {\r\n    return this.widgetId;\r\n  }\r\n\r\n  /**\r\n   * Get the version\r\n   */\r\n  getVersion(): string {\r\n    return this.version;\r\n  }\r\n}\r\n","/**\r\n * API Client with retry logic, rate limiting, and error handling\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\nimport type { WidgetData } from '../types';\r\nimport { NetworkClient } from './network';\r\nimport { retry } from './retry';\r\nimport { RateLimiter } from './rate-limiter';\r\nimport type { APIClientConfig } from './types';\r\nimport { Logger } from '../utils/logger';\r\n\r\nconst DEFAULT_API_CLIENT_CONFIG: APIClientConfig = {\r\n  baseURL: 'https://api.tresta.com',\r\n  timeout: 10000, // 10 seconds\r\n  maxRetries: 3,\r\n};\r\n\r\nconst DEFAULT_THEME_MODE = 'light';\r\nconst DEFAULT_PRIMARY_COLOR = '#0066FF';\r\nconst DEFAULT_SECONDARY_COLOR = '#00CC99';\r\nconst DEFAULT_MAX_TESTIMONIALS = 10;\r\nconst DEFAULT_ROTATE_INTERVAL = 5000;\r\n\r\n/**\r\n * API Client for fetching widget data\r\n */\r\nexport class APIClient {\r\n  private config: APIClientConfig;\r\n  private networkClient: NetworkClient;\r\n  private rateLimiter: RateLimiter;\r\n  private apiKey: string | undefined;\r\n  private logger: Logger | null = null;\r\n\r\n  constructor(config: Partial<APIClientConfig> = {}, apiKey?: string, logger?: Logger) {\r\n    this.config = { ...DEFAULT_API_CLIENT_CONFIG, ...config };\r\n    this.networkClient = new NetworkClient();\r\n    this.rateLimiter = new RateLimiter({\r\n      maxRequests: 100,\r\n      windowMs: 60000, // 100 requests per minute\r\n    });\r\n    this.apiKey = apiKey;\r\n    this.logger = logger || null;\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data from the API\r\n   */\r\n  async fetchWidgetData(widgetId: string): Promise<WidgetData> {\r\n    // Check if API key is provided\r\n    if (!this.apiKey) {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.UNAUTHORIZED,\r\n        'API key is required. Please provide an API key.',\r\n        false\r\n      );\r\n    }\r\n\r\n    // Check rate limit\r\n    if (!this.rateLimiter.isAllowed(widgetId)) {\r\n      const retryAfter = this.rateLimiter.getRetryAfter(widgetId);\r\n      const message = `Rate limit exceeded for widget ${widgetId}. Retry after ${Math.ceil(retryAfter / 1000)}s`;\r\n      if (this.logger) {\r\n        this.logger.warn(message);\r\n      } else {\r\n        console.warn(`[TrestaWidget] ${message}`);\r\n      }\r\n      throw new WidgetError(\r\n        WidgetErrorCode.RATE_LIMITED,\r\n        `Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 1000)} seconds.`,\r\n        true\r\n      );\r\n    }\r\n\r\n    // Fetch with retry logic\r\n    return retry(\r\n      async () => {\r\n        const url = `${this.config.baseURL}/api/widgets/${widgetId}/public`;\r\n\r\n        if (this.logger) {\r\n          this.logger.debug(`Fetching widget data from: ${url}`);\r\n          this.logger.debug(`Using API key: ${this.apiKey?.substring(0, 15)}...`);\r\n        }\r\n\r\n        try {\r\n          const response = await this.networkClient.request<any>(url, {\r\n            method: 'GET',\r\n            timeout: this.config.timeout,\r\n            headers: {\r\n              'Authorization': `Bearer ${this.apiKey}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n          });\r\n\r\n          if (this.logger) {\r\n            this.logger.debug('Received response:', response.status);\r\n          }\r\n\r\n          // Handle HTTP status codes and transform response\r\n          const rawData = this.handleResponse(response, widgetId);\r\n\r\n          // Transform the API response to match WidgetData interface\r\n          return this.transformApiResponse(rawData);\r\n        } catch (error) {\r\n          // Re-throw WidgetErrors as-is\r\n          if (error instanceof WidgetError) {\r\n            throw error;\r\n          }\r\n\r\n          // Wrap unknown errors\r\n          const errorMessage = `Unexpected error for widget ${widgetId}:`;\r\n          if (this.logger) {\r\n            this.logger.error(errorMessage, error);\r\n          } else {\r\n            console.error(`[TrestaWidget] ${errorMessage}`, error);\r\n          }\r\n          throw new WidgetError(\r\n            WidgetErrorCode.API_ERROR,\r\n            'An unexpected error occurred while fetching widget data',\r\n            true\r\n          );\r\n        }\r\n      },\r\n      { maxRetries: this.config.maxRetries }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Transform API response to WidgetData format\r\n   */\r\n  private transformApiResponse(apiResponse: any): WidgetData {\r\n    if (this.logger) {\r\n      this.logger.debug('Raw API response:', apiResponse);\r\n    }\r\n    \r\n    // Handle both direct data and wrapped response formats\r\n    const data = apiResponse.data || apiResponse;\r\n\r\n    if (!data || !data.widget) {\r\n      const errorDetails = { hasData: !!data, hasWidget: !!(data?.widget) };\r\n      if (this.logger) {\r\n        this.logger.error('Invalid API response structure:', errorDetails);\r\n      } else {\r\n        console.error('[TrestaWidget] Invalid API response structure:', errorDetails);\r\n      }\r\n      throw new WidgetError(\r\n        WidgetErrorCode.PARSE_ERROR,\r\n        'Invalid API response format',\r\n        false\r\n      );\r\n    }\r\n\r\n    if (this.logger) {\r\n      this.logger.debug('Transforming widget data:', {\r\n        widgetId: data.widget.id,\r\n        testimonialCount: data.testimonials?.length || 0,\r\n      });\r\n    }\r\n\r\n    const settings = data.widget.settings ?? {};\r\n    const layoutType = data.widget.layout || 'grid';\r\n    const maxTestimonials = settings.maxTestimonials ?? DEFAULT_MAX_TESTIMONIALS;\r\n    const autoRotate = layoutType === 'carousel' ? settings.autoRotate ?? false : false;\r\n    const rotateInterval = settings.rotateInterval ?? DEFAULT_ROTATE_INTERVAL;\r\n    const showNavigation = layoutType === 'carousel' ? settings.showNavigation ?? true : false;\r\n    const columns = settings.columns ?? (layoutType === 'grid' ? 3 : 1);\r\n\r\n    // Transform to WidgetData format\r\n    return {\r\n      widgetId: data.widget.id,\r\n      config: {\r\n        layout: {\r\n          type: layoutType,\r\n          maxTestimonials,\r\n          autoRotate,\r\n          rotateInterval,\r\n          showNavigation,\r\n          columns,\r\n        },\r\n        theme: {\r\n          mode: settings.theme || DEFAULT_THEME_MODE,\r\n          primaryColor: data.widget.theme?.primaryColor || DEFAULT_PRIMARY_COLOR,\r\n          secondaryColor: data.widget.theme?.secondaryColor || DEFAULT_SECONDARY_COLOR,\r\n          fontFamily: settings.fontFamily,\r\n          cardStyle: settings.cardStyle || 'default',\r\n        },\r\n        display: {\r\n          showRating: settings.showRating ?? true,\r\n          showDate: settings.showDate ?? true,\r\n          showAvatar: settings.showAvatar ?? true,\r\n          showAuthorRole: settings.showAuthorRole ?? true,\r\n          showAuthorCompany: settings.showAuthorCompany ?? true,\r\n          maxTestimonials,\r\n        },\r\n      },\r\n      testimonials: (data.testimonials || []).map((t: any) => ({\r\n        id: t.id,\r\n        content: t.content,\r\n        rating: t.rating,\r\n        createdAt: t.createdAt,\r\n        isPublished: true,\r\n        isApproved: true,\r\n        isOAuthVerified: t.isOAuthVerified || false,\r\n        oauthProvider: t.oauthProvider,\r\n        author: {\r\n          name: t.authorName,\r\n          email: undefined, // Never expose email\r\n          avatar: t.authorAvatar,\r\n          role: t.authorRole,\r\n          company: t.authorCompany,\r\n        },\r\n        media: t.videoUrl ? {\r\n          type: 'video' as const,\r\n          url: t.videoUrl,\r\n        } : undefined,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle API response based on status code\r\n   */\r\n  private handleResponse<T>(\r\n    response: { data: T; status: number; headers: Headers },\r\n    widgetId: string\r\n  ): T {\r\n    const { data, status, headers } = response;\r\n\r\n    // Success responses (2xx)\r\n    if (status >= 200 && status < 300) {\r\n      return data;\r\n    }\r\n\r\n    // Handle specific error status codes\r\n    switch (status) {\r\n      case 401:\r\n      case 403: {\r\n        const message = `Unauthorized access for widget ${widgetId} (${status})`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.UNAUTHORIZED,\r\n          'Unable to load testimonials. Please check your widget configuration.',\r\n          false // Not recoverable\r\n        );\r\n      }\r\n\r\n      case 404: {\r\n        const message = `Widget ${widgetId} not found (404)`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.INVALID_WIDGET_ID,\r\n          'Widget not found. Please check your widget ID.',\r\n          false // Not recoverable\r\n        );\r\n      }\r\n\r\n      case 429: {\r\n        // Rate limited by server\r\n        const retryAfterHeader = headers.get('Retry-After');\r\n        const retryAfter = retryAfterHeader\r\n          ? parseInt(retryAfterHeader, 10) * 1000\r\n          : 60000; // Default to 60 seconds\r\n\r\n        const message = `Server rate limit for widget ${widgetId}. Retry after ${retryAfter / 1000}s`;\r\n        if (this.logger) {\r\n          this.logger.warn(message);\r\n        } else {\r\n          console.warn(`[TrestaWidget] ${message}`);\r\n        }\r\n\r\n        throw new WidgetError(\r\n          WidgetErrorCode.RATE_LIMITED,\r\n          `Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 1000)} seconds.`,\r\n          true // Recoverable with retry\r\n        );\r\n      }\r\n\r\n      case 500:\r\n      case 502:\r\n      case 503:\r\n      case 504: {\r\n        const message = `Server error for widget ${widgetId} (${status})`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.API_ERROR,\r\n          'Server error. Please try again later.',\r\n          true // Recoverable with retry\r\n        );\r\n      }\r\n\r\n      default: {\r\n        const message = `Unexpected status code ${status} for widget ${widgetId}`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.API_ERROR,\r\n          `Unexpected error (${status}). Please try again later.`,\r\n          status >= 500 // 5xx errors are recoverable\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the network client (for testing/advanced usage)\r\n   */\r\n  getNetworkClient(): NetworkClient {\r\n    return this.networkClient;\r\n  }\r\n\r\n  /**\r\n   * Get the rate limiter (for testing/advanced usage)\r\n   */\r\n  getRateLimiter(): RateLimiter {\r\n    return this.rateLimiter;\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  updateConfig(config: Partial<APIClientConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): APIClientConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * IndexedDB storage adapter\r\n */\r\n\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\n\r\nconst DB_NAME = 'tresta-widget-cache';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'testimonials';\r\n\r\nexport class IndexedDBAdapter implements StorageAdapter {\r\n  private dbPromise: Promise<IDBDatabase> | null = null;\r\n  private available: boolean | null = null;\r\n\r\n  /**\r\n   * Check if IndexedDB is available (handles private browsing mode)\r\n   */\r\n  async isAvailable(): Promise<boolean> {\r\n    if (this.available !== null) {\r\n      return this.available;\r\n    }\r\n\r\n    try {\r\n      // Immediate detection of IndexedDB unavailability\r\n      if (!('indexedDB' in window)) {\r\n        this.available = false;\r\n        return false;\r\n      }\r\n\r\n      // Test if we can actually open a database (private browsing check)\r\n      const testDB = await new Promise<IDBDatabase>((resolve, reject) => {\r\n        const request = indexedDB.open('__test__', 1);\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve(request.result);\r\n        request.onupgradeneeded = () => {\r\n          // Create a test store\r\n          request.result.createObjectStore('test');\r\n        };\r\n      });\r\n\r\n      testDB.close();\r\n      indexedDB.deleteDatabase('__test__');\r\n      \r\n      this.available = true;\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('[TrestaWidget] IndexedDB unavailable, will use localStorage fallback:', error);\r\n      this.available = false;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or create the database connection\r\n   */\r\n  private async getDB(): Promise<IDBDatabase> {\r\n    if (this.dbPromise) {\r\n      return this.dbPromise;\r\n    }\r\n\r\n    this.dbPromise = new Promise((resolve, reject) => {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n      request.onerror = () => {\r\n        reject(new Error(`Failed to open IndexedDB: ${request.error}`));\r\n      };\r\n\r\n      request.onsuccess = () => {\r\n        resolve(request.result);\r\n      };\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        const db = (event.target as IDBOpenDBRequest).result;\r\n        \r\n        // Create object store if it doesn't exist\r\n        if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n          const store = db.createObjectStore(STORE_NAME, { keyPath: 'widgetId' });\r\n          // Create index on expiresAt for efficient cleanup\r\n          store.createIndex('expiresAt', 'expiresAt', { unique: false });\r\n        }\r\n      };\r\n    });\r\n\r\n    return this.dbPromise;\r\n  }\r\n\r\n  /**\r\n   * Get a cache entry by key\r\n   */\r\n  async get(key: string): Promise<CacheEntry | null> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readonly');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.get(key);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => {\r\n          const entry = request.result as CacheEntry | undefined;\r\n          \r\n          // Check if entry is expired\r\n          if (entry && entry.expiresAt < Date.now()) {\r\n            // Delete expired entry asynchronously\r\n            this.delete(key).catch(() => {\r\n              // Ignore deletion errors\r\n            });\r\n            resolve(null);\r\n          } else {\r\n            resolve(entry || null);\r\n          }\r\n        };\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a cache entry\r\n   */\r\n  async set(_key: string, value: CacheEntry): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.put(value);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB set error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a cache entry\r\n   */\r\n  async delete(key: string): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.delete(key);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB delete error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cache entries\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.clear();\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB clear error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      const now = Date.now();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const index = store.index('expiresAt');\r\n        \r\n        // Get all entries with expiresAt < now\r\n        const range = IDBKeyRange.upperBound(now);\r\n        const request = index.openCursor(range);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = (event) => {\r\n          const cursor = (event.target as IDBRequest<IDBCursorWithValue>).result;\r\n          if (cursor) {\r\n            cursor.delete();\r\n            cursor.continue();\r\n          } else {\r\n            resolve();\r\n          }\r\n        };\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * localStorage storage adapter (fallback)\r\n */\r\n\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\n\r\nconst STORAGE_PREFIX = 'tresta-widget-';\r\n\r\nexport class LocalStorageAdapter implements StorageAdapter {\r\n  private available: boolean | null = null;\r\n\r\n  /**\r\n   * Check if localStorage is available\r\n   */\r\n  async isAvailable(): Promise<boolean> {\r\n    if (this.available !== null) {\r\n      return this.available;\r\n    }\r\n\r\n    try {\r\n      const testKey = '__tresta_test__';\r\n      localStorage.setItem(testKey, 'test');\r\n      localStorage.removeItem(testKey);\r\n      this.available = true;\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('[TrestaWidget] localStorage unavailable:', error);\r\n      this.available = false;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a cache entry by key\r\n   */\r\n  async get(key: string): Promise<CacheEntry | null> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      const item = localStorage.getItem(storageKey);\r\n      \r\n      if (!item) {\r\n        return null;\r\n      }\r\n\r\n      const entry = JSON.parse(item) as CacheEntry;\r\n      \r\n      // Check if entry is expired\r\n      if (entry.expiresAt < Date.now()) {\r\n        // Delete expired entry\r\n        await this.delete(key);\r\n        return null;\r\n      }\r\n\r\n      return entry;\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a cache entry\r\n   */\r\n  async set(key: string, value: CacheEntry): Promise<void> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      const serialized = JSON.stringify(value);\r\n      localStorage.setItem(storageKey, serialized);\r\n    } catch (error) {\r\n      // Handle quota exceeded error\r\n      if (error instanceof DOMException && \r\n          (error.name === 'QuotaExceededError' || error.name === 'NS_ERROR_DOM_QUOTA_REACHED')) {\r\n        console.warn('[TrestaWidget] localStorage quota exceeded, clearing old entries');\r\n        await this.clearExpired();\r\n        \r\n        // Try again after cleanup\r\n        try {\r\n          const storageKey = STORAGE_PREFIX + key;\r\n          const serialized = JSON.stringify(value);\r\n          localStorage.setItem(storageKey, serialized);\r\n        } catch (retryError) {\r\n          console.error('[TrestaWidget] localStorage set error after cleanup:', retryError);\r\n          throw retryError;\r\n        }\r\n      } else {\r\n        console.error('[TrestaWidget] localStorage set error:', error);\r\n        throw error;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a cache entry\r\n   */\r\n  async delete(key: string): Promise<void> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      localStorage.removeItem(storageKey);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage delete error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cache entries\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const keysToRemove: string[] = [];\r\n      \r\n      // Find all keys with our prefix\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith(STORAGE_PREFIX)) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n\r\n      // Remove all matching keys\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage clear error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const now = Date.now();\r\n      const keysToRemove: string[] = [];\r\n      \r\n      // Find all expired entries\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith(STORAGE_PREFIX)) {\r\n          try {\r\n            const item = localStorage.getItem(key);\r\n            if (item) {\r\n              const entry = JSON.parse(item) as CacheEntry;\r\n              if (entry.expiresAt < now) {\r\n                keysToRemove.push(key);\r\n              }\r\n            }\r\n          } catch (parseError) {\r\n            // If we can't parse it, remove it\r\n            keysToRemove.push(key);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Remove expired keys\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Cache manager with IndexedDB and localStorage fallback\r\n */\r\n\r\nimport type { WidgetData } from '../types';\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\nimport { IndexedDBAdapter } from './indexeddb';\r\nimport { LocalStorageAdapter } from './localstorage';\r\n\r\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000; // 24 hours\r\nconst LOCALSTORAGE_TTL = 60 * 60 * 1000; // 1 hour (reduced for localStorage)\r\n\r\nexport class StorageManager {\r\n  private adapter: StorageAdapter | null = null;\r\n  private initPromise: Promise<void> | null = null;\r\n\r\n  /**\r\n   * Initialize the storage adapter\r\n   */\r\n  private async init(): Promise<void> {\r\n    if (this.initPromise) {\r\n      return this.initPromise;\r\n    }\r\n\r\n    this.initPromise = (async () => {\r\n      // Try IndexedDB first\r\n      const indexedDBAdapter = new IndexedDBAdapter();\r\n      if (await indexedDBAdapter.isAvailable()) {\r\n        this.adapter = indexedDBAdapter;\r\n        console.log('[TrestaWidget] Using IndexedDB for caching');\r\n        \r\n        // Clear expired entries on initialization (don't await to avoid blocking)\r\n        this.clearExpired().catch(() => {\r\n          // Ignore cleanup errors\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Fall back to localStorage\r\n      const localStorageAdapter = new LocalStorageAdapter();\r\n      if (await localStorageAdapter.isAvailable()) {\r\n        this.adapter = localStorageAdapter;\r\n        console.log('[TrestaWidget] Using localStorage for caching (IndexedDB unavailable)');\r\n        \r\n        // Clear expired entries on initialization (don't await to avoid blocking)\r\n        this.clearExpired().catch(() => {\r\n          // Ignore cleanup errors\r\n        });\r\n        return;\r\n      }\r\n\r\n      // No storage available\r\n      console.warn('[TrestaWidget] No storage available, caching disabled');\r\n      this.adapter = null;\r\n    })();\r\n\r\n    return this.initPromise;\r\n  }\r\n\r\n  /**\r\n   * Get the current adapter\r\n   */\r\n  private async getAdapter(): Promise<StorageAdapter | null> {\r\n    await this.init();\r\n    return this.adapter;\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for a widget ID\r\n   */\r\n  private getCacheKey(widgetId: string): string {\r\n    return `tresta-widget-${widgetId}`;\r\n  }\r\n\r\n  /**\r\n   * Get TTL based on adapter type\r\n   */\r\n  private getTTL(): number {\r\n    if (this.adapter instanceof IndexedDBAdapter) {\r\n      return DEFAULT_TTL;\r\n    } else if (this.adapter instanceof LocalStorageAdapter) {\r\n      return LOCALSTORAGE_TTL;\r\n    }\r\n    return DEFAULT_TTL;\r\n  }\r\n\r\n  /**\r\n   * Get cached widget data\r\n   */\r\n  async get(widgetId: string): Promise<WidgetData | null> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return null;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      const entry = await adapter.get(key);\r\n      \r\n      if (!entry) {\r\n        return null;\r\n      }\r\n\r\n      return entry.data;\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set cached widget data\r\n   */\r\n  async set(widgetId: string, data: WidgetData, ttl?: number): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      const now = Date.now();\r\n      const effectiveTTL = ttl ?? this.getTTL();\r\n\r\n      const entry: CacheEntry = {\r\n        widgetId,\r\n        data,\r\n        timestamp: now,\r\n        expiresAt: now + effectiveTTL,\r\n      };\r\n\r\n      await adapter.set(key, entry);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache set error:', error);\r\n      // Don't throw - caching is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete cached widget data\r\n   */\r\n  async delete(widgetId: string): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      await adapter.delete(key);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache delete error:', error);\r\n      // Don't throw - deletion is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cached data\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      await adapter.clear();\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache clear error:', error);\r\n      // Don't throw - clearing is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      if ('clearExpired' in adapter && typeof adapter.clearExpired === 'function') {\r\n        await adapter.clearExpired();\r\n      }\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Error and Empty State Components\r\n * Provides user-friendly UI for error and empty states with ARIA support\r\n */\r\n\r\nexport interface ErrorStateConfig {\r\n  message?: string;\r\n  type: 'error' | 'empty';\r\n  widgetId?: string;\r\n  version?: string;\r\n}\r\n\r\n/**\r\n * Create an error state component\r\n */\r\nexport function createErrorState(config: ErrorStateConfig): HTMLElement {\r\n  const container = document.createElement('div');\r\n  container.className = `tresta-widget-${config.type}-state`;\r\n  \r\n  // Use 'alert' role for errors (assertive) and 'status' for empty state (polite)\r\n  if (config.type === 'error') {\r\n    container.setAttribute('role', 'alert');\r\n    container.setAttribute('aria-live', 'assertive');\r\n  } else {\r\n    container.setAttribute('role', 'status');\r\n    container.setAttribute('aria-live', 'polite');\r\n  }\r\n  \r\n  container.setAttribute('aria-atomic', 'true');\r\n\r\n  const message = document.createElement('p');\r\n  message.className = 'tresta-widget-state-message';\r\n  \r\n  // Use custom message or default based on type\r\n  if (config.message) {\r\n    message.textContent = config.message;\r\n  } else if (config.type === 'error') {\r\n    message.textContent = 'Unable to load testimonials. Please try again later.';\r\n  } else {\r\n    message.textContent = 'No testimonials yet';\r\n  }\r\n\r\n  container.appendChild(message);\r\n\r\n  return container;\r\n}\r\n\r\n/**\r\n * Create an empty state component\r\n */\r\nexport function createEmptyState(message?: string): HTMLElement {\r\n  return createErrorState({\r\n    type: 'empty',\r\n    ...(message && { message }),\r\n  });\r\n}\r\n","/**\r\n * Sampling logic for telemetry\r\n */\r\n\r\nexport class TelemetrySampler {\r\n  private samplingRate: number;\r\n\r\n  constructor(samplingRate: number = 0.01) {\r\n    // Default to 1% sampling\r\n    this.samplingRate = Math.max(0, Math.min(1, samplingRate));\r\n  }\r\n\r\n  /**\r\n   * Determine if this event should be sampled\r\n   */\r\n  shouldSample(): boolean {\r\n    return Math.random() < this.samplingRate;\r\n  }\r\n\r\n  /**\r\n   * Update the sampling rate\r\n   */\r\n  setSamplingRate(rate: number): void {\r\n    this.samplingRate = Math.max(0, Math.min(1, rate));\r\n  }\r\n\r\n  /**\r\n   * Get the current sampling rate\r\n   */\r\n  getSamplingRate(): number {\r\n    return this.samplingRate;\r\n  }\r\n}\r\n","/**\r\n * Telemetry tracker - collects anonymous usage and performance metrics\r\n * \r\n * Privacy-first design:\r\n * - No PII collected\r\n * - Respects DNT (Do Not Track)\r\n * - 1% sampling by default\r\n * - Opt-out via data-telemetry=\"false\"\r\n */\r\n\r\nimport type { TelemetryEvent, TelemetryConfig, TelemetryData } from './types';\r\nimport { TelemetrySampler } from './sampler';\r\n\r\nexport class TelemetryTracker {\r\n  private config: TelemetryConfig;\r\n  private sampler: TelemetrySampler;\r\n  private errorCounts: Map<string, number> = new Map();\r\n  private loadStartTime: number = 0;\r\n  private widgetId: string;\r\n  private version: string;\r\n  private layoutType?: string;\r\n\r\n  constructor(\r\n    widgetId: string,\r\n    version: string,\r\n    config: Partial<TelemetryConfig> = {}\r\n  ) {\r\n    this.widgetId = widgetId;\r\n    this.version = version;\r\n\r\n    // Check if telemetry is disabled\r\n    const telemetryDisabled = config.enabled === false;\r\n    const dntEnabled = this.isDNTEnabled();\r\n\r\n    this.config = {\r\n      enabled: !telemetryDisabled && !dntEnabled,\r\n      samplingRate: config.samplingRate ?? 0.01, // Default 1%\r\n      endpoint: config.endpoint ?? 'https://api.tresta.com/telemetry',\r\n    };\r\n\r\n    this.sampler = new TelemetrySampler(this.config.samplingRate);\r\n  }\r\n\r\n  /**\r\n   * Check if Do Not Track is enabled\r\n   */\r\n  private isDNTEnabled(): boolean {\r\n    // Check navigator.doNotTrack\r\n    if (typeof navigator !== 'undefined') {\r\n      const dnt = (navigator as any).doNotTrack || (window as any).doNotTrack || (navigator as any).msDoNotTrack;\r\n      \r\n      // DNT can be \"1\", \"yes\", or true\r\n      if (dnt === '1' || dnt === 'yes' || dnt === true) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Start tracking widget load time\r\n   */\r\n  startLoadTracking(): void {\r\n    if (!this.config.enabled) return;\r\n    this.loadStartTime = performance.now();\r\n  }\r\n\r\n  /**\r\n   * Track successful widget load\r\n   */\r\n  trackLoad(layoutType?: string): void {\r\n    if (!this.config.enabled) return;\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    this.layoutType = layoutType || 'unknown';\r\n    const loadTime = this.loadStartTime > 0 ? performance.now() - this.loadStartTime : 0;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'load',\r\n      loadTime: Math.round(loadTime),\r\n      layoutType: layoutType || 'unknown',\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Track an error\r\n   */\r\n  trackError(errorCode: string): void {\r\n    if (!this.config.enabled) return;\r\n\r\n    // Always track error counts locally (not sampled)\r\n    const currentCount = this.errorCounts.get(errorCode) || 0;\r\n    this.errorCounts.set(errorCode, currentCount + 1);\r\n\r\n    // Only send error events if sampled\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'error',\r\n      errorCode,\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Track an interaction\r\n   */\r\n  trackInteraction(layoutType?: string): void {\r\n    if (!this.config.enabled) return;\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'interaction',\r\n      layoutType: layoutType || this.layoutType || 'unknown',\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Get telemetry data summary (for debugging)\r\n   */\r\n  getTelemetryData(): TelemetryData {\r\n    const loadTime = this.loadStartTime > 0 ? performance.now() - this.loadStartTime : 0;\r\n    \r\n    const errorCounts: Record<string, number> = {};\r\n    this.errorCounts.forEach((count, code) => {\r\n      errorCounts[code] = count;\r\n    });\r\n\r\n    return {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      loadTime: Math.round(loadTime),\r\n      layoutType: this.layoutType || 'unknown',\r\n      errorCounts,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Send telemetry event to server (non-blocking)\r\n   */\r\n  private send(event: TelemetryEvent): void {\r\n    if (!this.config.enabled || !this.config.endpoint) return;\r\n\r\n    // Use sendBeacon if available (non-blocking, survives page unload)\r\n    if (typeof navigator !== 'undefined' && navigator.sendBeacon) {\r\n      try {\r\n        const blob = new Blob([JSON.stringify(event)], { type: 'application/json' });\r\n        navigator.sendBeacon(this.config.endpoint, blob);\r\n      } catch (error) {\r\n        // Silently fail - telemetry should never break the widget\r\n        console.debug('[TrestaWidget] Telemetry sendBeacon failed:', error);\r\n      }\r\n    } else {\r\n      // Fallback to fetch with keepalive\r\n      try {\r\n        fetch(this.config.endpoint, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify(event),\r\n          keepalive: true,\r\n          // No credentials - this is anonymous telemetry\r\n          credentials: 'omit',\r\n        }).catch(() => {\r\n          // Silently fail - telemetry should never break the widget\r\n        });\r\n      } catch (error) {\r\n        // Silently fail - telemetry should never break the widget\r\n        console.debug('[TrestaWidget] Telemetry fetch failed:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if telemetry is enabled\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.config.enabled;\r\n  }\r\n\r\n  /**\r\n   * Update sampling rate (for per-account settings)\r\n   */\r\n  setSamplingRate(rate: number): void {\r\n    this.config.samplingRate = rate;\r\n    this.sampler.setSamplingRate(rate);\r\n  }\r\n\r\n  /**\r\n   * Disable telemetry\r\n   */\r\n  disable(): void {\r\n    this.config.enabled = false;\r\n  }\r\n\r\n  /**\r\n   * Enable telemetry (respects DNT)\r\n   */\r\n  enable(): void {\r\n    if (!this.isDNTEnabled()) {\r\n      this.config.enabled = true;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * TestimonialCard Component\r\n * \r\n * Renders a single testimonial card with configurable display options.\r\n * Supports star ratings, OAuth verification badges, lazy-loaded avatars,\r\n * and date formatting.\r\n */\r\n\r\nimport type { Testimonial, DisplayOptions, ThemeConfig } from '../types';\r\n\r\nexport interface TestimonialCardConfig {\r\n  testimonial: Testimonial;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class TestimonialCard {\r\n  private testimonial: Testimonial;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: TestimonialCardConfig) {\r\n    this.testimonial = config.testimonial;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the testimonial card as an HTML element\r\n   */\r\n  render(): HTMLElement {\r\n    const card = document.createElement('article');\r\n    card.className = 'tresta-testimonial-card';\r\n    card.setAttribute('data-testimonial-id', this.testimonial.id);\r\n    card.style.setProperty('--primary-color', this.theme.primaryColor);\r\n    card.style.setProperty('--secondary-color', this.theme.secondaryColor);\r\n\r\n    // Apply card style class\r\n    card.classList.add(`card-style-${this.theme.cardStyle}`);\r\n\r\n    // Build card content\r\n    const content: string[] = [];\r\n\r\n    // Header section (avatar, name, role, company, verification)\r\n    content.push(this.renderHeader());\r\n\r\n    // Rating section\r\n    if (this.displayOptions.showRating && this.testimonial.rating > 0) {\r\n      content.push(this.renderRating());\r\n    }\r\n\r\n    // Testimonial content\r\n    content.push(this.renderContent());\r\n\r\n    // Date section\r\n    if (this.displayOptions.showDate) {\r\n      content.push(this.renderDate());\r\n    }\r\n\r\n    card.innerHTML = content.join('');\r\n\r\n    return card;\r\n  }\r\n\r\n  /**\r\n   * Renders the card header with avatar, author info, and verification badge\r\n   */\r\n  private renderHeader(): string {\r\n    const parts: string[] = ['<div class=\"tresta-card-header\">'];\r\n\r\n    // Avatar\r\n    if (this.displayOptions.showAvatar && this.testimonial.author.avatar) {\r\n      parts.push(this.renderAvatar());\r\n    }\r\n\r\n    // Author info container\r\n    parts.push('<div class=\"tresta-author-info\">');\r\n\r\n    // Author name with verification badge\r\n    parts.push('<div class=\"tresta-author-name-row\">');\r\n    parts.push(`<span class=\"tresta-author-name\">${this.escapeHtml(this.testimonial.author.name)}</span>`);\r\n    \r\n    if (this.testimonial.isOAuthVerified && this.testimonial.oauthProvider) {\r\n      parts.push(this.renderVerificationBadge());\r\n    }\r\n    \r\n    parts.push('</div>');\r\n\r\n    // Author role\r\n    if (this.displayOptions.showAuthorRole && this.testimonial.author.role) {\r\n      parts.push(`<div class=\"tresta-author-role\">${this.escapeHtml(this.testimonial.author.role)}</div>`);\r\n    }\r\n\r\n    // Author company\r\n    if (this.displayOptions.showAuthorCompany && this.testimonial.author.company) {\r\n      parts.push(`<div class=\"tresta-author-company\">${this.escapeHtml(this.testimonial.author.company)}</div>`);\r\n    }\r\n\r\n    parts.push('</div>'); // Close author-info\r\n    parts.push('</div>'); // Close header\r\n\r\n    return parts.join('');\r\n  }\r\n\r\n  /**\r\n   * Renders the avatar image with lazy loading\r\n   */\r\n  private renderAvatar(): string {\r\n    const avatarUrl = this.testimonial.author.avatar!;\r\n    const authorName = this.escapeHtml(this.testimonial.author.name);\r\n    \r\n    return `\r\n      <div class=\"tresta-avatar-container\">\r\n        <img \r\n          class=\"tresta-avatar\" \r\n          src=\"${this.escapeHtml(avatarUrl)}\" \r\n          alt=\"${authorName}\"\r\n          loading=\"lazy\"\r\n        />\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the OAuth verification badge\r\n   */\r\n  private renderVerificationBadge(): string {\r\n    const provider = this.escapeHtml(this.testimonial.oauthProvider!);\r\n    \r\n    return `\r\n      <span \r\n        class=\"tresta-verification-badge\" \r\n        role=\"img\" \r\n        aria-label=\"Verified via ${provider}\"\r\n        title=\"Verified via ${provider}\"\r\n      >\r\n        <svg \r\n          class=\"tresta-verification-icon\" \r\n          width=\"16\" \r\n          height=\"16\" \r\n          viewBox=\"0 0 16 16\" \r\n          fill=\"none\" \r\n          xmlns=\"http://www.w3.org/2000/svg\"\r\n          aria-hidden=\"true\"\r\n          focusable=\"false\"\r\n        >\r\n          <circle cx=\"8\" cy=\"8\" r=\"8\" fill=\"currentColor\"/>\r\n          <path \r\n            d=\"M11.5 5.5L6.5 10.5L4 8\" \r\n            stroke=\"white\" \r\n            stroke-width=\"2\" \r\n            stroke-linecap=\"round\" \r\n            stroke-linejoin=\"round\"\r\n          />\r\n        </svg>\r\n      </span>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the star rating with ARIA labels\r\n   */\r\n  private renderRating(): string {\r\n    const rating = Math.max(0, Math.min(5, this.testimonial.rating));\r\n    const fullStars = Math.floor(rating);\r\n    const hasHalfStar = rating % 1 >= 0.5;\r\n    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);\r\n\r\n    const stars: string[] = [];\r\n\r\n    // Full stars\r\n    for (let i = 0; i < fullStars; i++) {\r\n      stars.push(this.renderStar('full'));\r\n    }\r\n\r\n    // Half star\r\n    if (hasHalfStar) {\r\n      stars.push(this.renderStar('half'));\r\n    }\r\n\r\n    // Empty stars\r\n    for (let i = 0; i < emptyStars; i++) {\r\n      stars.push(this.renderStar('empty'));\r\n    }\r\n\r\n    return `\r\n      <div class=\"tresta-rating\" role=\"img\" aria-label=\"${rating} out of 5 stars\">\r\n        ${stars.join('')}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders a single star icon\r\n   */\r\n  private renderStar(type: 'full' | 'half' | 'empty'): string {\r\n    const fillClass = `tresta-star-${type}`;\r\n    \r\n    if (type === 'half') {\r\n      return `\r\n        <svg class=\"tresta-star ${fillClass}\" width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n          <defs>\r\n            <linearGradient id=\"half-fill-${this.testimonial.id}\">\r\n              <stop offset=\"50%\" stop-color=\"currentColor\"/>\r\n              <stop offset=\"50%\" stop-color=\"transparent\"/>\r\n            </linearGradient>\r\n          </defs>\r\n          <path \r\n            d=\"M10 1L12.5 7.5L19 8.5L14.5 13L15.5 19L10 16L4.5 19L5.5 13L1 8.5L7.5 7.5L10 1Z\" \r\n            fill=\"url(#half-fill-${this.testimonial.id})\"\r\n            stroke=\"currentColor\"\r\n            stroke-width=\"1\"\r\n          />\r\n        </svg>\r\n      `;\r\n    }\r\n\r\n    return `\r\n      <svg class=\"tresta-star ${fillClass}\" width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path \r\n          d=\"M10 1L12.5 7.5L19 8.5L14.5 13L15.5 19L10 16L4.5 19L5.5 13L1 8.5L7.5 7.5L10 1Z\" \r\n          fill=\"${type === 'full' ? 'currentColor' : 'transparent'}\"\r\n          stroke=\"currentColor\"\r\n          stroke-width=\"1\"\r\n        />\r\n      </svg>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the testimonial content\r\n   */\r\n  private renderContent(): string {\r\n    return `\r\n      <div class=\"tresta-testimonial-content\">\r\n        ${this.escapeHtml(this.testimonial.content)}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the formatted date\r\n   */\r\n  private renderDate(): string {\r\n    const formattedDate = this.formatDate(this.testimonial.createdAt);\r\n    \r\n    return `\r\n      <div class=\"tresta-testimonial-date\">\r\n        <time datetime=\"${this.testimonial.createdAt}\">${formattedDate}</time>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Formats a date string into a human-readable format\r\n   */\r\n  private formatDate(dateString: string): string {\r\n    try {\r\n      const date = new Date(dateString);\r\n      \r\n      // Check if date is valid\r\n      if (isNaN(date.getTime())) {\r\n        return dateString;\r\n      }\r\n\r\n      // Format as \"Month Day, Year\" (e.g., \"November 17, 2025\")\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        year: 'numeric',\r\n        month: 'long',\r\n        day: 'numeric'\r\n      };\r\n\r\n      return date.toLocaleDateString('en-US', options);\r\n    } catch (error) {\r\n      // Fallback to original string if formatting fails\r\n      return dateString;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Escapes HTML to prevent XSS\r\n   * Note: This is a basic escape for text content. \r\n   * Full HTML sanitization is handled by the ContentSanitizer for rich content.\r\n   */\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n","/**\r\n * Carousel Layout\r\n * \r\n * Auto-rotating slider with navigation controls, touch gestures, and keyboard support.\r\n * Implements Requirements: 3.1, 6.1, 6.2, 6.3, 6.4, 6.5, 7.3, 7.4\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface CarouselConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Carousel {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n  private container: HTMLElement | null = null;\r\n  private currentIndex: number = 0;\r\n  private autoRotateTimer: number | null = null;\r\n  private isPaused: boolean = false;\r\n  private touchStartX: number = 0;\r\n  private touchEndX: number = 0;\r\n  private isTransitioning: boolean = false;\r\n\r\n  constructor(config: CarouselConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the carousel layout\r\n   */\r\n  render(): HTMLElement {\r\n    const carousel = document.createElement('div');\r\n    carousel.className = 'tresta-carousel';\r\n    carousel.setAttribute('role', 'region');\r\n    carousel.setAttribute('aria-label', 'Customer testimonials');\r\n    carousel.setAttribute('aria-roledescription', 'carousel');\r\n    carousel.setAttribute('aria-live', 'polite');\r\n    carousel.setAttribute('aria-atomic', 'false');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      carousel.appendChild(emptyState);\r\n      return carousel;\r\n    }\r\n\r\n    // Create carousel structure\r\n    const track = document.createElement('div');\r\n    track.className = 'tresta-carousel-track';\r\n\r\n    // Render testimonial slides\r\n    this.testimonials.forEach((testimonial, index) => {\r\n      const slide = this.renderSlide(testimonial, index);\r\n      track.appendChild(slide);\r\n    });\r\n\r\n    carousel.appendChild(track);\r\n    \r\n    // Add keyboard navigation instructions for screen readers\r\n    const instructions = document.createElement('div');\r\n    instructions.className = 'tresta-sr-only';\r\n    instructions.textContent = 'Use arrow keys to navigate between testimonials, or tab to navigation buttons';\r\n    carousel.appendChild(instructions);\r\n\r\n    // Add navigation buttons if enabled\r\n    if (this.layoutConfig.showNavigation !== false) {\r\n      carousel.appendChild(this.renderNavigationButtons());\r\n    }\r\n\r\n    // Add dot indicators\r\n    carousel.appendChild(this.renderDotIndicators());\r\n\r\n    this.container = carousel;\r\n\r\n    // Set up event listeners\r\n    this.setupEventListeners();\r\n\r\n    // Start auto-rotation if enabled\r\n    if (this.layoutConfig.autoRotate !== false) {\r\n      this.startAutoRotate();\r\n    }\r\n\r\n    // Show first slide\r\n    this.updateSlidePosition(false);\r\n\r\n    return carousel;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial slide\r\n   */\r\n  private renderSlide(testimonial: Testimonial, index: number): HTMLElement {\r\n    const slide = document.createElement('div');\r\n    slide.className = 'tresta-carousel-slide';\r\n    slide.id = `testimonial-slide-${index}`;\r\n    slide.setAttribute('role', 'tabpanel');\r\n    slide.setAttribute('aria-roledescription', 'slide');\r\n    slide.setAttribute('aria-label', `Testimonial ${index + 1} of ${this.testimonials.length}`);\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    slide.appendChild(card.render());\r\n\r\n    return slide;\r\n  }\r\n\r\n  /**\r\n   * Renders navigation buttons (previous/next)\r\n   */\r\n  private renderNavigationButtons(): HTMLElement {\r\n    const nav = document.createElement('div');\r\n    nav.className = 'tresta-carousel-nav';\r\n\r\n    // Previous button\r\n    const prevButton = document.createElement('button');\r\n    prevButton.className = 'tresta-carousel-button tresta-carousel-prev';\r\n    prevButton.setAttribute('aria-label', 'Previous testimonial');\r\n    prevButton.setAttribute('type', 'button');\r\n    prevButton.innerHTML = `\r\n      <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path d=\"M15 18L9 12L15 6\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n      </svg>\r\n    `;\r\n    prevButton.addEventListener('click', () => this.previous());\r\n\r\n    // Next button\r\n    const nextButton = document.createElement('button');\r\n    nextButton.className = 'tresta-carousel-button tresta-carousel-next';\r\n    nextButton.setAttribute('aria-label', 'Next testimonial');\r\n    nextButton.setAttribute('type', 'button');\r\n    nextButton.innerHTML = `\r\n      <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path d=\"M9 18L15 12L9 6\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n      </svg>\r\n    `;\r\n    nextButton.addEventListener('click', () => this.next());\r\n\r\n    nav.appendChild(prevButton);\r\n    nav.appendChild(nextButton);\r\n\r\n    return nav;\r\n  }\r\n\r\n  /**\r\n   * Renders dot indicators for position tracking\r\n   */\r\n  private renderDotIndicators(): HTMLElement {\r\n    const indicators = document.createElement('div');\r\n    indicators.className = 'tresta-carousel-indicators';\r\n    indicators.setAttribute('role', 'tablist');\r\n    indicators.setAttribute('aria-label', 'Testimonial navigation');\r\n\r\n    this.testimonials.forEach((_, index) => {\r\n      const dot = document.createElement('button');\r\n      dot.className = 'tresta-carousel-dot';\r\n      dot.setAttribute('type', 'button');\r\n      dot.setAttribute('role', 'tab');\r\n      dot.setAttribute('aria-label', `Go to testimonial ${index + 1}`);\r\n      dot.setAttribute('aria-selected', index === 0 ? 'true' : 'false');\r\n      dot.setAttribute('tabindex', index === 0 ? '0' : '-1');\r\n      dot.setAttribute('aria-controls', `testimonial-slide-${index}`);\r\n      \r\n      if (index === 0) {\r\n        dot.classList.add('active');\r\n      }\r\n\r\n      dot.addEventListener('click', () => this.goToSlide(index));\r\n\r\n      indicators.appendChild(dot);\r\n    });\r\n\r\n    return indicators;\r\n  }\r\n\r\n  /**\r\n   * Sets up event listeners for touch gestures, keyboard navigation, and pause-on-hover\r\n   */\r\n  private setupEventListeners(): void {\r\n    if (!this.container) return;\r\n\r\n    // Touch gesture support\r\n    this.container.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });\r\n    this.container.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });\r\n\r\n    // Pause on hover\r\n    this.container.addEventListener('mouseenter', () => this.pause());\r\n    this.container.addEventListener('mouseleave', () => this.resume());\r\n\r\n    // Keyboard navigation\r\n    this.container.addEventListener('keydown', (e) => this.handleKeyDown(e));\r\n\r\n    // Focus management\r\n    this.container.addEventListener('focusin', () => this.pause());\r\n    this.container.addEventListener('focusout', () => this.resume());\r\n  }\r\n\r\n  /**\r\n   * Handles touch start event\r\n   */\r\n  private handleTouchStart(e: TouchEvent): void {\r\n    const touch = e.touches[0];\r\n    if (!touch) return;\r\n    \r\n    this.touchStartX = touch.clientX;\r\n    this.pause();\r\n  }\r\n\r\n  /**\r\n   * Handles touch end event and detects swipe gestures\r\n   */\r\n  private handleTouchEnd(e: TouchEvent): void {\r\n    const touch = e.changedTouches[0];\r\n    if (!touch) return;\r\n    \r\n    this.touchEndX = touch.clientX;\r\n    this.handleSwipe();\r\n    this.resume();\r\n  }\r\n\r\n  /**\r\n   * Processes swipe gesture\r\n   */\r\n  private handleSwipe(): void {\r\n    const swipeThreshold = 50; // Minimum distance for a swipe\r\n    const diff = this.touchStartX - this.touchEndX;\r\n\r\n    if (Math.abs(diff) < swipeThreshold) {\r\n      return; // Not a swipe\r\n    }\r\n\r\n    if (diff > 0) {\r\n      // Swipe left - go to next\r\n      this.next();\r\n    } else {\r\n      // Swipe right - go to previous\r\n      this.previous();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles keyboard navigation\r\n   */\r\n  private handleKeyDown(e: KeyboardEvent): void {\r\n    switch (e.key) {\r\n      case 'ArrowLeft':\r\n        e.preventDefault();\r\n        this.previous();\r\n        break;\r\n      case 'ArrowRight':\r\n        e.preventDefault();\r\n        this.next();\r\n        break;\r\n      case 'Home':\r\n        e.preventDefault();\r\n        this.goToSlide(0);\r\n        break;\r\n      case 'End':\r\n        e.preventDefault();\r\n        this.goToSlide(this.testimonials.length - 1);\r\n        break;\r\n      case 'Escape':\r\n        e.preventDefault();\r\n        this.pause();\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Navigates to the previous slide\r\n   */\r\n  previous(): void {\r\n    if (this.isTransitioning) return;\r\n    \r\n    this.currentIndex = (this.currentIndex - 1 + this.testimonials.length) % this.testimonials.length;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Navigates to the next slide\r\n   */\r\n  next(): void {\r\n    if (this.isTransitioning) return;\r\n    \r\n    this.currentIndex = (this.currentIndex + 1) % this.testimonials.length;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Navigates to a specific slide by index\r\n   */\r\n  goToSlide(index: number): void {\r\n    if (this.isTransitioning || index === this.currentIndex) return;\r\n    if (index < 0 || index >= this.testimonials.length) return;\r\n\r\n    this.currentIndex = index;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Updates the carousel position to show the current slide\r\n   */\r\n  private updateSlidePosition(animate: boolean = true): void {\r\n    if (!this.container) return;\r\n\r\n    const track = this.container.querySelector('.tresta-carousel-track') as HTMLElement;\r\n    const slides = this.container.querySelectorAll('.tresta-carousel-slide');\r\n    const dots = this.container.querySelectorAll('.tresta-carousel-dot');\r\n\r\n    if (!track || slides.length === 0) return;\r\n\r\n    // Update track position\r\n    const offset = -this.currentIndex * 100;\r\n    track.style.transform = `translateX(${offset}%)`;\r\n    track.style.transition = animate ? 'transform 0.3s ease-in-out' : 'none';\r\n\r\n    // Update slide visibility and ARIA attributes\r\n    slides.forEach((slide, index) => {\r\n      const isActive = index === this.currentIndex;\r\n      slide.setAttribute('aria-hidden', isActive ? 'false' : 'true');\r\n      \r\n      if (isActive) {\r\n        slide.classList.add('active');\r\n      } else {\r\n        slide.classList.remove('active');\r\n      }\r\n    });\r\n\r\n    // Update dot indicators\r\n    dots.forEach((dot, index) => {\r\n      const isActive = index === this.currentIndex;\r\n      dot.setAttribute('aria-selected', isActive ? 'true' : 'false');\r\n      dot.setAttribute('tabindex', isActive ? '0' : '-1');\r\n      \r\n      if (isActive) {\r\n        dot.classList.add('active');\r\n      } else {\r\n        dot.classList.remove('active');\r\n      }\r\n    });\r\n\r\n    // Set transitioning flag after DOM updates\r\n    if (animate) {\r\n      this.isTransitioning = true;\r\n      setTimeout(() => {\r\n        this.isTransitioning = false;\r\n      }, 300); // Match CSS transition duration\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts auto-rotation\r\n   */\r\n  private startAutoRotate(): void {\r\n    if (this.layoutConfig.autoRotate === false) return;\r\n\r\n    const interval = this.layoutConfig.rotateInterval || 5000; // Default 5 seconds\r\n\r\n    this.autoRotateTimer = window.setInterval(() => {\r\n      if (!this.isPaused) {\r\n        this.next();\r\n      }\r\n    }, interval);\r\n  }\r\n\r\n  /**\r\n   * Stops auto-rotation\r\n   */\r\n  private stopAutoRotate(): void {\r\n    if (this.autoRotateTimer !== null) {\r\n      clearInterval(this.autoRotateTimer);\r\n      this.autoRotateTimer = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Pauses auto-rotation\r\n   */\r\n  pause(): void {\r\n    if (!this.isPaused) {\r\n      this.isPaused = true;\r\n      \r\n      // Update ARIA live region to announce pause\r\n      if (this.container) {\r\n        this.container.setAttribute('aria-live', 'off');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resumes auto-rotation\r\n   */\r\n  resume(): void {\r\n    if (this.isPaused) {\r\n      this.isPaused = false;\r\n      \r\n      // Update ARIA live region to announce resume\r\n      if (this.container) {\r\n        this.container.setAttribute('aria-live', 'polite');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleans up event listeners and timers\r\n   */\r\n  destroy(): void {\r\n    this.stopAutoRotate();\r\n\r\n    if (this.container) {\r\n      // Remove event listeners\r\n      const clonedContainer = this.container.cloneNode(true) as HTMLElement;\r\n      this.container.parentNode?.replaceChild(clonedContainer, this.container);\r\n      this.container = null;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Grid Layout\r\n * \r\n * Responsive grid layout with CSS Grid and equal-height cards.\r\n * Supports 1-4 columns based on screen size.\r\n * Implements Requirements: 3.2, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface GridConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Grid {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: GridConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the grid layout\r\n   */\r\n  render(): HTMLElement {\r\n    const grid = document.createElement('div');\r\n    grid.className = 'tresta-grid';\r\n    grid.setAttribute('role', 'list');\r\n    grid.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      grid.appendChild(emptyState);\r\n      return grid;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      grid.style.setProperty('--grid-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      grid.appendChild(item);\r\n    });\r\n\r\n    return grid;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial grid item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-grid-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for grid layout\r\n  }\r\n}\r\n","/**\r\n * Masonry Layout\r\n * \r\n * Pinterest-style layout with dynamic height cards and optimal spacing.\r\n * Uses CSS Grid with auto-flow dense for efficient packing.\r\n * Implements Requirements: 3.3, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface MasonryConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Masonry {\r\n  private static readonly GRID_ROW_UNIT = 10;\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n  private container: HTMLElement | null = null;\r\n  private resizeObserver: ResizeObserver | null = null;\r\n\r\n  constructor(config: MasonryConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the masonry layout\r\n   */\r\n  render(): HTMLElement {\r\n    const masonry = document.createElement('div');\r\n    masonry.className = 'tresta-masonry';\r\n    masonry.setAttribute('role', 'list');\r\n    masonry.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      masonry.appendChild(emptyState);\r\n      return masonry;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      masonry.style.setProperty('--masonry-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      masonry.appendChild(item);\r\n      this.queueSpanCalculation(item);\r\n    });\r\n\r\n    this.container = masonry;\r\n\r\n    // Set up resize observer to recalculate layout on size changes\r\n    this.setupResizeObserver();\r\n\r\n    return masonry;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial masonry item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-masonry-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Sets up ResizeObserver to handle dynamic height changes\r\n   */\r\n  private setupResizeObserver(): void {\r\n    if (!this.container) return;\r\n\r\n    // Check if ResizeObserver is supported\r\n    if (typeof ResizeObserver === 'undefined') {\r\n      return; // Graceful degradation - layout will still work without dynamic adjustments\r\n    }\r\n\r\n    this.resizeObserver = new ResizeObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        const item = entry.target as HTMLElement;\r\n        this.applyRowSpan(item, entry.contentRect.height);\r\n      });\r\n    });\r\n\r\n    // Observe all masonry items\r\n    const items = this.container.querySelectorAll('.tresta-masonry-item');\r\n    items.forEach((item) => {\r\n      this.resizeObserver!.observe(item);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets grid row span based on measured height\r\n   */\r\n  private applyRowSpan(item: HTMLElement, measuredHeight?: number): void {\r\n    const height = measuredHeight ?? item.getBoundingClientRect().height;\r\n\r\n    if (!height || Number.isNaN(height)) {\r\n      return;\r\n    }\r\n\r\n    const rowSpan = Math.max(\r\n      1,\r\n      Math.ceil(height / Masonry.GRID_ROW_UNIT)\r\n    );\r\n\r\n    item.style.gridRowEnd = `span ${rowSpan}`;\r\n  }\r\n\r\n  /**\r\n   * Ensures span calculation runs even when ResizeObserver is unavailable\r\n   */\r\n  private queueSpanCalculation(item: HTMLElement): void {\r\n    if (typeof requestAnimationFrame !== 'undefined') {\r\n      requestAnimationFrame(() => this.applyRowSpan(item));\r\n      return;\r\n    }\r\n\r\n    setTimeout(() => this.applyRowSpan(item), 0);\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    if (this.resizeObserver) {\r\n      this.resizeObserver.disconnect();\r\n      this.resizeObserver = null;\r\n    }\r\n    this.container = null;\r\n  }\r\n}\r\n","/**\r\n * Wall Layout\r\n * \r\n * Dense grid layout with varied card sizes for visual interest.\r\n * Featured testimonials (high ratings or verified) get larger cards.\r\n * Implements Requirements: 3.4, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface WallConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Wall {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: WallConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the wall layout\r\n   */\r\n  render(): HTMLElement {\r\n    const wall = document.createElement('div');\r\n    wall.className = 'tresta-wall';\r\n    wall.setAttribute('role', 'list');\r\n    wall.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      wall.appendChild(emptyState);\r\n      return wall;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      wall.style.setProperty('--wall-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items with varied sizes\r\n    this.testimonials.forEach((testimonial, index) => {\r\n      const item = this.renderItem(testimonial, index);\r\n      wall.appendChild(item);\r\n    });\r\n\r\n    return wall;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial wall item with size variation\r\n   */\r\n  private renderItem(testimonial: Testimonial, index: number): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-wall-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Determine if this should be a featured (larger) card\r\n    const isFeatured = this.shouldBeFeatured(testimonial, index);\r\n    \r\n    if (isFeatured) {\r\n      item.classList.add('tresta-wall-item-featured');\r\n    }\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Determines if a testimonial should be featured (larger card)\r\n   * Based on rating, verification status, and position\r\n   */\r\n  private shouldBeFeatured(testimonial: Testimonial, index: number): boolean {\r\n    // Feature every 5th testimonial for visual variety\r\n    const isPositionFeatured = index % 5 === 0;\r\n    \r\n    // Feature high-rated testimonials (5 stars)\r\n    const isHighRated = testimonial.rating === 5;\r\n    \r\n    // Feature OAuth verified testimonials\r\n    const isVerified = testimonial.isOAuthVerified;\r\n    \r\n    // A testimonial is featured if it meets any of these criteria\r\n    return isPositionFeatured || (isHighRated && isVerified);\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for wall layout\r\n  }\r\n}\r\n","/**\r\n * List Layout\r\n * \r\n * Simple vertical list layout with minimal JavaScript.\r\n * Serves as a fallback for older browsers.\r\n * Implements Requirements: 3.5, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface ListConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class List {\r\n  private testimonials: Testimonial[];\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: ListConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the list layout\r\n   */\r\n  render(): HTMLElement {\r\n    const list = document.createElement('div');\r\n    list.className = 'tresta-list';\r\n    list.setAttribute('role', 'list');\r\n    list.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      list.appendChild(emptyState);\r\n      return list;\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      list.appendChild(item);\r\n    });\r\n\r\n    return list;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial list item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-list-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for list layout\r\n  }\r\n}\r\n","/**\r\n * Layout Engine\r\n * \r\n * Factory for creating different layout types.\r\n * Implements Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { Carousel } from './carousel';\r\nimport { Grid } from './grid';\r\nimport { Masonry } from './masonry';\r\nimport { Wall } from './wall';\r\nimport { List } from './list';\r\n\r\nexport { Carousel } from './carousel';\r\nexport { Grid } from './grid';\r\nexport { Masonry } from './masonry';\r\nexport { Wall } from './wall';\r\nexport { List } from './list';\r\n\r\nexport type { CarouselConfig } from './carousel';\r\nexport type { GridConfig } from './grid';\r\nexport type { MasonryConfig } from './masonry';\r\nexport type { WallConfig } from './wall';\r\nexport type { ListConfig } from './list';\r\n\r\n/**\r\n * Layout interface that all layouts must implement\r\n */\r\nexport interface Layout {\r\n  render(): HTMLElement;\r\n  destroy(): void;\r\n}\r\n\r\n/**\r\n * Configuration for creating a layout\r\n */\r\nexport interface LayoutEngineConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\n/**\r\n * LayoutEngine - Factory for creating layout instances\r\n */\r\nexport class LayoutEngine {\r\n  /**\r\n   * Creates a layout instance based on the specified type\r\n   * \r\n   * @param config - Configuration including layout type and testimonials\r\n   * @returns Layout instance\r\n   * @throws Error if layout type is not supported\r\n   */\r\n  static create(config: LayoutEngineConfig): Layout {\r\n    const { layoutConfig } = config;\r\n\r\n    switch (layoutConfig.type) {\r\n      case 'carousel':\r\n        return new Carousel(config);\r\n      \r\n      case 'grid':\r\n        return new Grid(config);\r\n      \r\n      case 'masonry':\r\n        return new Masonry(config);\r\n      \r\n      case 'wall':\r\n        return new Wall(config);\r\n      \r\n      case 'list':\r\n        return new List(config);\r\n      \r\n      default:\r\n        // Fallback to list layout for unknown types (graceful degradation)\r\n        console.warn(`[TrestaWidget] Unknown layout type: ${layoutConfig.type}. Falling back to list layout.`);\r\n        return new List(config);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Testimonial Limiter Utility\r\n * \r\n * Handles limiting and sorting of testimonials based on configuration.\r\n * Implements Requirements: 12.1, 12.2, 12.3, 12.4, 12.5\r\n */\r\n\r\nimport type { Testimonial } from '../types';\r\n\r\n/**\r\n * Limits testimonials to the specified maximum count, prioritizing most recent.\r\n * \r\n * @param testimonials - Array of testimonials to limit\r\n * @param maxTestimonials - Maximum number of testimonials to return (default: 100)\r\n * @returns Limited array of testimonials, sorted by createdAt descending\r\n */\r\nexport function limitTestimonials(\r\n  testimonials: Testimonial[],\r\n  maxTestimonials?: number\r\n): Testimonial[] {\r\n  // Handle empty or invalid input\r\n  if (!testimonials || testimonials.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Default to 100 if not specified\r\n  const limit = maxTestimonials ?? 100;\r\n\r\n  // If limit is 0 or negative, return empty array\r\n  if (limit <= 0) {\r\n    return [];\r\n  }\r\n\r\n  // If we have fewer testimonials than the limit, just sort and return all\r\n  if (testimonials.length <= limit) {\r\n    return sortByCreatedAtDesc(testimonials);\r\n  }\r\n\r\n  // Sort by createdAt descending and take the first 'limit' items\r\n  return sortByCreatedAtDesc(testimonials).slice(0, limit);\r\n}\r\n\r\n/**\r\n * Sorts testimonials by createdAt in descending order (most recent first)\r\n * \r\n * @param testimonials - Array of testimonials to sort\r\n * @returns Sorted array (does not mutate original)\r\n */\r\nfunction sortByCreatedAtDesc(testimonials: Testimonial[]): Testimonial[] {\r\n  // Create a copy to avoid mutating the original array\r\n  return [...testimonials].sort((a, b) => {\r\n    const dateA = new Date(a.createdAt).getTime();\r\n    const dateB = new Date(b.createdAt).getTime();\r\n    \r\n    // Sort descending (most recent first)\r\n    return dateB - dateA;\r\n  });\r\n}\r\n","/**\r\n * CSP Validator - Ensures Content Security Policy compliance\r\n * \r\n * Features:\r\n * - Validates that all resources load from allowed domains\r\n * - Detects CSP violations at runtime\r\n * - Provides nonce support for strict CSP environments\r\n * - Validates no inline scripts or eval() usage\r\n */\r\n\r\nexport interface CSPConfig {\r\n  allowedDomains: string[];\r\n  nonce?: string;\r\n  reportViolations?: boolean;\r\n}\r\n\r\n// Default allowed domains per requirements\r\nconst DEFAULT_ALLOWED_DOMAINS = [\r\n  'cdn.tresta.com',\r\n  'api.tresta.com',\r\n];\r\n\r\n/**\r\n * CSP Validator class\r\n */\r\nexport class CSPValidator {\r\n  private config: CSPConfig;\r\n  private violations: CSPViolation[] = [];\r\n\r\n  constructor(config: Partial<CSPConfig> = {}) {\r\n    this.config = {\r\n      allowedDomains: DEFAULT_ALLOWED_DOMAINS,\r\n      reportViolations: true,\r\n      ...config,\r\n    };\r\n\r\n    // Set up CSP violation listener if reporting is enabled\r\n    if (this.config.reportViolations && typeof document !== 'undefined') {\r\n      this.setupViolationListener();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validates that a URL is from an allowed domain\r\n   */\r\n  validateURL(url: string): boolean {\r\n    if (!url) {\r\n      return false;\r\n    }\r\n\r\n    // Allow relative URLs\r\n    if (url.startsWith('/') || url.startsWith('./') || url.startsWith('../')) {\r\n      return true;\r\n    }\r\n\r\n    // Allow data URLs for inline images (common for small icons)\r\n    if (url.startsWith('data:')) {\r\n      return true;\r\n    }\r\n\r\n    try {\r\n      const parsed = new URL(url);\r\n      const hostname = parsed.hostname;\r\n\r\n      // Check if hostname matches any allowed domain\r\n      return this.config.allowedDomains.some(domain => {\r\n        // Exact match or subdomain match\r\n        return hostname === domain || hostname.endsWith(`.${domain}`);\r\n      });\r\n    } catch {\r\n      // Invalid URL\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validates that all resources in the widget are from allowed domains\r\n   */\r\n  validateResources(root: HTMLElement): CSPValidationResult {\r\n    const violations: CSPViolation[] = [];\r\n\r\n    // Check all images\r\n    const images = root.querySelectorAll('img');\r\n    images.forEach(img => {\r\n      const src = img.getAttribute('src');\r\n      if (src && !this.validateURL(src)) {\r\n        violations.push({\r\n          type: 'image',\r\n          url: src,\r\n          element: img,\r\n          message: `Image source not from allowed domain: ${src}`,\r\n        });\r\n      }\r\n    });\r\n\r\n    // Check all scripts (should not exist in widget content)\r\n    const scripts = root.querySelectorAll('script');\r\n    scripts.forEach(script => {\r\n      violations.push({\r\n        type: 'script',\r\n        url: script.getAttribute('src') || 'inline',\r\n        element: script,\r\n        message: 'Script tag found in widget content (CSP violation)',\r\n      });\r\n    });\r\n\r\n    // Check all iframes (should not exist in widget content)\r\n    const iframes = root.querySelectorAll('iframe');\r\n    iframes.forEach(iframe => {\r\n      violations.push({\r\n        type: 'iframe',\r\n        url: iframe.getAttribute('src') || 'inline',\r\n        element: iframe,\r\n        message: 'Iframe found in widget content (CSP violation)',\r\n      });\r\n    });\r\n\r\n    // Check all links\r\n    const links = root.querySelectorAll('a');\r\n    links.forEach(link => {\r\n      const href = link.getAttribute('href');\r\n      if (href && href.startsWith('javascript:')) {\r\n        violations.push({\r\n          type: 'link',\r\n          url: href,\r\n          element: link,\r\n          message: 'JavaScript URL in link (CSP violation)',\r\n        });\r\n      }\r\n    });\r\n\r\n    // Check for inline event handlers\r\n    const elementsWithEvents = root.querySelectorAll('[onclick], [onload], [onerror], [onmouseover]');\r\n    elementsWithEvents.forEach(element => {\r\n      violations.push({\r\n        type: 'inline-event',\r\n        url: 'inline',\r\n        element: element as HTMLElement,\r\n        message: 'Inline event handler found (CSP violation)',\r\n      });\r\n    });\r\n\r\n    return {\r\n      valid: violations.length === 0,\r\n      violations,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks if the current environment has a strict CSP\r\n   */\r\n  async detectStrictCSP(): Promise<boolean> {\r\n    // Try to detect CSP by attempting to create an inline script\r\n    // This is a non-invasive check that doesn't actually execute anything\r\n    try {\r\n      const meta = document.querySelector('meta[http-equiv=\"Content-Security-Policy\"]');\r\n      if (meta) {\r\n        const content = meta.getAttribute('content') || '';\r\n        // Check for strict CSP directives\r\n        return content.includes(\"'strict-dynamic'\") || \r\n               (!content.includes(\"'unsafe-inline'\") && !content.includes(\"'unsafe-eval'\"));\r\n      }\r\n    } catch {\r\n      // If we can't check, assume no strict CSP\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Gets the nonce value from the current script tag or config\r\n   */\r\n  getNonce(): string | null {\r\n    // First check config\r\n    if (this.config.nonce) {\r\n      return this.config.nonce;\r\n    }\r\n\r\n    // Try to find nonce from the widget script tag\r\n    if (typeof document !== 'undefined') {\r\n      const scripts = document.querySelectorAll('script[data-widget-id]');\r\n      for (const script of Array.from(scripts)) {\r\n        const nonce = script.getAttribute('nonce');\r\n        if (nonce) {\r\n          return nonce;\r\n        }\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Applies nonce to dynamically created elements if needed\r\n   */\r\n  applyNonce(element: HTMLElement): void {\r\n    const nonce = this.getNonce();\r\n    if (nonce) {\r\n      // Apply nonce to script and style tags\r\n      if (element.tagName === 'SCRIPT' || element.tagName === 'STYLE') {\r\n        element.setAttribute('nonce', nonce);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets all recorded violations\r\n   */\r\n  getViolations(): CSPViolation[] {\r\n    return [...this.violations];\r\n  }\r\n\r\n  /**\r\n   * Clears all recorded violations\r\n   */\r\n  clearViolations(): void {\r\n    this.violations = [];\r\n  }\r\n\r\n  /**\r\n   * Sets up a listener for CSP violations\r\n   */\r\n  private setupViolationListener(): void {\r\n    if (typeof document === 'undefined') {\r\n      return;\r\n    }\r\n\r\n    document.addEventListener('securitypolicyviolation', (event) => {\r\n      // Only track violations related to our widget\r\n      if (event.blockedURI && this.isWidgetRelated(event)) {\r\n        this.violations.push({\r\n          type: 'csp-violation',\r\n          url: event.blockedURI,\r\n          message: `CSP violation: ${event.violatedDirective} - ${event.blockedURI}`,\r\n          directive: event.violatedDirective,\r\n        });\r\n\r\n        console.warn('[TrestaWidget] CSP violation detected:', {\r\n          directive: event.violatedDirective,\r\n          blockedURI: event.blockedURI,\r\n          sourceFile: event.sourceFile,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if a CSP violation is related to our widget\r\n   */\r\n  private isWidgetRelated(event: SecurityPolicyViolationEvent): boolean {\r\n    // Check if the violation is from our widget domains\r\n    const blockedURI = event.blockedURI;\r\n    const sourceFile = event.sourceFile;\r\n\r\n    return (\r\n      this.config.allowedDomains.some(domain => \r\n        blockedURI.includes(domain) || sourceFile?.includes(domain)\r\n      ) ||\r\n      sourceFile?.includes('tresta-widget') ||\r\n      blockedURI.includes('tresta-widget')\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * CSP Violation interface\r\n */\r\nexport interface CSPViolation {\r\n  type: 'image' | 'script' | 'iframe' | 'link' | 'inline-event' | 'csp-violation';\r\n  url: string;\r\n  element?: HTMLElement;\r\n  message: string;\r\n  directive?: string;\r\n}\r\n\r\n/**\r\n * CSP Validation Result\r\n */\r\nexport interface CSPValidationResult {\r\n  valid: boolean;\r\n  violations: CSPViolation[];\r\n}\r\n\r\n/**\r\n * Validates CSP compliance for required directives\r\n */\r\nexport function getRequiredCSPDirectives(): string[] {\r\n  return [\r\n    \"script-src 'self' https://cdn.tresta.com\",\r\n    \"connect-src https://api.tresta.com\",\r\n    \"img-src https://cdn.tresta.com https://api.tresta.com data:\",\r\n    \"style-src 'self' https://cdn.tresta.com\",\r\n  ];\r\n}\r\n\r\n/**\r\n * Generates CSP-friendly embed code with nonce support\r\n */\r\nexport function generateCSPFriendlyEmbedCode(\r\n  widgetId: string,\r\n  version: string,\r\n  integrity?: string,\r\n  nonce?: string\r\n): string {\r\n  const nonceAttr = nonce ? ` nonce=\"${nonce}\"` : '';\r\n  const integrityAttr = integrity ? ` integrity=\"${integrity}\" crossorigin=\"anonymous\"` : '';\r\n\r\n  return `<!-- Tresta Testimonial Widget (CSP-friendly) -->\r\n<div id=\"tresta-widget-${widgetId}\" data-widget-id=\"${widgetId}\"></div>\r\n<script async \r\n        src=\"https://cdn.tresta.com/widget/v${version}/tresta-widget.iife.js\"${integrityAttr}${nonceAttr}\r\n        data-widget-id=\"${widgetId}\"></script>`;\r\n}\r\n\r\n// Export singleton instance\r\nexport const defaultCSPValidator = new CSPValidator();\r\n","/**\r\n * Main Widget class - orchestrates all widget functionality\r\n */\r\n\r\nimport type { WidgetConfig, WidgetInstance, WidgetState, WidgetData } from '../types';\r\nimport { WidgetError } from '../types';\r\nimport { StyleManager } from '../styles/style-manager';\r\nimport { APIClient } from '../api/client';\r\nimport { StorageManager } from '../storage/cache-manager';\r\nimport { createErrorState, createEmptyState } from '../components/error-state';\r\nimport { TelemetryTracker } from '../telemetry';\r\nimport { LayoutEngine } from '../layouts';\r\nimport { limitTestimonials } from '../utils/testimonial-limiter';\r\nimport { Logger } from '../utils/logger';\r\nimport { CSPValidator } from '../security/csp-validator';\r\nimport type { CSPConfig } from '../security/csp-validator';\r\n\r\n// Track all widget instances for proper cleanup and isolation\r\nconst widgetInstances = new WeakMap<HTMLElement, Widget>();\r\n\r\nexport class Widget implements WidgetInstance {\r\n  private config: WidgetConfig;\r\n  private state: WidgetState;\r\n  private container: HTMLElement | null = null;\r\n  private root: HTMLElement | null = null;\r\n  private styleManager: StyleManager | null = null;\r\n  private contentRoot: HTMLElement | null = null;\r\n  private liveRegion: HTMLElement | null = null;\r\n  private eventListeners: Array<{ element: HTMLElement; event: string; handler: EventListener }> = [];\r\n  private currentLayout: { destroy: () => void } | null = null;\r\n  private apiClient: APIClient;\r\n  private storageManager: StorageManager;\r\n  private telemetryTracker: TelemetryTracker;\r\n  private logger: Logger;\r\n  private cspValidator: CSPValidator;\r\n\r\n  constructor(config: WidgetConfig) {\r\n    this.config = config;\r\n    this.state = {\r\n      mounted: false,\r\n      loading: false,\r\n      error: null,\r\n      data: null,\r\n    };\r\n\r\n    // Initialize logger\r\n    this.logger = new Logger(\r\n      config.widgetId,\r\n      config.version || '1.0.0',\r\n      config.debug || false\r\n    );\r\n\r\n    // Initialize API client with API key and custom base URL if provided\r\n    const apiClientConfig = config.apiUrl ? { baseURL: config.apiUrl } : {};\r\n    this.apiClient = new APIClient(apiClientConfig, config.apiKey, this.logger);\r\n    this.storageManager = new StorageManager();\r\n\r\n    // Initialize telemetry tracker\r\n    this.telemetryTracker = new TelemetryTracker(\r\n      config.widgetId,\r\n      config.version || '1.0.0',\r\n      {\r\n        enabled: config.telemetry !== false,\r\n      }\r\n    );\r\n\r\n    // Initialize CSP validator\r\n    const cspConfig: Partial<CSPConfig> = {\r\n      reportViolations: config.debug || false,\r\n    };\r\n\r\n    if (config.nonce) {\r\n      cspConfig.nonce = config.nonce;\r\n    }\r\n\r\n    this.cspValidator = new CSPValidator(cspConfig);\r\n\r\n    this.logger.debug('Initialized with config:', {\r\n      widgetId: config.widgetId,\r\n      apiKey: config.apiKey ? `${config.apiKey.substring(0, 15)}...` : 'NOT PROVIDED',\r\n      apiUrl: config.apiUrl || 'default (https://api.tresta.com)',\r\n      debug: config.debug,\r\n      telemetry: config.telemetry,\r\n      version: config.version,\r\n    });\r\n    this.logger.debug('Telemetry enabled:', this.telemetryTracker.isEnabled());\r\n  }\r\n\r\n  async mount(container: HTMLElement): Promise<void> {\r\n    try {\r\n      // Start telemetry load tracking\r\n      this.telemetryTracker.startLoadTracking();\r\n\r\n      // Check if widget is already mounted in this container\r\n      if (widgetInstances.has(container)) {\r\n        const existingWidget = widgetInstances.get(container);\r\n        if (existingWidget && existingWidget !== this) {\r\n          console.warn(`[TrestaWidget] Container already has a widget instance. Unmounting existing widget.`);\r\n          existingWidget.unmount();\r\n        }\r\n      }\r\n\r\n      this.container = container;\r\n      this.state.mounted = true;\r\n      this.state.loading = true;\r\n\r\n      // Create widget root\r\n      this.root = document.createElement('div');\r\n      this.root.setAttribute('data-tresta-widget', this.config.widgetId);\r\n      this.root.setAttribute('data-version', this.config.version || '1.0.0');\r\n      this.root.setAttribute('data-instance-id', this.generateInstanceId());\r\n      \r\n      // Add lang attribute for localization support\r\n      if (this.config.lang) {\r\n        this.root.setAttribute('lang', this.config.lang);\r\n      }\r\n      \r\n      // Add role for semantic structure\r\n      this.root.setAttribute('role', 'region');\r\n      this.root.setAttribute('aria-label', 'Testimonials widget');\r\n\r\n      // Initialize style manager and get content root\r\n      this.styleManager = new StyleManager({\r\n        debug: this.config.debug ?? false,\r\n        theme: this.config.theme,\r\n        ...(this.config.useShadowDOM !== undefined && { useShadowDOM: this.config.useShadowDOM }),\r\n        nonceApplier: (element) => this.cspValidator.applyNonce(element),\r\n      });\r\n      this.contentRoot = this.styleManager.initializeStyles(this.root);\r\n      \r\n      // Create ARIA live region for dynamic content announcements\r\n      this.liveRegion = document.createElement('div');\r\n      this.liveRegion.setAttribute('role', 'status');\r\n      this.liveRegion.setAttribute('aria-live', 'polite');\r\n      this.liveRegion.setAttribute('aria-atomic', 'true');\r\n      this.liveRegion.className = 'tresta-sr-only';\r\n      this.contentRoot.appendChild(this.liveRegion);\r\n\r\n      container.appendChild(this.root);\r\n\r\n      // Register this instance\r\n      widgetInstances.set(container, this);\r\n\r\n      // Fetch and render widget data\r\n      await this.fetchAndRender();\r\n\r\n      this.logger.debug('Mounted successfully to container', container);\r\n    } catch (error) {\r\n      this.state.loading = false;\r\n      this.state.error = error as Error;\r\n\r\n      // Track error in telemetry\r\n      if (error instanceof WidgetError) {\r\n        this.telemetryTracker.trackError(error.code);\r\n      } else {\r\n        this.telemetryTracker.trackError('MOUNT_ERROR');\r\n      }\r\n\r\n      // Log error with widget ID and version\r\n      this.logError('Mount failed', error);\r\n\r\n      // Render error state - don't throw to prevent breaking host page\r\n      this.renderErrorState(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data with cache fallback\r\n   */\r\n  private async fetchAndRender(): Promise<void> {\r\n    try {\r\n      this.logger.debug('Starting fetchAndRender');\r\n\r\n      this.state.loading = true;\r\n      \r\n      // Announce loading state to screen readers\r\n      this.announceToScreenReader('Loading testimonials');\r\n\r\n      // Try to fetch from API\r\n      const data = await this.fetchWithFallback();\r\n\r\n      this.logger.debug('Data fetched successfully:', {\r\n        widgetId: data.widgetId,\r\n        testimonialCount: data.testimonials?.length || 0,\r\n      });\r\n\r\n      this.state.data = data;\r\n      this.state.error = null;\r\n      this.state.loading = false;\r\n\r\n      // Render the widget content\r\n      this.renderContent(data);\r\n\r\n      // Track successful load with layout type\r\n      this.telemetryTracker.trackLoad(data.config?.layout?.type);\r\n      \r\n      // Announce successful load to screen readers\r\n      const count = data.testimonials?.length || 0;\r\n      this.announceToScreenReader(`${count} testimonial${count !== 1 ? 's' : ''} loaded`);\r\n\r\n    } catch (error) {\r\n      this.state.loading = false;\r\n      this.state.error = error as Error;\r\n\r\n      // Track error in telemetry\r\n      if (error instanceof WidgetError) {\r\n        this.telemetryTracker.trackError(error.code);\r\n      } else {\r\n        this.telemetryTracker.trackError('FETCH_ERROR');\r\n      }\r\n\r\n      // Log error with widget ID and version\r\n      this.logError('Failed to fetch widget data', error);\r\n\r\n      // Render error state\r\n      this.renderErrorState(error);\r\n      \r\n      // Announce error to screen readers\r\n      this.announceToScreenReader('Failed to load testimonials', 'assertive');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data with cache fallback on errors\r\n   */\r\n  private async fetchWithFallback(): Promise<WidgetData> {\r\n    try {\r\n      // Fetch from API\r\n      const data = await this.apiClient.fetchWidgetData(this.config.widgetId);\r\n\r\n      // Cache the successful response\r\n      await this.storageManager.set(this.config.widgetId, data);\r\n\r\n      this.logger.debug('Fetched widget data from API');\r\n\r\n      return data;\r\n    } catch (error) {\r\n      // Try to use cached data as fallback\r\n      const cached = await this.storageManager.get(this.config.widgetId);\r\n\r\n      if (cached) {\r\n        this.logger.warn('Using cached data due to API error');\r\n        return cached;\r\n      }\r\n\r\n      // No cache available, re-throw the error\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render widget content\r\n   */\r\n  private renderContent(data: WidgetData): void {\r\n    this.logger.debug('renderContent called', {\r\n      hasContentRoot: !!this.contentRoot,\r\n      testimonialCount: data.testimonials?.length || 0,\r\n      widgetData: data,\r\n    });\r\n\r\n    if (!this.contentRoot) {\r\n      this.logger.error('No content root available for rendering');\r\n      return;\r\n    }\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Check if there are any testimonials\r\n    if (!data.testimonials || data.testimonials.length === 0) {\r\n      this.logger.logEmpty();\r\n      this.renderEmptyState();\r\n      return;\r\n    }\r\n\r\n    // Apply maxTestimonials limit before rendering\r\n    // Check both layoutConfig and displayOptions for maxTestimonials\r\n    const maxTestimonials = data.config.layout.maxTestimonials ?? data.config.display.maxTestimonials;\r\n    const limitedTestimonials = limitTestimonials(data.testimonials, maxTestimonials);\r\n\r\n    this.logger.debug(`Rendering ${limitedTestimonials.length} testimonials (limited from ${data.testimonials.length}) with layout: ${data.config.layout.type}`);\r\n\r\n    // Clean up previous layout if exists\r\n    if (this.currentLayout) {\r\n      this.currentLayout.destroy();\r\n      this.currentLayout = null;\r\n    }\r\n\r\n    // Use LayoutEngine to render the limited testimonials\r\n    const layout = LayoutEngine.create({\r\n      testimonials: limitedTestimonials,\r\n      layoutConfig: data.config.layout,\r\n      displayOptions: data.config.display,\r\n      theme: data.config.theme,\r\n    });\r\n\r\n    const layoutElement = layout.render();\r\n    this.contentRoot.appendChild(layoutElement);\r\n\r\n    // Track the current layout for cleanup\r\n    this.currentLayout = layout;\r\n\r\n    this.logger.debug(`Widget rendered successfully with ${data.config.layout.type} layout`);\r\n\r\n    // Validate CSP compliance in debug mode\r\n    if (this.config.debug && this.contentRoot) {\r\n      const cspResult = this.cspValidator.validateResources(this.contentRoot);\r\n      if (!cspResult.valid) {\r\n        this.logger.warn('CSP violations detected:', cspResult.violations);\r\n      } else {\r\n        this.logger.debug('CSP validation passed');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render error state\r\n   */\r\n  private renderErrorState(error: unknown): void {\r\n    if (!this.contentRoot) return;\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Determine error message\r\n    let message = this.config.errorMessage;\r\n\r\n    if (!message) {\r\n      if (error instanceof WidgetError) {\r\n        message = error.message;\r\n      } else {\r\n        message = 'Unable to load testimonials. Please try again later.';\r\n      }\r\n    }\r\n\r\n    // Create and append error state\r\n    const errorState = createErrorState({\r\n      type: 'error',\r\n      message,\r\n      widgetId: this.config.widgetId,\r\n      version: this.config.version || \"N/A\",\r\n    });\r\n\r\n    this.contentRoot.appendChild(errorState);\r\n  }\r\n\r\n  /**\r\n   * Render empty state\r\n   */\r\n  private renderEmptyState(): void {\r\n    if (!this.contentRoot) return;\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Create and append empty state\r\n    const emptyState = createEmptyState(this.config.emptyMessage);\r\n\r\n    this.contentRoot.appendChild(emptyState);\r\n  }\r\n\r\n  /**\r\n   * Log error with widget ID and version\r\n   */\r\n  private logError(context: string, error: unknown): void {\r\n    if (error instanceof WidgetError) {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        `[${error.code}]`,\r\n        error.message\r\n      );\r\n    } else if (error instanceof Error) {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        error.message\r\n      );\r\n    } else {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        error\r\n      );\r\n    }\r\n  }\r\n\r\n  unmount(): void {\r\n    try {\r\n      // Clean up current layout (timers, event listeners, etc.)\r\n      if (this.currentLayout) {\r\n        this.currentLayout.destroy();\r\n        this.currentLayout = null;\r\n      }\r\n\r\n      // Remove all event listeners\r\n      this.cleanupEventListeners();\r\n\r\n      // Clean up style manager\r\n      if (this.styleManager) {\r\n        this.styleManager.cleanup();\r\n        this.styleManager = null;\r\n      }\r\n\r\n      // Remove widget root from DOM\r\n      if (this.root && this.root.parentNode) {\r\n        this.root.parentNode.removeChild(this.root);\r\n        this.root = null;\r\n      }\r\n\r\n      // Unregister instance\r\n      if (this.container) {\r\n        widgetInstances.delete(this.container);\r\n      }\r\n\r\n      this.state.mounted = false;\r\n      this.container = null;\r\n      this.contentRoot = null;\r\n\r\n      this.logger.debug('Unmounted successfully');\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Unmount failed:', error);\r\n    }\r\n  }\r\n\r\n  async refresh(): Promise<void> {\r\n    try {\r\n      this.logger.debug('Refresh requested');\r\n\r\n      if (!this.state.mounted) {\r\n        this.logger.warn('Cannot refresh: widget not mounted');\r\n        return;\r\n      }\r\n\r\n      // Fetch and render fresh data\r\n      await this.fetchAndRender();\r\n    } catch (error) {\r\n      // Error is already handled in fetchAndRender\r\n      // Just log for debugging\r\n      this.logError('Refresh failed', error);\r\n    }\r\n  }\r\n\r\n  getState(): WidgetState {\r\n    return { ...this.state };\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    this.eventListeners.forEach(({ element, event, handler }) => {\r\n      element.removeEventListener(event, handler);\r\n    });\r\n    this.eventListeners = [];\r\n  }\r\n\r\n  /**\r\n   * Generate a unique instance ID for this widget\r\n   */\r\n  private generateInstanceId(): string {\r\n    return `${this.config.widgetId}-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;\r\n  }\r\n\r\n  /**\r\n   * Announces a message to screen readers via ARIA live region\r\n   */\r\n  private announceToScreenReader(\r\n    message: string,\r\n    priority: 'polite' | 'assertive' = 'polite'\r\n  ): void {\r\n    if (!this.liveRegion) return;\r\n\r\n    // Update the priority if needed\r\n    this.liveRegion.setAttribute('aria-live', priority);\r\n\r\n    // Update the message\r\n    this.liveRegion.textContent = message;\r\n\r\n    // Clear the message after a delay to allow for repeated announcements\r\n    setTimeout(() => {\r\n      if (this.liveRegion) {\r\n        this.liveRegion.textContent = '';\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  /**\r\n   * Get the widget instance for a container\r\n   */\r\n  static getInstance(container: HTMLElement): Widget | undefined {\r\n    return widgetInstances.get(container);\r\n  }\r\n\r\n  /**\r\n   * Get the style manager (for testing)\r\n   */\r\n  getStyleManager(): StyleManager | null {\r\n    return this.styleManager;\r\n  }\r\n\r\n  /**\r\n   * Get the content root element (for testing)\r\n   */\r\n  getContentRoot(): HTMLElement | null {\r\n    return this.contentRoot;\r\n  }\r\n\r\n  /**\r\n   * Get the telemetry tracker (for testing and debugging)\r\n   */\r\n  getTelemetryTracker(): TelemetryTracker {\r\n    return this.telemetryTracker;\r\n  }\r\n}\r\n","/**\r\n * Auto-initialization logic for widgets embedded via script tag\r\n */\r\n\r\nimport { Widget } from './widget';\r\nimport { parseWidgetConfig, validateConfig } from './config';\r\nimport type { WidgetConfig } from '../types';\r\n\r\n/**\r\n * Parse configuration from data attributes on script tag or container\r\n */\r\nfunction parseConfig(element: HTMLScriptElement | HTMLElement): WidgetConfig {\r\n  const config = parseWidgetConfig(element);\r\n  \r\n  // Validate the configuration\r\n  if (!validateConfig(config)) {\r\n    throw new Error('[TrestaWidget] Invalid widget configuration');\r\n  }\r\n  \r\n  return config;\r\n}\r\n\r\n/**\r\n * Find container for widget\r\n */\r\nfunction findContainer(script: HTMLScriptElement, widgetId: string): HTMLElement {\r\n  const containerSelector = script.getAttribute('data-container');\r\n  \r\n  if (containerSelector) {\r\n    const container = document.querySelector(containerSelector);\r\n    if (!container) {\r\n      throw new Error(`[TrestaWidget] Container not found: ${containerSelector}`);\r\n    }\r\n    return container as HTMLElement;\r\n  }\r\n\r\n  // Look for div with matching widget ID\r\n  const defaultContainer = document.getElementById(`tresta-widget-${widgetId}`);\r\n  if (defaultContainer) {\r\n    return defaultContainer;\r\n  }\r\n\r\n  // Create container inline after script tag\r\n  const container = document.createElement('div');\r\n  container.id = `tresta-widget-${widgetId}`;\r\n  script.parentNode?.insertBefore(container, script.nextSibling);\r\n  \r\n  return container;\r\n}\r\n\r\n/**\r\n * Initialize a single widget from a script tag\r\n */\r\nfunction initializeWidget(script: HTMLScriptElement): void {\r\n  try {\r\n    const config = parseConfig(script);\r\n    const container = findContainer(script, config.widgetId);\r\n    \r\n    // Check if already initialized\r\n    const existingInstance = Widget.getInstance(container);\r\n    if (existingInstance) {\r\n      if (config.debug) {\r\n        console.debug(`[TrestaWidget v${config.version || '1.0.0'}] Widget ${config.widgetId} already initialized in container`);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Create and mount new widget instance\r\n    const widget = new Widget(config);\r\n    widget.mount(container);\r\n  } catch (error) {\r\n    console.error('[TrestaWidget] Failed to initialize widget:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Auto-initialize all widgets on the page\r\n */\r\nexport function autoInitialize(): void {\r\n  try {\r\n    const scripts = document.querySelectorAll(\r\n      'script[data-widget-id], script[data-tresta-widget]'\r\n    );\r\n    \r\n    if (scripts.length === 0) {\r\n      // No widgets to initialize\r\n      return;\r\n    }\r\n\r\n    // Initialize each widget independently\r\n    scripts.forEach((script) => {\r\n      initializeWidget(script as HTMLScriptElement);\r\n    });\r\n  } catch (error) {\r\n    console.error('[TrestaWidget] Auto-initialization failed:', error);\r\n  }\r\n}\r\n","/**\r\n * Configuration parser and validator\r\n */\r\n\r\nimport type { WidgetConfig, ThemeConfig } from '../types';\r\nimport { ThemeManager } from '../styles/theme-manager';\r\n\r\nfunction getWidgetId(element: HTMLElement): string | null {\r\n  return (\r\n    element.getAttribute('data-widget-id') ||\r\n    element.getAttribute('data-tresta-widget')\r\n  );\r\n}\r\n\r\nexport function parseWidgetConfig(element: HTMLElement): Partial<WidgetConfig> {\r\n  const widgetId = getWidgetId(element);\r\n  const apiKey = element.getAttribute('data-api-key');\r\n  const version = element.getAttribute('data-version');\r\n  const apiUrl = element.getAttribute('data-api-url');\r\n  const nonce = element.getAttribute('nonce');\r\n  \r\n  const config: Partial<WidgetConfig> = {\r\n    debug: element.getAttribute('data-debug') === 'true',\r\n    telemetry: element.getAttribute('data-telemetry') !== 'false',\r\n  };\r\n\r\n  if (widgetId) {\r\n    config.widgetId = widgetId;\r\n  }\r\n\r\n  if (apiKey) {\r\n    config.apiKey = apiKey;\r\n  }\r\n\r\n  if (version) {\r\n    config.version = version;\r\n  } else {\r\n    config.version = '1.0.0';\r\n  }\r\n\r\n  if (apiUrl) {\r\n    config.apiUrl = apiUrl;\r\n  }\r\n\r\n  if (nonce) {\r\n    config.nonce = nonce;\r\n  }\r\n\r\n  // Parse theme configuration from data attributes\r\n  const themeConfig = ThemeManager.parseThemeFromElement(element);\r\n  if (Object.keys(themeConfig).length > 0) {\r\n    config.theme = themeConfig as ThemeConfig;\r\n  }\r\n\r\n  return config;\r\n}\r\n\r\nexport function validateConfig(config: Partial<WidgetConfig>): config is WidgetConfig {\r\n  if (!config.widgetId) {\r\n    throw new Error('[TrestaWidget] widgetId is required');\r\n  }\r\n  if (!config.apiKey) {\r\n    throw new Error('[TrestaWidget] apiKey is required');\r\n  }\r\n  return true;\r\n}\r\n","/**\r\n * Tresta Widget - CDN-delivered testimonial widget system\r\n * @version 1.0.0\r\n */\r\n\r\nimport { Widget } from './core/widget';\r\nimport { autoInitialize } from './core/loader';\r\nimport type { WidgetConfig, WidgetInstance } from './types';\r\n\r\n// Expose global API\r\nexport const TrestaWidget = {\r\n  /**\r\n   * Programmatically mount a widget instance\r\n   * @param element - Container element or CSS selector\r\n   * @param config - Widget configuration\r\n   * @returns Widget instance\r\n   */\r\n  async mount(element: string | HTMLElement, config: WidgetConfig): Promise<WidgetInstance> {\r\n    const container = typeof element === 'string' \r\n      ? document.querySelector(element) \r\n      : element;\r\n    \r\n    if (!container) {\r\n      throw new Error(`[TrestaWidget] Container not found: ${element}`);\r\n    }\r\n\r\n    const widget = new Widget(config);\r\n    await widget.mount(container as HTMLElement);\r\n    return widget;\r\n  },\r\n\r\n  /**\r\n   * Unmount a widget instance\r\n   * @param element - Container element or CSS selector\r\n   */\r\n  unmount(element: string | HTMLElement): void {\r\n    const container = typeof element === 'string' \r\n      ? document.querySelector(element) \r\n      : element;\r\n    \r\n    if (!container) {\r\n      console.warn(`[TrestaWidget] Container not found: ${element}`);\r\n      return;\r\n    }\r\n\r\n    // Get the widget instance and unmount it properly\r\n    const instance = Widget.getInstance(container as HTMLElement);\r\n    if (instance) {\r\n      instance.unmount();\r\n    } else {\r\n      console.warn(`[TrestaWidget] No widget instance found in container`);\r\n    }\r\n  },\r\n\r\n  version: '1.0.0',\r\n};\r\n\r\n// Auto-initialize widgets on page load\r\nif (typeof window !== 'undefined') {\r\n  // Expose to global scope\r\n  (window as any).TrestaWidget = TrestaWidget;\r\n  \r\n  // Initialize when DOM is ready\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', autoInitialize);\r\n  } else {\r\n    // DOM is already ready, initialize immediately\r\n    autoInitialize();\r\n  }\r\n}\r\n\r\nexport { Widget };\r\nexport type { WidgetConfig, WidgetInstance };\r\n"],"names":["WidgetErrorCode","WidgetError","Error","constructor","code","message","recoverable","super","this","name","ThemeManager","config","__publicField","theme","getDefaultTheme","debug","console","log","mode","primaryColor","secondaryColor","cardStyle","applyTheme","root","applyThemeMode","applyColors","applyFontFamily","applyCardStyle","effectiveMode","detectPreferredColorScheme","setAttribute","window","matchMedia","matches","style","setProperty","fontFamily","fontFamilyWithFallback","updateTheme","getTheme","parseThemeFromElement","element","getAttribute","BASE_STYLES","trim","StyleManager","useShadowDOM","detectShadowDOMSupport","nonceApplier","themeConfig","themeManager","Element","prototype","initializeStyles","container","initializeShadowDOM","initializeNamespacedCSS","shadowRoot","attachShadow","styleElement","document","createElement","applyNonce","textContent","getShadowDOMStyles","appendChild","contentWrapper","classList","add","getElementById","id","getNamespacedStyles","head","namespacedStyles","replace","cleanup","getThemeManager","isShadowDOM","getShadowRoot","NetworkClient","addRequestInterceptor","interceptor","requestInterceptors","push","addResponseInterceptor","responseInterceptors","request","url","options","modifiedUrl","modifiedOptions","result","response","async","method","headers","body","timeout","controller","AbortController","timeoutId","setTimeout","abort","fetchOptions","signal","credentials","JSON","stringify","fetch","data","clearTimeout","contentType","get","includes","json","text","status","error","API_TIMEOUT","TypeError","NETWORK_ERROR","fetchWithTimeout","DEFAULT_RETRY_CONFIG","maxRetries","baseDelay","maxDelay","jitter","calculateDelay","attempt","exponentialDelay","Math","pow","random","min","sleep","ms","Promise","resolve","isRetryableError","retryableCodes","API_ERROR","DEFAULT_RATE_LIMITER_CONFIG","maxRequests","windowMs","RateLimiter","Map","isAllowed","key","now","Date","record","getOrCreateRecord","timestamps","filter","timestamp","length","getRetryAfter","records","oldestTimestamp","retryAfter","max","reset","delete","resetAll","clear","getRequestCount","set","updateConfig","getConfig","Logger","widgetId","version","debugEnabled","args","info","warn","logEmpty","isDebugEnabled","getWidgetId","getVersion","DEFAULT_API_CLIENT_CONFIG","baseURL","APIClient","apiKey","logger","networkClient","rateLimiter","fetchWidgetData","UNAUTHORIZED","ceil","RATE_LIMITED","fn","retryConfig","lastError","delay","round","retry","substring","Authorization","rawData","handleResponse","transformApiResponse","errorMessage","apiResponse","widget","errorDetails","hasData","hasWidget","PARSE_ERROR","testimonialCount","testimonials","settings","layoutType","layout","maxTestimonials","autoRotate","rotateInterval","showNavigation","columns","type","display","showRating","showDate","showAvatar","showAuthorRole","showAuthorCompany","map","t","content","rating","createdAt","isPublished","isApproved","isOAuthVerified","oauthProvider","author","authorName","email","avatar","authorAvatar","role","authorRole","company","authorCompany","media","videoUrl","INVALID_WIDGET_ID","retryAfterHeader","parseInt","getNetworkClient","getRateLimiter","STORE_NAME","IndexedDBAdapter","isAvailable","available","reject","indexedDB","open","onerror","onsuccess","onupgradeneeded","createObjectStore","close","deleteDatabase","getDB","dbPromise","event","db","target","objectStoreNames","contains","keyPath","createIndex","unique","transaction","objectStore","entry","expiresAt","catch","_key","value","put","clearExpired","index","range","IDBKeyRange","upperBound","openCursor","cursor","continue","STORAGE_PREFIX","LocalStorageAdapter","testKey","localStorage","setItem","removeItem","storageKey","item","getItem","parse","serialized","DOMException","retryError","keysToRemove","i","startsWith","forEach","parseError","DEFAULT_TTL","StorageManager","init","initPromise","indexedDBAdapter","adapter","localStorageAdapter","getAdapter","getCacheKey","getTTL","ttl","createErrorState","className","TelemetrySampler","samplingRate","shouldSample","setSamplingRate","rate","getSamplingRate","TelemetryTracker","telemetryDisabled","enabled","dntEnabled","isDNTEnabled","endpoint","sampler","navigator","dnt","doNotTrack","msDoNotTrack","startLoadTracking","loadStartTime","performance","trackLoad","loadTime","eventType","send","trackError","errorCode","currentCount","errorCounts","trackInteraction","getTelemetryData","count","sendBeacon","blob","Blob","keepalive","isEnabled","disable","enable","TestimonialCard","testimonial","displayOptions","render","card","renderHeader","renderRating","renderContent","renderDate","innerHTML","join","parts","renderAvatar","escapeHtml","renderVerificationBadge","avatarUrl","provider","fullStars","floor","hasHalfStar","emptyStars","stars","renderStar","fillClass","formattedDate","formatDate","dateString","date","isNaN","getTime","year","month","day","toLocaleDateString","div","Carousel","layoutConfig","carousel","emptyState","track","slide","renderSlide","instructions","renderNavigationButtons","renderDotIndicators","setupEventListeners","startAutoRotate","updateSlidePosition","nav","prevButton","addEventListener","previous","nextButton","next","indicators","_","dot","goToSlide","e","handleTouchStart","passive","handleTouchEnd","pause","resume","handleKeyDown","touch","touches","touchStartX","clientX","changedTouches","touchEndX","handleSwipe","diff","abs","preventDefault","isTransitioning","currentIndex","animate","querySelector","slides","querySelectorAll","dots","offset","transform","transition","isActive","remove","interval","autoRotateTimer","setInterval","isPaused","stopAutoRotate","clearInterval","destroy","clonedContainer","cloneNode","parentNode","replaceChild","Grid","grid","toString","renderItem","_Masonry","masonry","queueSpanCalculation","setupResizeObserver","ResizeObserver","resizeObserver","entries","applyRowSpan","contentRect","height","observe","measuredHeight","getBoundingClientRect","Number","rowSpan","GRID_ROW_UNIT","gridRowEnd","requestAnimationFrame","disconnect","Masonry","Wall","wall","shouldBeFeatured","isPositionFeatured","isHighRated","isVerified","List","list","LayoutEngine","create","sortByCreatedAtDesc","sort","a","b","dateA","DEFAULT_ALLOWED_DOMAINS","CSPValidator","allowedDomains","reportViolations","setupViolationListener","validateURL","hostname","URL","some","domain","endsWith","validateResources","violations","img","src","script","iframe","link","href","valid","detectStrictCSP","meta","getNonce","nonce","scripts","Array","from","tagName","getViolations","clearViolations","blockedURI","isWidgetRelated","violatedDirective","directive","sourceFile","widgetInstances","WeakMap","Widget","state","mounted","loading","apiClientConfig","apiUrl","apiClient","storageManager","telemetryTracker","telemetry","cspConfig","cspValidator","mount","has","existingWidget","unmount","generateInstanceId","lang","styleManager","contentRoot","liveRegion","fetchAndRender","logError","renderErrorState","announceToScreenReader","fetchWithFallback","cached","hasContentRoot","widgetData","renderEmptyState","limitedTestimonials","limit","slice","limitTestimonials","currentLayout","layoutElement","cspResult","errorState","emptyMessage","context","cleanupEventListeners","removeChild","refresh","getState","eventListeners","handler","removeEventListener","priority","getInstance","getStyleManager","getContentRoot","getTelemetryTracker","initializeWidget","Object","keys","parseWidgetConfig","validateConfig","parseConfig","containerSelector","defaultContainer","insertBefore","nextSibling","findContainer","autoInitialize","TrestaWidget","instance","readyState"],"mappings":"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"}