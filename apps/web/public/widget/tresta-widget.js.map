{"version":3,"file":"tresta-widget.js","sources":["../src/types/index.ts","../src/styles/theme-manager.ts","../src/styles/style-manager.ts","../src/api/network.ts","../src/api/retry.ts","../src/api/rate-limiter.ts","../src/utils/logger.ts","../src/api/client.ts","../src/storage/indexeddb.ts","../src/storage/localstorage.ts","../src/storage/cache-manager.ts","../src/components/error-state.ts","../src/telemetry/sampler.ts","../src/telemetry/tracker.ts","../src/components/testimonial-card.ts","../src/layouts/carousel.ts","../src/layouts/grid.ts","../src/layouts/masonry.ts","../src/layouts/wall.ts","../src/layouts/list.ts","../src/layouts/index.ts","../src/utils/testimonial-limiter.ts","../src/security/csp-validator.ts","../src/core/widget.ts","../src/core/loader.ts","../src/core/config.ts","../src/index.ts"],"sourcesContent":["/**\r\n * Core type definitions for the Tresta Widget System\r\n */\r\n\r\nexport interface WidgetConfig {\r\n  widgetId: string;\r\n  apiKey: string;\r\n  container?: string | HTMLElement;\r\n  debug?: boolean;\r\n  telemetry?: boolean;\r\n  version?: string;\r\n  theme?: ThemeConfig;\r\n  errorMessage?: string;\r\n  emptyMessage?: string;\r\n  apiUrl?: string;\r\n  lang?: string; // Language code for localization (e.g., 'en', 'es', 'fr')\r\n  useShadowDOM?: boolean; // Whether to use Shadow DOM for style isolation (default: true)\r\n}\r\n\r\nexport interface WidgetInstance {\r\n  mount(container: HTMLElement): Promise<void>;\r\n  unmount(): void;\r\n  refresh(): Promise<void>;\r\n  getState(): WidgetState;\r\n}\r\n\r\nexport interface WidgetState {\r\n  mounted: boolean;\r\n  loading: boolean;\r\n  error: Error | null;\r\n  data: WidgetData | null;\r\n}\r\n\r\nexport interface WidgetData {\r\n  widgetId: string;\r\n  config: WidgetDisplayConfig;\r\n  testimonials: Testimonial[];\r\n}\r\n\r\nexport interface WidgetDisplayConfig {\r\n  layout: LayoutConfig;\r\n  theme: ThemeConfig;\r\n  display: DisplayOptions;\r\n}\r\n\r\nexport interface LayoutConfig {\r\n  type: 'carousel' | 'grid' | 'masonry' | 'wall' | 'list';\r\n  maxTestimonials?: number;\r\n  autoRotate?: boolean;\r\n  rotateInterval?: number;\r\n  showNavigation?: boolean;\r\n  columns?: number;\r\n}\r\n\r\nexport interface ThemeConfig {\r\n  mode: 'light' | 'dark' | 'auto';\r\n  primaryColor: string;\r\n  secondaryColor: string;\r\n  fontFamily?: string;\r\n  cardStyle: 'default' | 'minimal' | 'bordered';\r\n}\r\n\r\nexport interface DisplayOptions {\r\n  showRating: boolean;\r\n  showDate: boolean;\r\n  showAvatar: boolean;\r\n  showAuthorRole: boolean;\r\n  showAuthorCompany: boolean;\r\n  maxTestimonials?: number;\r\n}\r\n\r\nexport interface Testimonial {\r\n  id: string;\r\n  content: string;\r\n  rating: number;\r\n  createdAt: string;\r\n  isPublished: boolean;\r\n  isApproved: boolean;\r\n  isOAuthVerified: boolean;\r\n  oauthProvider?: string;\r\n  author: {\r\n    name: string;\r\n    email?: string;\r\n    avatar?: string;\r\n    role?: string;\r\n    company?: string;\r\n  };\r\n  media?: {\r\n    type: 'image' | 'video';\r\n    url: string;\r\n    thumbnail?: string;\r\n  };\r\n}\r\n\r\nexport enum WidgetErrorCode {\r\n  INVALID_WIDGET_ID = 'INVALID_WIDGET_ID',\r\n  API_TIMEOUT = 'API_TIMEOUT',\r\n  API_ERROR = 'API_ERROR',\r\n  NETWORK_ERROR = 'NETWORK_ERROR',\r\n  RATE_LIMITED = 'RATE_LIMITED',\r\n  UNAUTHORIZED = 'UNAUTHORIZED',\r\n  PARSE_ERROR = 'PARSE_ERROR',\r\n  RENDER_ERROR = 'RENDER_ERROR',\r\n}\r\n\r\nexport class WidgetError extends Error {\r\n  constructor(\r\n    public code: WidgetErrorCode,\r\n    message: string,\r\n    public recoverable: boolean = true\r\n  ) {\r\n    super(message);\r\n    this.name = 'WidgetError';\r\n  }\r\n}\r\n","/**\r\n * Theme Manager - Handles theme configuration and CSS custom properties\r\n */\r\n\r\nimport type { ThemeConfig } from '../types';\r\n\r\nexport interface ThemeManagerConfig {\r\n  theme?: ThemeConfig;\r\n  debug?: boolean;\r\n}\r\n\r\nexport class ThemeManager {\r\n  private theme: ThemeConfig;\r\n  private debug: boolean;\r\n\r\n  constructor(config: ThemeManagerConfig = {}) {\r\n    this.theme = config.theme ?? this.getDefaultTheme();\r\n    this.debug = config.debug ?? false;\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] ThemeManager initialized with theme:', this.theme);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get default theme configuration\r\n   */\r\n  private getDefaultTheme(): ThemeConfig {\r\n    return {\r\n      mode: 'light',\r\n      primaryColor: '#3b82f6',\r\n      secondaryColor: '#64748b',\r\n      cardStyle: 'default',\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Apply theme to a root element\r\n   */\r\n  applyTheme(root: HTMLElement): void {\r\n    // Apply theme mode\r\n    this.applyThemeMode(root);\r\n\r\n    // Apply colors\r\n    this.applyColors(root);\r\n\r\n    // Apply font family\r\n    this.applyFontFamily(root);\r\n\r\n    // Apply card style\r\n    this.applyCardStyle(root);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Theme applied to root element');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply theme mode (light/dark/auto)\r\n   */\r\n  private applyThemeMode(root: HTMLElement): void {\r\n    let effectiveMode = this.theme.mode;\r\n\r\n    // Handle auto mode\r\n    if (effectiveMode === 'auto') {\r\n      effectiveMode = this.detectPreferredColorScheme();\r\n    }\r\n\r\n    root.setAttribute('data-theme', effectiveMode);\r\n  }\r\n\r\n  /**\r\n   * Detect user's preferred color scheme\r\n   */\r\n  private detectPreferredColorScheme(): 'light' | 'dark' {\r\n    if (typeof window !== 'undefined' && window.matchMedia) {\r\n      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;\r\n      return prefersDark ? 'dark' : 'light';\r\n    }\r\n    return 'light';\r\n  }\r\n\r\n  /**\r\n   * Apply primary and secondary colors via CSS custom properties\r\n   */\r\n  private applyColors(root: HTMLElement): void {\r\n    root.style.setProperty('--tresta-primary-color', this.theme.primaryColor);\r\n    root.style.setProperty('--tresta-secondary-color', this.theme.secondaryColor);\r\n  }\r\n\r\n  /**\r\n   * Apply custom font family with fallback\r\n   */\r\n  private applyFontFamily(root: HTMLElement): void {\r\n    if (this.theme.fontFamily) {\r\n      // Add fallback fonts for better compatibility\r\n      const fontFamilyWithFallback = `${this.theme.fontFamily}, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;\r\n      root.style.setProperty('--tresta-font-family', fontFamilyWithFallback);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply card style\r\n   */\r\n  private applyCardStyle(root: HTMLElement): void {\r\n    root.setAttribute('data-card-style', this.theme.cardStyle);\r\n  }\r\n\r\n  /**\r\n   * Update theme configuration\r\n   */\r\n  updateTheme(theme: Partial<ThemeConfig>): void {\r\n    this.theme = {\r\n      ...this.theme,\r\n      ...theme,\r\n    };\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Theme updated:', this.theme);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current theme configuration\r\n   */\r\n  getTheme(): ThemeConfig {\r\n    return { ...this.theme };\r\n  }\r\n\r\n  /**\r\n   * Parse theme configuration from data attributes\r\n   */\r\n  static parseThemeFromElement(element: HTMLElement): Partial<ThemeConfig> {\r\n    const theme: Partial<ThemeConfig> = {};\r\n\r\n    // Parse theme mode\r\n    const mode = element.getAttribute('data-theme-mode');\r\n    if (mode === 'light' || mode === 'dark' || mode === 'auto') {\r\n      theme.mode = mode;\r\n    }\r\n\r\n    // Parse primary color\r\n    const primaryColor = element.getAttribute('data-primary-color');\r\n    if (primaryColor) {\r\n      theme.primaryColor = primaryColor;\r\n    }\r\n\r\n    // Parse secondary color\r\n    const secondaryColor = element.getAttribute('data-secondary-color');\r\n    if (secondaryColor) {\r\n      theme.secondaryColor = secondaryColor;\r\n    }\r\n\r\n    // Parse font family\r\n    const fontFamily = element.getAttribute('data-font-family');\r\n    if (fontFamily) {\r\n      theme.fontFamily = fontFamily;\r\n    }\r\n\r\n    // Parse card style\r\n    const cardStyle = element.getAttribute('data-card-style');\r\n    if (cardStyle === 'default' || cardStyle === 'minimal' || cardStyle === 'bordered') {\r\n      theme.cardStyle = cardStyle;\r\n    }\r\n\r\n    return theme;\r\n  }\r\n}\r\n","/**\r\n * Style Manager - Handles Shadow DOM and CSS isolation\r\n */\r\n\r\nimport baseStyles from './base.css?inline';\r\nimport testimonialCardStyles from '../components/testimonial-card.css?inline';\r\nimport errorStateStyles from '../components/error-state.css?inline';\r\nimport listStyles from '../layouts/list.css?inline';\r\nimport gridStyles from '../layouts/grid.css?inline';\r\nimport masonryStyles from '../layouts/masonry.css?inline';\r\nimport wallStyles from '../layouts/wall.css?inline';\r\nimport carouselStyles from '../layouts/carousel.css?inline';\r\nimport { ThemeManager, type ThemeManagerConfig } from './theme-manager';\r\n\r\n// Combine all styles\r\nconst BASE_STYLES = `\r\n${baseStyles}\r\n\r\n${testimonialCardStyles}\r\n\r\n${errorStateStyles}\r\n\r\n${listStyles}\r\n\r\n${gridStyles}\r\n\r\n${masonryStyles}\r\n\r\n${wallStyles}\r\n\r\n${carouselStyles}\r\n`.trim();\r\n\r\nexport interface StyleManagerConfig {\r\n  useShadowDOM?: boolean;\r\n  debug?: boolean;\r\n  theme?: ThemeManagerConfig['theme'];\r\n}\r\n\r\nexport class StyleManager {\r\n  private shadowRoot: ShadowRoot | null = null;\r\n  private useShadowDOM: boolean;\r\n  private debug: boolean;\r\n  private themeManager: ThemeManager;\r\n\r\n  constructor(config: StyleManagerConfig = {}) {\r\n    this.useShadowDOM = config.useShadowDOM ?? this.detectShadowDOMSupport();\r\n    this.debug = config.debug ?? false;\r\n    \r\n    const themeConfig: ThemeManagerConfig = { debug: this.debug };\r\n    if (config.theme) {\r\n      themeConfig.theme = config.theme;\r\n    }\r\n    this.themeManager = new ThemeManager(themeConfig);\r\n\r\n    if (this.debug) {\r\n      console.log(`[TrestaWidget] StyleManager initialized with Shadow DOM: ${this.useShadowDOM}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Detect if Shadow DOM is supported\r\n   */\r\n  private detectShadowDOMSupport(): boolean {\r\n    return 'attachShadow' in Element.prototype;\r\n  }\r\n\r\n  /**\r\n   * Initialize styles for the widget\r\n   * Returns the root element where content should be rendered\r\n   */\r\n  initializeStyles(container: HTMLElement): HTMLElement {\r\n    if (this.useShadowDOM) {\r\n      return this.initializeShadowDOM(container);\r\n    } else {\r\n      return this.initializeNamespacedCSS(container);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize Shadow DOM with encapsulated styles\r\n   */\r\n  private initializeShadowDOM(container: HTMLElement): HTMLElement {\r\n    // Attach shadow root\r\n    this.shadowRoot = container.attachShadow({ mode: 'open' });\r\n\r\n    // Create style element\r\n    const styleElement = document.createElement('style');\r\n    styleElement.textContent = this.getShadowDOMStyles();\r\n    this.shadowRoot.appendChild(styleElement);\r\n\r\n    // Create content wrapper\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.setAttribute('data-tresta-widget-root', 'true');\r\n    contentWrapper.setAttribute('data-tresta-widget', 'true');\r\n    this.shadowRoot.appendChild(contentWrapper);\r\n\r\n    // Apply theme\r\n    this.themeManager.applyTheme(contentWrapper);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Shadow DOM initialized');\r\n    }\r\n\r\n    return contentWrapper;\r\n  }\r\n\r\n  /**\r\n   * Initialize namespaced CSS fallback for older browsers\r\n   */\r\n  private initializeNamespacedCSS(container: HTMLElement): HTMLElement {\r\n    // Add namespaced class to container\r\n    container.classList.add('tresta-widget');\r\n\r\n    // Inject namespaced styles if not already present\r\n    if (!document.getElementById('tresta-widget-styles')) {\r\n      const styleElement = document.createElement('style');\r\n      styleElement.id = 'tresta-widget-styles';\r\n      styleElement.textContent = this.getNamespacedStyles();\r\n      document.head.appendChild(styleElement);\r\n    }\r\n\r\n    // Create content wrapper\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.setAttribute('data-tresta-widget-root', 'true');\r\n    contentWrapper.setAttribute('data-tresta-widget', 'true');\r\n    contentWrapper.classList.add('tresta-widget-root');\r\n    container.appendChild(contentWrapper);\r\n\r\n    // Apply theme\r\n    this.themeManager.applyTheme(contentWrapper);\r\n\r\n    if (this.debug) {\r\n      console.log('[TrestaWidget] Namespaced CSS initialized');\r\n    }\r\n\r\n    return contentWrapper;\r\n  }\r\n\r\n  /**\r\n   * Get styles for Shadow DOM (no namespacing needed)\r\n   */\r\n  private getShadowDOMStyles(): string {\r\n    return BASE_STYLES;\r\n  }\r\n\r\n  /**\r\n   * Get namespaced styles for fallback mode\r\n   */\r\n  private getNamespacedStyles(): string {\r\n    // Transform base styles to be namespaced\r\n    // Replace :root with .tresta-widget\r\n    // Replace [data-tresta-widget] with .tresta-widget-root\r\n    let namespacedStyles = BASE_STYLES\r\n      .replace(/:root\\s*{/g, '.tresta-widget {')\r\n      .replace(/\\[data-tresta-widget\\]/g, '.tresta-widget-root');\r\n\r\n    // Add high specificity to prevent host page overrides\r\n    namespacedStyles = `.tresta-widget { all: initial; }\\n${namespacedStyles}`;\r\n\r\n    return namespacedStyles;\r\n  }\r\n\r\n  /**\r\n   * Clean up styles\r\n   */\r\n  cleanup(): void {\r\n    this.shadowRoot = null;\r\n    \r\n    // Note: We don't remove the global style element in namespaced mode\r\n    // because other widget instances might be using it\r\n  }\r\n\r\n  /**\r\n   * Get the theme manager\r\n   */\r\n  getThemeManager(): ThemeManager {\r\n    return this.themeManager;\r\n  }\r\n\r\n  /**\r\n   * Check if Shadow DOM is being used\r\n   */\r\n  isShadowDOM(): boolean {\r\n    return this.useShadowDOM;\r\n  }\r\n\r\n  /**\r\n   * Get the shadow root (if using Shadow DOM)\r\n   */\r\n  getShadowRoot(): ShadowRoot | null {\r\n    return this.shadowRoot;\r\n  }\r\n}\r\n","/**\r\n * Network layer with fetch and timeout support\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\nimport type { RequestOptions, APIResponse } from './types';\r\n\r\n/**\r\n * Create a fetch request with timeout support\r\n */\r\nexport async function fetchWithTimeout<T>(\r\n  url: string,\r\n  options: RequestOptions = {}\r\n): Promise<APIResponse<T>> {\r\n  const {\r\n    method = 'GET',\r\n    headers = {},\r\n    body,\r\n    timeout = 10000, // 10 second default timeout\r\n  } = options;\r\n\r\n  // Create an AbortController for timeout\r\n  const controller = new AbortController();\r\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n  try {\r\n    const fetchOptions: RequestInit = {\r\n      method,\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        ...headers,\r\n      },\r\n      signal: controller.signal,\r\n      credentials: 'omit', // Never send credentials (withCredentials: false)\r\n    };\r\n\r\n    if (body && method !== 'GET') {\r\n      fetchOptions.body = JSON.stringify(body);\r\n    }\r\n\r\n    const response = await fetch(url, fetchOptions);\r\n\r\n    clearTimeout(timeoutId);\r\n\r\n    // Parse response\r\n    let data: T;\r\n    const contentType = response.headers.get('content-type');\r\n    \r\n    if (contentType && contentType.includes('application/json')) {\r\n      data = await response.json();\r\n    } else {\r\n      data = (await response.text()) as unknown as T;\r\n    }\r\n\r\n    return {\r\n      data,\r\n      status: response.status,\r\n      headers: response.headers,\r\n    };\r\n  } catch (error) {\r\n    clearTimeout(timeoutId);\r\n\r\n    // Handle abort (timeout)\r\n    if (error instanceof Error && error.name === 'AbortError') {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.API_TIMEOUT,\r\n        `Request timed out after ${timeout}ms`,\r\n        true\r\n      );\r\n    }\r\n\r\n    // Handle network errors\r\n    if (error instanceof TypeError) {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.NETWORK_ERROR,\r\n        'Network request failed. Please check your connection.',\r\n        true\r\n      );\r\n    }\r\n\r\n    // Re-throw other errors\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Request interceptor - can be used to modify requests before sending\r\n */\r\nexport type RequestInterceptor = (\r\n  url: string,\r\n  options: RequestOptions\r\n) => { url: string; options: RequestOptions } | Promise<{ url: string; options: RequestOptions }>;\r\n\r\n/**\r\n * Response interceptor - can be used to modify responses after receiving\r\n */\r\nexport type ResponseInterceptor = <T>(\r\n  response: APIResponse<T>\r\n) => APIResponse<T> | Promise<APIResponse<T>>;\r\n\r\n/**\r\n * Network client with interceptor support\r\n */\r\nexport class NetworkClient {\r\n  private requestInterceptors: RequestInterceptor[] = [];\r\n  private responseInterceptors: ResponseInterceptor[] = [];\r\n\r\n  /**\r\n   * Add a request interceptor\r\n   */\r\n  addRequestInterceptor(interceptor: RequestInterceptor): void {\r\n    this.requestInterceptors.push(interceptor);\r\n  }\r\n\r\n  /**\r\n   * Add a response interceptor\r\n   */\r\n  addResponseInterceptor(interceptor: ResponseInterceptor): void {\r\n    this.responseInterceptors.push(interceptor);\r\n  }\r\n\r\n  /**\r\n   * Execute a request with interceptors\r\n   */\r\n  async request<T>(url: string, options: RequestOptions = {}): Promise<APIResponse<T>> {\r\n    // Apply request interceptors\r\n    let modifiedUrl = url;\r\n    let modifiedOptions = options;\r\n\r\n    for (const interceptor of this.requestInterceptors) {\r\n      const result = await interceptor(modifiedUrl, modifiedOptions);\r\n      modifiedUrl = result.url;\r\n      modifiedOptions = result.options;\r\n    }\r\n\r\n    // Execute request\r\n    let response = await fetchWithTimeout<T>(modifiedUrl, modifiedOptions);\r\n\r\n    // Apply response interceptors\r\n    for (const interceptor of this.responseInterceptors) {\r\n      response = await interceptor(response);\r\n    }\r\n\r\n    return response;\r\n  }\r\n}\r\n","/**\r\n * Retry logic with exponential backoff and jitter\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\n\r\nexport interface RetryConfig {\r\n  maxRetries: number;\r\n  baseDelay: number; // Base delay in milliseconds\r\n  maxDelay: number; // Maximum delay in milliseconds\r\n  jitter: number; // Jitter in milliseconds\r\n}\r\n\r\nconst DEFAULT_RETRY_CONFIG: RetryConfig = {\r\n  maxRetries: 3,\r\n  baseDelay: 1000, // 1 second\r\n  maxDelay: 10000, // 10 seconds\r\n  jitter: 1000, // 1 second\r\n};\r\n\r\n/**\r\n * Calculate delay with exponential backoff and jitter\r\n * Formula: delay = base * 2^attempt + random(0, jitter)\r\n */\r\nfunction calculateDelay(attempt: number, config: RetryConfig): number {\r\n  const exponentialDelay = config.baseDelay * Math.pow(2, attempt);\r\n  const jitter = Math.random() * config.jitter;\r\n  const delay = Math.min(exponentialDelay + jitter, config.maxDelay);\r\n  return delay;\r\n}\r\n\r\n/**\r\n * Sleep for a specified duration\r\n */\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((resolve) => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Determine if an error is retryable\r\n */\r\nfunction isRetryableError(error: unknown): boolean {\r\n  if (error instanceof WidgetError) {\r\n    // Only retry if the error is marked as recoverable\r\n    // Retryable error codes: API_TIMEOUT, NETWORK_ERROR, API_ERROR\r\n    // Note: RATE_LIMITED is NOT retried - it should fail immediately\r\n    const retryableCodes = [\r\n      WidgetErrorCode.API_TIMEOUT,\r\n      WidgetErrorCode.NETWORK_ERROR,\r\n      WidgetErrorCode.API_ERROR,\r\n    ];\r\n    return error.recoverable && retryableCodes.includes(error.code);\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Retry a function with exponential backoff\r\n */\r\nexport async function retry<T>(\r\n  fn: () => Promise<T>,\r\n  config: Partial<RetryConfig> = {}\r\n): Promise<T> {\r\n  const retryConfig = { ...DEFAULT_RETRY_CONFIG, ...config };\r\n  let lastError: unknown;\r\n\r\n  for (let attempt = 0; attempt < retryConfig.maxRetries; attempt++) {\r\n    try {\r\n      return await fn();\r\n    } catch (error) {\r\n      lastError = error;\r\n\r\n      // Check if we should retry\r\n      if (!isRetryableError(error)) {\r\n        throw error;\r\n      }\r\n\r\n      // Check if we've exhausted retries\r\n      if (attempt === retryConfig.maxRetries - 1) {\r\n        throw error;\r\n      }\r\n\r\n      // Calculate delay and wait\r\n      const delay = calculateDelay(attempt, retryConfig);\r\n      \r\n      if (error instanceof WidgetError) {\r\n        console.warn(\r\n          `[TrestaWidget] Request failed (attempt ${attempt + 1}/${retryConfig.maxRetries}): ${error.message}. Retrying in ${Math.round(delay)}ms...`\r\n        );\r\n      }\r\n\r\n      await sleep(delay);\r\n    }\r\n  }\r\n\r\n  // This should never be reached, but TypeScript needs it\r\n  throw lastError;\r\n}\r\n\r\n/**\r\n * Retry helper class for more complex retry scenarios\r\n */\r\nexport class RetryHelper {\r\n  private config: RetryConfig;\r\n\r\n  constructor(config: Partial<RetryConfig> = {}) {\r\n    this.config = { ...DEFAULT_RETRY_CONFIG, ...config };\r\n  }\r\n\r\n  /**\r\n   * Execute a function with retry logic\r\n   */\r\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\r\n    return retry(fn, this.config);\r\n  }\r\n\r\n  /**\r\n   * Update retry configuration\r\n   */\r\n  updateConfig(config: Partial<RetryConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): RetryConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * Rate limiter for client-side throttling\r\n * Implements 100 requests per minute per widgetId\r\n */\r\n\r\nexport interface RateLimiterConfig {\r\n  maxRequests: number; // Maximum requests per window\r\n  windowMs: number; // Time window in milliseconds\r\n}\r\n\r\nconst DEFAULT_RATE_LIMITER_CONFIG: RateLimiterConfig = {\r\n  maxRequests: 100,\r\n  windowMs: 60000, // 1 minute\r\n};\r\n\r\ninterface RequestRecord {\r\n  timestamps: number[];\r\n}\r\n\r\n/**\r\n * Rate limiter using sliding window algorithm\r\n */\r\nexport class RateLimiter {\r\n  private config: RateLimiterConfig;\r\n  private records: Map<string, RequestRecord> = new Map();\r\n\r\n  constructor(config: Partial<RateLimiterConfig> = {}) {\r\n    this.config = { ...DEFAULT_RATE_LIMITER_CONFIG, ...config };\r\n  }\r\n\r\n  /**\r\n   * Check if a request is allowed for the given key (widgetId)\r\n   * Returns true if allowed, false if rate limited\r\n   */\r\n  isAllowed(key: string): boolean {\r\n    const now = Date.now();\r\n    const record = this.getOrCreateRecord(key);\r\n\r\n    // Remove timestamps outside the current window\r\n    record.timestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    // Check if we're under the limit\r\n    if (record.timestamps.length < this.config.maxRequests) {\r\n      record.timestamps.push(now);\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Get the time until the next request is allowed (in milliseconds)\r\n   * Returns 0 if a request is currently allowed\r\n   */\r\n  getRetryAfter(key: string): number {\r\n    const now = Date.now();\r\n    const record = this.records.get(key);\r\n\r\n    if (!record || record.timestamps.length === 0) {\r\n      return 0;\r\n    }\r\n\r\n    // Remove timestamps outside the current window\r\n    record.timestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    // If we're under the limit, no wait needed\r\n    if (record.timestamps.length < this.config.maxRequests) {\r\n      return 0;\r\n    }\r\n\r\n    // Calculate when the oldest request will expire\r\n    const oldestTimestamp = record.timestamps[0];\r\n    if (!oldestTimestamp) {\r\n      return 0;\r\n    }\r\n    \r\n    const retryAfter = oldestTimestamp + this.config.windowMs - now;\r\n\r\n    return Math.max(0, retryAfter);\r\n  }\r\n\r\n  /**\r\n   * Reset rate limit for a specific key\r\n   */\r\n  reset(key: string): void {\r\n    this.records.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Reset all rate limits\r\n   */\r\n  resetAll(): void {\r\n    this.records.clear();\r\n  }\r\n\r\n  /**\r\n   * Get current request count for a key\r\n   */\r\n  getRequestCount(key: string): number {\r\n    const now = Date.now();\r\n    const record = this.records.get(key);\r\n\r\n    if (!record) {\r\n      return 0;\r\n    }\r\n\r\n    // Filter to only count requests in current window\r\n    const validTimestamps = record.timestamps.filter(\r\n      (timestamp) => now - timestamp < this.config.windowMs\r\n    );\r\n\r\n    return validTimestamps.length;\r\n  }\r\n\r\n  /**\r\n   * Get or create a record for a key\r\n   */\r\n  private getOrCreateRecord(key: string): RequestRecord {\r\n    let record = this.records.get(key);\r\n\r\n    if (!record) {\r\n      record = { timestamps: [] };\r\n      this.records.set(key, record);\r\n    }\r\n\r\n    return record;\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  updateConfig(config: Partial<RateLimiterConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): RateLimiterConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * Centralized logging utility with debug mode support\r\n * \r\n * In production builds, console.debug calls are automatically removed by Terser\r\n * via the drop_console configuration in vite.config.ts\r\n */\r\n\r\nconst WIDGET_VERSION = '1.0.0';\r\n\r\nexport class Logger {\r\n  private widgetId: string;\r\n  private version: string;\r\n  private debugEnabled: boolean;\r\n\r\n  constructor(widgetId: string, version: string = WIDGET_VERSION, debugEnabled: boolean = false) {\r\n    this.widgetId = widgetId;\r\n    this.version = version;\r\n    this.debugEnabled = debugEnabled;\r\n  }\r\n\r\n  /**\r\n   * Log debug messages (only in debug mode, tree-shaken in production)\r\n   */\r\n  debug(message: string, ...args: any[]): void {\r\n    if (this.debugEnabled) {\r\n      console.debug(`[TrestaWidget v${this.version}]`, message, ...args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log info messages (always shown)\r\n   */\r\n  info(message: string, ...args: any[]): void {\r\n    console.log(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log warning messages (always shown)\r\n   */\r\n  warn(message: string, ...args: any[]): void {\r\n    console.warn(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log error messages (always shown)\r\n   */\r\n  error(message: string, ...args: any[]): void {\r\n    console.error(`[TrestaWidget v${this.version}]`, message, ...args);\r\n  }\r\n\r\n  /**\r\n   * Log empty state (special case for requirement 20.4)\r\n   */\r\n  logEmpty(): void {\r\n    if (this.debugEnabled) {\r\n      console.debug(`[TrestaWidget v${this.version}] empty`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if debug mode is enabled\r\n   */\r\n  isDebugEnabled(): boolean {\r\n    return this.debugEnabled;\r\n  }\r\n\r\n  /**\r\n   * Get the widget ID\r\n   */\r\n  getWidgetId(): string {\r\n    return this.widgetId;\r\n  }\r\n\r\n  /**\r\n   * Get the version\r\n   */\r\n  getVersion(): string {\r\n    return this.version;\r\n  }\r\n}\r\n","/**\r\n * API Client with retry logic, rate limiting, and error handling\r\n */\r\n\r\nimport { WidgetError, WidgetErrorCode } from '../types';\r\nimport type { WidgetData } from '../types';\r\nimport { NetworkClient } from './network';\r\nimport { retry } from './retry';\r\nimport { RateLimiter } from './rate-limiter';\r\nimport type { APIClientConfig } from './types';\r\nimport { Logger } from '../utils/logger';\r\n\r\nconst DEFAULT_API_CLIENT_CONFIG: APIClientConfig = {\r\n  baseURL: 'https://api.tresta.com',\r\n  timeout: 10000, // 10 seconds\r\n  maxRetries: 3,\r\n};\r\n\r\n/**\r\n * API Client for fetching widget data\r\n */\r\nexport class APIClient {\r\n  private config: APIClientConfig;\r\n  private networkClient: NetworkClient;\r\n  private rateLimiter: RateLimiter;\r\n  private apiKey: string | undefined;\r\n  private logger: Logger | null = null;\r\n\r\n  constructor(config: Partial<APIClientConfig> = {}, apiKey?: string, logger?: Logger) {\r\n    this.config = { ...DEFAULT_API_CLIENT_CONFIG, ...config };\r\n    this.networkClient = new NetworkClient();\r\n    this.rateLimiter = new RateLimiter({\r\n      maxRequests: 100,\r\n      windowMs: 60000, // 100 requests per minute\r\n    });\r\n    this.apiKey = apiKey;\r\n    this.logger = logger || null;\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data from the API\r\n   */\r\n  async fetchWidgetData(widgetId: string): Promise<WidgetData> {\r\n    // Check if API key is provided\r\n    if (!this.apiKey) {\r\n      throw new WidgetError(\r\n        WidgetErrorCode.UNAUTHORIZED,\r\n        'API key is required. Please provide an API key.',\r\n        false\r\n      );\r\n    }\r\n\r\n    // Check rate limit\r\n    if (!this.rateLimiter.isAllowed(widgetId)) {\r\n      const retryAfter = this.rateLimiter.getRetryAfter(widgetId);\r\n      const message = `Rate limit exceeded for widget ${widgetId}. Retry after ${Math.ceil(retryAfter / 1000)}s`;\r\n      if (this.logger) {\r\n        this.logger.warn(message);\r\n      } else {\r\n        console.warn(`[TrestaWidget] ${message}`);\r\n      }\r\n      throw new WidgetError(\r\n        WidgetErrorCode.RATE_LIMITED,\r\n        `Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 1000)} seconds.`,\r\n        true\r\n      );\r\n    }\r\n\r\n    // Fetch with retry logic\r\n    return retry(\r\n      async () => {\r\n        const url = `${this.config.baseURL}/api/widgets/${widgetId}/public`;\r\n\r\n        if (this.logger) {\r\n          this.logger.debug(`Fetching widget data from: ${url}`);\r\n          this.logger.debug(`Using API key: ${this.apiKey?.substring(0, 15)}...`);\r\n        }\r\n\r\n        try {\r\n          const response = await this.networkClient.request<any>(url, {\r\n            method: 'GET',\r\n            timeout: this.config.timeout,\r\n            headers: {\r\n              'Authorization': `Bearer ${this.apiKey}`,\r\n              'Content-Type': 'application/json',\r\n            },\r\n          });\r\n\r\n          if (this.logger) {\r\n            this.logger.debug('Received response:', response.status);\r\n          }\r\n\r\n          // Handle HTTP status codes and transform response\r\n          const rawData = this.handleResponse(response, widgetId);\r\n\r\n          // Transform the API response to match WidgetData interface\r\n          return this.transformApiResponse(rawData);\r\n        } catch (error) {\r\n          // Re-throw WidgetErrors as-is\r\n          if (error instanceof WidgetError) {\r\n            throw error;\r\n          }\r\n\r\n          // Wrap unknown errors\r\n          const errorMessage = `Unexpected error for widget ${widgetId}:`;\r\n          if (this.logger) {\r\n            this.logger.error(errorMessage, error);\r\n          } else {\r\n            console.error(`[TrestaWidget] ${errorMessage}`, error);\r\n          }\r\n          throw new WidgetError(\r\n            WidgetErrorCode.API_ERROR,\r\n            'An unexpected error occurred while fetching widget data',\r\n            true\r\n          );\r\n        }\r\n      },\r\n      { maxRetries: this.config.maxRetries }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Transform API response to WidgetData format\r\n   */\r\n  private transformApiResponse(apiResponse: any): WidgetData {\r\n    if (this.logger) {\r\n      this.logger.debug('Raw API response:', apiResponse);\r\n    }\r\n    \r\n    // Handle both direct data and wrapped response formats\r\n    const data = apiResponse.data || apiResponse;\r\n\r\n    if (!data || !data.widget) {\r\n      const errorDetails = { hasData: !!data, hasWidget: !!(data?.widget) };\r\n      if (this.logger) {\r\n        this.logger.error('Invalid API response structure:', errorDetails);\r\n      } else {\r\n        console.error('[TrestaWidget] Invalid API response structure:', errorDetails);\r\n      }\r\n      throw new WidgetError(\r\n        WidgetErrorCode.PARSE_ERROR,\r\n        'Invalid API response format',\r\n        false\r\n      );\r\n    }\r\n\r\n    if (this.logger) {\r\n      this.logger.debug('Transforming widget data:', {\r\n        widgetId: data.widget.id,\r\n        testimonialCount: data.testimonials?.length || 0,\r\n      });\r\n    }\r\n\r\n    // Transform to WidgetData format\r\n    return {\r\n      widgetId: data.widget.id,\r\n      config: {\r\n        layout: {\r\n          type: data.widget.layout || 'grid',\r\n          maxTestimonials: data.widget.settings?.maxTestimonials,\r\n          autoRotate: data.widget.settings?.autoRotate,\r\n          rotateInterval: data.widget.settings?.rotateInterval,\r\n          showNavigation: true,\r\n          columns: data.widget.settings?.columns,\r\n        },\r\n        theme: {\r\n          mode: data.widget.settings?.theme || 'light',\r\n          primaryColor: data.widget.theme?.primaryColor || '#0066FF',\r\n          secondaryColor: data.widget.theme?.secondaryColor || '#00CC99',\r\n          fontFamily: data.widget.settings?.fontFamily,\r\n          cardStyle: data.widget.settings?.cardStyle || 'default',\r\n        },\r\n        display: {\r\n          showRating: data.widget.settings?.showRating ?? true,\r\n          showDate: data.widget.settings?.showDate ?? true,\r\n          showAvatar: data.widget.settings?.showAvatar ?? true,\r\n          showAuthorRole: data.widget.settings?.showAuthorRole ?? true,\r\n          showAuthorCompany: data.widget.settings?.showAuthorCompany ?? true,\r\n          maxTestimonials: data.widget.settings?.maxTestimonials,\r\n        },\r\n      },\r\n      testimonials: (data.testimonials || []).map((t: any) => ({\r\n        id: t.id,\r\n        content: t.content,\r\n        rating: t.rating,\r\n        createdAt: t.createdAt,\r\n        isPublished: true,\r\n        isApproved: true,\r\n        isOAuthVerified: t.isOAuthVerified || false,\r\n        oauthProvider: t.oauthProvider,\r\n        author: {\r\n          name: t.authorName,\r\n          email: undefined, // Never expose email\r\n          avatar: t.authorAvatar,\r\n          role: t.authorRole,\r\n          company: t.authorCompany,\r\n        },\r\n        media: t.videoUrl ? {\r\n          type: 'video' as const,\r\n          url: t.videoUrl,\r\n        } : undefined,\r\n      })),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle API response based on status code\r\n   */\r\n  private handleResponse<T>(\r\n    response: { data: T; status: number; headers: Headers },\r\n    widgetId: string\r\n  ): T {\r\n    const { data, status, headers } = response;\r\n\r\n    // Success responses (2xx)\r\n    if (status >= 200 && status < 300) {\r\n      return data;\r\n    }\r\n\r\n    // Handle specific error status codes\r\n    switch (status) {\r\n      case 401:\r\n      case 403: {\r\n        const message = `Unauthorized access for widget ${widgetId} (${status})`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.UNAUTHORIZED,\r\n          'Unable to load testimonials. Please check your widget configuration.',\r\n          false // Not recoverable\r\n        );\r\n      }\r\n\r\n      case 404: {\r\n        const message = `Widget ${widgetId} not found (404)`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.INVALID_WIDGET_ID,\r\n          'Widget not found. Please check your widget ID.',\r\n          false // Not recoverable\r\n        );\r\n      }\r\n\r\n      case 429: {\r\n        // Rate limited by server\r\n        const retryAfterHeader = headers.get('Retry-After');\r\n        const retryAfter = retryAfterHeader\r\n          ? parseInt(retryAfterHeader, 10) * 1000\r\n          : 60000; // Default to 60 seconds\r\n\r\n        const message = `Server rate limit for widget ${widgetId}. Retry after ${retryAfter / 1000}s`;\r\n        if (this.logger) {\r\n          this.logger.warn(message);\r\n        } else {\r\n          console.warn(`[TrestaWidget] ${message}`);\r\n        }\r\n\r\n        throw new WidgetError(\r\n          WidgetErrorCode.RATE_LIMITED,\r\n          `Rate limit exceeded. Please try again in ${Math.ceil(retryAfter / 1000)} seconds.`,\r\n          true // Recoverable with retry\r\n        );\r\n      }\r\n\r\n      case 500:\r\n      case 502:\r\n      case 503:\r\n      case 504: {\r\n        const message = `Server error for widget ${widgetId} (${status})`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.API_ERROR,\r\n          'Server error. Please try again later.',\r\n          true // Recoverable with retry\r\n        );\r\n      }\r\n\r\n      default: {\r\n        const message = `Unexpected status code ${status} for widget ${widgetId}`;\r\n        if (this.logger) {\r\n          this.logger.error(message);\r\n        } else {\r\n          console.error(`[TrestaWidget] ${message}`);\r\n        }\r\n        throw new WidgetError(\r\n          WidgetErrorCode.API_ERROR,\r\n          `Unexpected error (${status}). Please try again later.`,\r\n          status >= 500 // 5xx errors are recoverable\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the network client (for testing/advanced usage)\r\n   */\r\n  getNetworkClient(): NetworkClient {\r\n    return this.networkClient;\r\n  }\r\n\r\n  /**\r\n   * Get the rate limiter (for testing/advanced usage)\r\n   */\r\n  getRateLimiter(): RateLimiter {\r\n    return this.rateLimiter;\r\n  }\r\n\r\n  /**\r\n   * Update configuration\r\n   */\r\n  updateConfig(config: Partial<APIClientConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n  }\r\n\r\n  /**\r\n   * Get current configuration\r\n   */\r\n  getConfig(): APIClientConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n","/**\r\n * IndexedDB storage adapter\r\n */\r\n\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\n\r\nconst DB_NAME = 'tresta-widget-cache';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'testimonials';\r\n\r\nexport class IndexedDBAdapter implements StorageAdapter {\r\n  private dbPromise: Promise<IDBDatabase> | null = null;\r\n  private available: boolean | null = null;\r\n\r\n  /**\r\n   * Check if IndexedDB is available (handles private browsing mode)\r\n   */\r\n  async isAvailable(): Promise<boolean> {\r\n    if (this.available !== null) {\r\n      return this.available;\r\n    }\r\n\r\n    try {\r\n      // Immediate detection of IndexedDB unavailability\r\n      if (!('indexedDB' in window)) {\r\n        this.available = false;\r\n        return false;\r\n      }\r\n\r\n      // Test if we can actually open a database (private browsing check)\r\n      const testDB = await new Promise<IDBDatabase>((resolve, reject) => {\r\n        const request = indexedDB.open('__test__', 1);\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve(request.result);\r\n        request.onupgradeneeded = () => {\r\n          // Create a test store\r\n          request.result.createObjectStore('test');\r\n        };\r\n      });\r\n\r\n      testDB.close();\r\n      indexedDB.deleteDatabase('__test__');\r\n      \r\n      this.available = true;\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('[TrestaWidget] IndexedDB unavailable, will use localStorage fallback:', error);\r\n      this.available = false;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or create the database connection\r\n   */\r\n  private async getDB(): Promise<IDBDatabase> {\r\n    if (this.dbPromise) {\r\n      return this.dbPromise;\r\n    }\r\n\r\n    this.dbPromise = new Promise((resolve, reject) => {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n      request.onerror = () => {\r\n        reject(new Error(`Failed to open IndexedDB: ${request.error}`));\r\n      };\r\n\r\n      request.onsuccess = () => {\r\n        resolve(request.result);\r\n      };\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        const db = (event.target as IDBOpenDBRequest).result;\r\n        \r\n        // Create object store if it doesn't exist\r\n        if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n          const store = db.createObjectStore(STORE_NAME, { keyPath: 'widgetId' });\r\n          // Create index on expiresAt for efficient cleanup\r\n          store.createIndex('expiresAt', 'expiresAt', { unique: false });\r\n        }\r\n      };\r\n    });\r\n\r\n    return this.dbPromise;\r\n  }\r\n\r\n  /**\r\n   * Get a cache entry by key\r\n   */\r\n  async get(key: string): Promise<CacheEntry | null> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readonly');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.get(key);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => {\r\n          const entry = request.result as CacheEntry | undefined;\r\n          \r\n          // Check if entry is expired\r\n          if (entry && entry.expiresAt < Date.now()) {\r\n            // Delete expired entry asynchronously\r\n            this.delete(key).catch(() => {\r\n              // Ignore deletion errors\r\n            });\r\n            resolve(null);\r\n          } else {\r\n            resolve(entry || null);\r\n          }\r\n        };\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a cache entry\r\n   */\r\n  async set(_key: string, value: CacheEntry): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.put(value);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB set error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a cache entry\r\n   */\r\n  async delete(key: string): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.delete(key);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB delete error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cache entries\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const request = store.clear();\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = () => resolve();\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB clear error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const db = await this.getDB();\r\n      const now = Date.now();\r\n      \r\n      return new Promise((resolve, reject) => {\r\n        const transaction = db.transaction([STORE_NAME], 'readwrite');\r\n        const store = transaction.objectStore(STORE_NAME);\r\n        const index = store.index('expiresAt');\r\n        \r\n        // Get all entries with expiresAt < now\r\n        const range = IDBKeyRange.upperBound(now);\r\n        const request = index.openCursor(range);\r\n\r\n        request.onerror = () => reject(request.error);\r\n        request.onsuccess = (event) => {\r\n          const cursor = (event.target as IDBRequest<IDBCursorWithValue>).result;\r\n          if (cursor) {\r\n            cursor.delete();\r\n            cursor.continue();\r\n          } else {\r\n            resolve();\r\n          }\r\n        };\r\n      });\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] IndexedDB clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * localStorage storage adapter (fallback)\r\n */\r\n\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\n\r\nconst STORAGE_PREFIX = 'tresta-widget-';\r\n\r\nexport class LocalStorageAdapter implements StorageAdapter {\r\n  private available: boolean | null = null;\r\n\r\n  /**\r\n   * Check if localStorage is available\r\n   */\r\n  async isAvailable(): Promise<boolean> {\r\n    if (this.available !== null) {\r\n      return this.available;\r\n    }\r\n\r\n    try {\r\n      const testKey = '__tresta_test__';\r\n      localStorage.setItem(testKey, 'test');\r\n      localStorage.removeItem(testKey);\r\n      this.available = true;\r\n      return true;\r\n    } catch (error) {\r\n      console.warn('[TrestaWidget] localStorage unavailable:', error);\r\n      this.available = false;\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a cache entry by key\r\n   */\r\n  async get(key: string): Promise<CacheEntry | null> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      const item = localStorage.getItem(storageKey);\r\n      \r\n      if (!item) {\r\n        return null;\r\n      }\r\n\r\n      const entry = JSON.parse(item) as CacheEntry;\r\n      \r\n      // Check if entry is expired\r\n      if (entry.expiresAt < Date.now()) {\r\n        // Delete expired entry\r\n        await this.delete(key);\r\n        return null;\r\n      }\r\n\r\n      return entry;\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a cache entry\r\n   */\r\n  async set(key: string, value: CacheEntry): Promise<void> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      const serialized = JSON.stringify(value);\r\n      localStorage.setItem(storageKey, serialized);\r\n    } catch (error) {\r\n      // Handle quota exceeded error\r\n      if (error instanceof DOMException && \r\n          (error.name === 'QuotaExceededError' || error.name === 'NS_ERROR_DOM_QUOTA_REACHED')) {\r\n        console.warn('[TrestaWidget] localStorage quota exceeded, clearing old entries');\r\n        await this.clearExpired();\r\n        \r\n        // Try again after cleanup\r\n        try {\r\n          const storageKey = STORAGE_PREFIX + key;\r\n          const serialized = JSON.stringify(value);\r\n          localStorage.setItem(storageKey, serialized);\r\n        } catch (retryError) {\r\n          console.error('[TrestaWidget] localStorage set error after cleanup:', retryError);\r\n          throw retryError;\r\n        }\r\n      } else {\r\n        console.error('[TrestaWidget] localStorage set error:', error);\r\n        throw error;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete a cache entry\r\n   */\r\n  async delete(key: string): Promise<void> {\r\n    try {\r\n      const storageKey = STORAGE_PREFIX + key;\r\n      localStorage.removeItem(storageKey);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage delete error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cache entries\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const keysToRemove: string[] = [];\r\n      \r\n      // Find all keys with our prefix\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith(STORAGE_PREFIX)) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n\r\n      // Remove all matching keys\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage clear error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const now = Date.now();\r\n      const keysToRemove: string[] = [];\r\n      \r\n      // Find all expired entries\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith(STORAGE_PREFIX)) {\r\n          try {\r\n            const item = localStorage.getItem(key);\r\n            if (item) {\r\n              const entry = JSON.parse(item) as CacheEntry;\r\n              if (entry.expiresAt < now) {\r\n                keysToRemove.push(key);\r\n              }\r\n            }\r\n          } catch (parseError) {\r\n            // If we can't parse it, remove it\r\n            keysToRemove.push(key);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Remove expired keys\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] localStorage clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Cache manager with IndexedDB and localStorage fallback\r\n */\r\n\r\nimport type { WidgetData } from '../types';\r\nimport type { CacheEntry, StorageAdapter } from './types';\r\nimport { IndexedDBAdapter } from './indexeddb';\r\nimport { LocalStorageAdapter } from './localstorage';\r\n\r\nconst DEFAULT_TTL = 24 * 60 * 60 * 1000; // 24 hours\r\nconst LOCALSTORAGE_TTL = 60 * 60 * 1000; // 1 hour (reduced for localStorage)\r\n\r\nexport class StorageManager {\r\n  private adapter: StorageAdapter | null = null;\r\n  private initPromise: Promise<void> | null = null;\r\n\r\n  /**\r\n   * Initialize the storage adapter\r\n   */\r\n  private async init(): Promise<void> {\r\n    if (this.initPromise) {\r\n      return this.initPromise;\r\n    }\r\n\r\n    this.initPromise = (async () => {\r\n      // Try IndexedDB first\r\n      const indexedDBAdapter = new IndexedDBAdapter();\r\n      if (await indexedDBAdapter.isAvailable()) {\r\n        this.adapter = indexedDBAdapter;\r\n        console.log('[TrestaWidget] Using IndexedDB for caching');\r\n        \r\n        // Clear expired entries on initialization (don't await to avoid blocking)\r\n        this.clearExpired().catch(() => {\r\n          // Ignore cleanup errors\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Fall back to localStorage\r\n      const localStorageAdapter = new LocalStorageAdapter();\r\n      if (await localStorageAdapter.isAvailable()) {\r\n        this.adapter = localStorageAdapter;\r\n        console.log('[TrestaWidget] Using localStorage for caching (IndexedDB unavailable)');\r\n        \r\n        // Clear expired entries on initialization (don't await to avoid blocking)\r\n        this.clearExpired().catch(() => {\r\n          // Ignore cleanup errors\r\n        });\r\n        return;\r\n      }\r\n\r\n      // No storage available\r\n      console.warn('[TrestaWidget] No storage available, caching disabled');\r\n      this.adapter = null;\r\n    })();\r\n\r\n    return this.initPromise;\r\n  }\r\n\r\n  /**\r\n   * Get the current adapter\r\n   */\r\n  private async getAdapter(): Promise<StorageAdapter | null> {\r\n    await this.init();\r\n    return this.adapter;\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for a widget ID\r\n   */\r\n  private getCacheKey(widgetId: string): string {\r\n    return `tresta-widget-${widgetId}`;\r\n  }\r\n\r\n  /**\r\n   * Get TTL based on adapter type\r\n   */\r\n  private getTTL(): number {\r\n    if (this.adapter instanceof IndexedDBAdapter) {\r\n      return DEFAULT_TTL;\r\n    } else if (this.adapter instanceof LocalStorageAdapter) {\r\n      return LOCALSTORAGE_TTL;\r\n    }\r\n    return DEFAULT_TTL;\r\n  }\r\n\r\n  /**\r\n   * Get cached widget data\r\n   */\r\n  async get(widgetId: string): Promise<WidgetData | null> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return null;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      const entry = await adapter.get(key);\r\n      \r\n      if (!entry) {\r\n        return null;\r\n      }\r\n\r\n      return entry.data;\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache get error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set cached widget data\r\n   */\r\n  async set(widgetId: string, data: WidgetData, ttl?: number): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      const now = Date.now();\r\n      const effectiveTTL = ttl ?? this.getTTL();\r\n\r\n      const entry: CacheEntry = {\r\n        widgetId,\r\n        data,\r\n        timestamp: now,\r\n        expiresAt: now + effectiveTTL,\r\n      };\r\n\r\n      await adapter.set(key, entry);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache set error:', error);\r\n      // Don't throw - caching is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Delete cached widget data\r\n   */\r\n  async delete(widgetId: string): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      const key = this.getCacheKey(widgetId);\r\n      await adapter.delete(key);\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache delete error:', error);\r\n      // Don't throw - deletion is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all cached data\r\n   */\r\n  async clear(): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      await adapter.clear();\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache clear error:', error);\r\n      // Don't throw - clearing is best effort\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  async clearExpired(): Promise<void> {\r\n    try {\r\n      const adapter = await this.getAdapter();\r\n      if (!adapter) {\r\n        return;\r\n      }\r\n\r\n      if ('clearExpired' in adapter && typeof adapter.clearExpired === 'function') {\r\n        await adapter.clearExpired();\r\n      }\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Cache clearExpired error:', error);\r\n      // Don't throw - cleanup is best effort\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Error and Empty State Components\r\n * Provides user-friendly UI for error and empty states with ARIA support\r\n */\r\n\r\nexport interface ErrorStateConfig {\r\n  message?: string;\r\n  type: 'error' | 'empty';\r\n  widgetId?: string;\r\n  version?: string;\r\n}\r\n\r\n/**\r\n * Create an error state component\r\n */\r\nexport function createErrorState(config: ErrorStateConfig): HTMLElement {\r\n  const container = document.createElement('div');\r\n  container.className = `tresta-widget-${config.type}-state`;\r\n  \r\n  // Use 'alert' role for errors (assertive) and 'status' for empty state (polite)\r\n  if (config.type === 'error') {\r\n    container.setAttribute('role', 'alert');\r\n    container.setAttribute('aria-live', 'assertive');\r\n  } else {\r\n    container.setAttribute('role', 'status');\r\n    container.setAttribute('aria-live', 'polite');\r\n  }\r\n  \r\n  container.setAttribute('aria-atomic', 'true');\r\n\r\n  const message = document.createElement('p');\r\n  message.className = 'tresta-widget-state-message';\r\n  \r\n  // Use custom message or default based on type\r\n  if (config.message) {\r\n    message.textContent = config.message;\r\n  } else if (config.type === 'error') {\r\n    message.textContent = 'Unable to load testimonials. Please try again later.';\r\n  } else {\r\n    message.textContent = 'No testimonials yet';\r\n  }\r\n\r\n  container.appendChild(message);\r\n\r\n  return container;\r\n}\r\n\r\n/**\r\n * Create an empty state component\r\n */\r\nexport function createEmptyState(message?: string): HTMLElement {\r\n  return createErrorState({\r\n    type: 'empty',\r\n    ...(message && { message }),\r\n  });\r\n}\r\n","/**\r\n * Sampling logic for telemetry\r\n */\r\n\r\nexport class TelemetrySampler {\r\n  private samplingRate: number;\r\n\r\n  constructor(samplingRate: number = 0.01) {\r\n    // Default to 1% sampling\r\n    this.samplingRate = Math.max(0, Math.min(1, samplingRate));\r\n  }\r\n\r\n  /**\r\n   * Determine if this event should be sampled\r\n   */\r\n  shouldSample(): boolean {\r\n    return Math.random() < this.samplingRate;\r\n  }\r\n\r\n  /**\r\n   * Update the sampling rate\r\n   */\r\n  setSamplingRate(rate: number): void {\r\n    this.samplingRate = Math.max(0, Math.min(1, rate));\r\n  }\r\n\r\n  /**\r\n   * Get the current sampling rate\r\n   */\r\n  getSamplingRate(): number {\r\n    return this.samplingRate;\r\n  }\r\n}\r\n","/**\r\n * Telemetry tracker - collects anonymous usage and performance metrics\r\n * \r\n * Privacy-first design:\r\n * - No PII collected\r\n * - Respects DNT (Do Not Track)\r\n * - 1% sampling by default\r\n * - Opt-out via data-telemetry=\"false\"\r\n */\r\n\r\nimport type { TelemetryEvent, TelemetryConfig, TelemetryData } from './types';\r\nimport { TelemetrySampler } from './sampler';\r\n\r\nexport class TelemetryTracker {\r\n  private config: TelemetryConfig;\r\n  private sampler: TelemetrySampler;\r\n  private errorCounts: Map<string, number> = new Map();\r\n  private loadStartTime: number = 0;\r\n  private widgetId: string;\r\n  private version: string;\r\n  private layoutType?: string;\r\n\r\n  constructor(\r\n    widgetId: string,\r\n    version: string,\r\n    config: Partial<TelemetryConfig> = {}\r\n  ) {\r\n    this.widgetId = widgetId;\r\n    this.version = version;\r\n\r\n    // Check if telemetry is disabled\r\n    const telemetryDisabled = config.enabled === false;\r\n    const dntEnabled = this.isDNTEnabled();\r\n\r\n    this.config = {\r\n      enabled: !telemetryDisabled && !dntEnabled,\r\n      samplingRate: config.samplingRate ?? 0.01, // Default 1%\r\n      endpoint: config.endpoint ?? 'https://api.tresta.com/telemetry',\r\n    };\r\n\r\n    this.sampler = new TelemetrySampler(this.config.samplingRate);\r\n  }\r\n\r\n  /**\r\n   * Check if Do Not Track is enabled\r\n   */\r\n  private isDNTEnabled(): boolean {\r\n    // Check navigator.doNotTrack\r\n    if (typeof navigator !== 'undefined') {\r\n      const dnt = (navigator as any).doNotTrack || (window as any).doNotTrack || (navigator as any).msDoNotTrack;\r\n      \r\n      // DNT can be \"1\", \"yes\", or true\r\n      if (dnt === '1' || dnt === 'yes' || dnt === true) {\r\n        return true;\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Start tracking widget load time\r\n   */\r\n  startLoadTracking(): void {\r\n    if (!this.config.enabled) return;\r\n    this.loadStartTime = performance.now();\r\n  }\r\n\r\n  /**\r\n   * Track successful widget load\r\n   */\r\n  trackLoad(layoutType?: string): void {\r\n    if (!this.config.enabled) return;\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    this.layoutType = layoutType || 'unknown';\r\n    const loadTime = this.loadStartTime > 0 ? performance.now() - this.loadStartTime : 0;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'load',\r\n      loadTime: Math.round(loadTime),\r\n      layoutType: layoutType || 'unknown',\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Track an error\r\n   */\r\n  trackError(errorCode: string): void {\r\n    if (!this.config.enabled) return;\r\n\r\n    // Always track error counts locally (not sampled)\r\n    const currentCount = this.errorCounts.get(errorCode) || 0;\r\n    this.errorCounts.set(errorCode, currentCount + 1);\r\n\r\n    // Only send error events if sampled\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'error',\r\n      errorCode,\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Track an interaction\r\n   */\r\n  trackInteraction(layoutType?: string): void {\r\n    if (!this.config.enabled) return;\r\n    if (!this.sampler.shouldSample()) return;\r\n\r\n    const event: TelemetryEvent = {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      eventType: 'interaction',\r\n      layoutType: layoutType || this.layoutType || 'unknown',\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    this.send(event);\r\n  }\r\n\r\n  /**\r\n   * Get telemetry data summary (for debugging)\r\n   */\r\n  getTelemetryData(): TelemetryData {\r\n    const loadTime = this.loadStartTime > 0 ? performance.now() - this.loadStartTime : 0;\r\n    \r\n    const errorCounts: Record<string, number> = {};\r\n    this.errorCounts.forEach((count, code) => {\r\n      errorCounts[code] = count;\r\n    });\r\n\r\n    return {\r\n      widgetId: this.widgetId,\r\n      version: this.version,\r\n      loadTime: Math.round(loadTime),\r\n      layoutType: this.layoutType || 'unknown',\r\n      errorCounts,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Send telemetry event to server (non-blocking)\r\n   */\r\n  private send(event: TelemetryEvent): void {\r\n    if (!this.config.enabled || !this.config.endpoint) return;\r\n\r\n    // Use sendBeacon if available (non-blocking, survives page unload)\r\n    if (typeof navigator !== 'undefined' && navigator.sendBeacon) {\r\n      try {\r\n        const blob = new Blob([JSON.stringify(event)], { type: 'application/json' });\r\n        navigator.sendBeacon(this.config.endpoint, blob);\r\n      } catch (error) {\r\n        // Silently fail - telemetry should never break the widget\r\n        console.debug('[TrestaWidget] Telemetry sendBeacon failed:', error);\r\n      }\r\n    } else {\r\n      // Fallback to fetch with keepalive\r\n      try {\r\n        fetch(this.config.endpoint, {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n          },\r\n          body: JSON.stringify(event),\r\n          keepalive: true,\r\n          // No credentials - this is anonymous telemetry\r\n          credentials: 'omit',\r\n        }).catch(() => {\r\n          // Silently fail - telemetry should never break the widget\r\n        });\r\n      } catch (error) {\r\n        // Silently fail - telemetry should never break the widget\r\n        console.debug('[TrestaWidget] Telemetry fetch failed:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if telemetry is enabled\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.config.enabled;\r\n  }\r\n\r\n  /**\r\n   * Update sampling rate (for per-account settings)\r\n   */\r\n  setSamplingRate(rate: number): void {\r\n    this.config.samplingRate = rate;\r\n    this.sampler.setSamplingRate(rate);\r\n  }\r\n\r\n  /**\r\n   * Disable telemetry\r\n   */\r\n  disable(): void {\r\n    this.config.enabled = false;\r\n  }\r\n\r\n  /**\r\n   * Enable telemetry (respects DNT)\r\n   */\r\n  enable(): void {\r\n    if (!this.isDNTEnabled()) {\r\n      this.config.enabled = true;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * TestimonialCard Component\r\n * \r\n * Renders a single testimonial card with configurable display options.\r\n * Supports star ratings, OAuth verification badges, lazy-loaded avatars,\r\n * and date formatting.\r\n */\r\n\r\nimport type { Testimonial, DisplayOptions, ThemeConfig } from '../types';\r\n\r\nexport interface TestimonialCardConfig {\r\n  testimonial: Testimonial;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class TestimonialCard {\r\n  private testimonial: Testimonial;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: TestimonialCardConfig) {\r\n    this.testimonial = config.testimonial;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the testimonial card as an HTML element\r\n   */\r\n  render(): HTMLElement {\r\n    const card = document.createElement('article');\r\n    card.className = 'tresta-testimonial-card';\r\n    card.setAttribute('data-testimonial-id', this.testimonial.id);\r\n    card.style.setProperty('--primary-color', this.theme.primaryColor);\r\n    card.style.setProperty('--secondary-color', this.theme.secondaryColor);\r\n\r\n    // Apply card style class\r\n    card.classList.add(`card-style-${this.theme.cardStyle}`);\r\n\r\n    // Build card content\r\n    const content: string[] = [];\r\n\r\n    // Header section (avatar, name, role, company, verification)\r\n    content.push(this.renderHeader());\r\n\r\n    // Rating section\r\n    if (this.displayOptions.showRating && this.testimonial.rating > 0) {\r\n      content.push(this.renderRating());\r\n    }\r\n\r\n    // Testimonial content\r\n    content.push(this.renderContent());\r\n\r\n    // Date section\r\n    if (this.displayOptions.showDate) {\r\n      content.push(this.renderDate());\r\n    }\r\n\r\n    card.innerHTML = content.join('');\r\n\r\n    return card;\r\n  }\r\n\r\n  /**\r\n   * Renders the card header with avatar, author info, and verification badge\r\n   */\r\n  private renderHeader(): string {\r\n    const parts: string[] = ['<div class=\"tresta-card-header\">'];\r\n\r\n    // Avatar\r\n    if (this.displayOptions.showAvatar && this.testimonial.author.avatar) {\r\n      parts.push(this.renderAvatar());\r\n    }\r\n\r\n    // Author info container\r\n    parts.push('<div class=\"tresta-author-info\">');\r\n\r\n    // Author name with verification badge\r\n    parts.push('<div class=\"tresta-author-name-row\">');\r\n    parts.push(`<span class=\"tresta-author-name\">${this.escapeHtml(this.testimonial.author.name)}</span>`);\r\n    \r\n    if (this.testimonial.isOAuthVerified && this.testimonial.oauthProvider) {\r\n      parts.push(this.renderVerificationBadge());\r\n    }\r\n    \r\n    parts.push('</div>');\r\n\r\n    // Author role\r\n    if (this.displayOptions.showAuthorRole && this.testimonial.author.role) {\r\n      parts.push(`<div class=\"tresta-author-role\">${this.escapeHtml(this.testimonial.author.role)}</div>`);\r\n    }\r\n\r\n    // Author company\r\n    if (this.displayOptions.showAuthorCompany && this.testimonial.author.company) {\r\n      parts.push(`<div class=\"tresta-author-company\">${this.escapeHtml(this.testimonial.author.company)}</div>`);\r\n    }\r\n\r\n    parts.push('</div>'); // Close author-info\r\n    parts.push('</div>'); // Close header\r\n\r\n    return parts.join('');\r\n  }\r\n\r\n  /**\r\n   * Renders the avatar image with lazy loading\r\n   */\r\n  private renderAvatar(): string {\r\n    const avatarUrl = this.testimonial.author.avatar!;\r\n    const authorName = this.escapeHtml(this.testimonial.author.name);\r\n    \r\n    return `\r\n      <div class=\"tresta-avatar-container\">\r\n        <img \r\n          class=\"tresta-avatar\" \r\n          src=\"${this.escapeHtml(avatarUrl)}\" \r\n          alt=\"${authorName}\"\r\n          loading=\"lazy\"\r\n        />\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the OAuth verification badge\r\n   */\r\n  private renderVerificationBadge(): string {\r\n    const provider = this.escapeHtml(this.testimonial.oauthProvider!);\r\n    \r\n    return `\r\n      <span \r\n        class=\"tresta-verification-badge\" \r\n        role=\"img\" \r\n        aria-label=\"Verified via ${provider}\"\r\n        title=\"Verified via ${provider}\"\r\n      >\r\n        <svg \r\n          class=\"tresta-verification-icon\" \r\n          width=\"16\" \r\n          height=\"16\" \r\n          viewBox=\"0 0 16 16\" \r\n          fill=\"none\" \r\n          xmlns=\"http://www.w3.org/2000/svg\"\r\n          aria-hidden=\"true\"\r\n          focusable=\"false\"\r\n        >\r\n          <circle cx=\"8\" cy=\"8\" r=\"8\" fill=\"currentColor\"/>\r\n          <path \r\n            d=\"M11.5 5.5L6.5 10.5L4 8\" \r\n            stroke=\"white\" \r\n            stroke-width=\"2\" \r\n            stroke-linecap=\"round\" \r\n            stroke-linejoin=\"round\"\r\n          />\r\n        </svg>\r\n      </span>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the star rating with ARIA labels\r\n   */\r\n  private renderRating(): string {\r\n    const rating = Math.max(0, Math.min(5, this.testimonial.rating));\r\n    const fullStars = Math.floor(rating);\r\n    const hasHalfStar = rating % 1 >= 0.5;\r\n    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);\r\n\r\n    const stars: string[] = [];\r\n\r\n    // Full stars\r\n    for (let i = 0; i < fullStars; i++) {\r\n      stars.push(this.renderStar('full'));\r\n    }\r\n\r\n    // Half star\r\n    if (hasHalfStar) {\r\n      stars.push(this.renderStar('half'));\r\n    }\r\n\r\n    // Empty stars\r\n    for (let i = 0; i < emptyStars; i++) {\r\n      stars.push(this.renderStar('empty'));\r\n    }\r\n\r\n    return `\r\n      <div class=\"tresta-rating\" role=\"img\" aria-label=\"${rating} out of 5 stars\">\r\n        ${stars.join('')}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders a single star icon\r\n   */\r\n  private renderStar(type: 'full' | 'half' | 'empty'): string {\r\n    const fillClass = `tresta-star-${type}`;\r\n    \r\n    if (type === 'half') {\r\n      return `\r\n        <svg class=\"tresta-star ${fillClass}\" width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n          <defs>\r\n            <linearGradient id=\"half-fill-${this.testimonial.id}\">\r\n              <stop offset=\"50%\" stop-color=\"currentColor\"/>\r\n              <stop offset=\"50%\" stop-color=\"transparent\"/>\r\n            </linearGradient>\r\n          </defs>\r\n          <path \r\n            d=\"M10 1L12.5 7.5L19 8.5L14.5 13L15.5 19L10 16L4.5 19L5.5 13L1 8.5L7.5 7.5L10 1Z\" \r\n            fill=\"url(#half-fill-${this.testimonial.id})\"\r\n            stroke=\"currentColor\"\r\n            stroke-width=\"1\"\r\n          />\r\n        </svg>\r\n      `;\r\n    }\r\n\r\n    return `\r\n      <svg class=\"tresta-star ${fillClass}\" width=\"20\" height=\"20\" viewBox=\"0 0 20 20\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path \r\n          d=\"M10 1L12.5 7.5L19 8.5L14.5 13L15.5 19L10 16L4.5 19L5.5 13L1 8.5L7.5 7.5L10 1Z\" \r\n          fill=\"${type === 'full' ? 'currentColor' : 'transparent'}\"\r\n          stroke=\"currentColor\"\r\n          stroke-width=\"1\"\r\n        />\r\n      </svg>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the testimonial content\r\n   */\r\n  private renderContent(): string {\r\n    return `\r\n      <div class=\"tresta-testimonial-content\">\r\n        ${this.escapeHtml(this.testimonial.content)}\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Renders the formatted date\r\n   */\r\n  private renderDate(): string {\r\n    const formattedDate = this.formatDate(this.testimonial.createdAt);\r\n    \r\n    return `\r\n      <div class=\"tresta-testimonial-date\">\r\n        <time datetime=\"${this.testimonial.createdAt}\">${formattedDate}</time>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Formats a date string into a human-readable format\r\n   */\r\n  private formatDate(dateString: string): string {\r\n    try {\r\n      const date = new Date(dateString);\r\n      \r\n      // Check if date is valid\r\n      if (isNaN(date.getTime())) {\r\n        return dateString;\r\n      }\r\n\r\n      // Format as \"Month Day, Year\" (e.g., \"November 17, 2025\")\r\n      const options: Intl.DateTimeFormatOptions = {\r\n        year: 'numeric',\r\n        month: 'long',\r\n        day: 'numeric'\r\n      };\r\n\r\n      return date.toLocaleDateString('en-US', options);\r\n    } catch (error) {\r\n      // Fallback to original string if formatting fails\r\n      return dateString;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Escapes HTML to prevent XSS\r\n   * Note: This is a basic escape for text content. \r\n   * Full HTML sanitization is handled by the ContentSanitizer for rich content.\r\n   */\r\n  private escapeHtml(text: string): string {\r\n    const div = document.createElement('div');\r\n    div.textContent = text;\r\n    return div.innerHTML;\r\n  }\r\n}\r\n","/**\r\n * Carousel Layout\r\n * \r\n * Auto-rotating slider with navigation controls, touch gestures, and keyboard support.\r\n * Implements Requirements: 3.1, 6.1, 6.2, 6.3, 6.4, 6.5, 7.3, 7.4\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface CarouselConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Carousel {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n  private container: HTMLElement | null = null;\r\n  private currentIndex: number = 0;\r\n  private autoRotateTimer: number | null = null;\r\n  private isPaused: boolean = false;\r\n  private touchStartX: number = 0;\r\n  private touchEndX: number = 0;\r\n  private isTransitioning: boolean = false;\r\n\r\n  constructor(config: CarouselConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the carousel layout\r\n   */\r\n  render(): HTMLElement {\r\n    const carousel = document.createElement('div');\r\n    carousel.className = 'tresta-carousel';\r\n    carousel.setAttribute('role', 'region');\r\n    carousel.setAttribute('aria-label', 'Customer testimonials');\r\n    carousel.setAttribute('aria-roledescription', 'carousel');\r\n    carousel.setAttribute('aria-live', 'polite');\r\n    carousel.setAttribute('aria-atomic', 'false');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      carousel.appendChild(emptyState);\r\n      return carousel;\r\n    }\r\n\r\n    // Create carousel structure\r\n    const track = document.createElement('div');\r\n    track.className = 'tresta-carousel-track';\r\n\r\n    // Render testimonial slides\r\n    this.testimonials.forEach((testimonial, index) => {\r\n      const slide = this.renderSlide(testimonial, index);\r\n      track.appendChild(slide);\r\n    });\r\n\r\n    carousel.appendChild(track);\r\n    \r\n    // Add keyboard navigation instructions for screen readers\r\n    const instructions = document.createElement('div');\r\n    instructions.className = 'tresta-sr-only';\r\n    instructions.textContent = 'Use arrow keys to navigate between testimonials, or tab to navigation buttons';\r\n    carousel.appendChild(instructions);\r\n\r\n    // Add navigation buttons if enabled\r\n    if (this.layoutConfig.showNavigation !== false) {\r\n      carousel.appendChild(this.renderNavigationButtons());\r\n    }\r\n\r\n    // Add dot indicators\r\n    carousel.appendChild(this.renderDotIndicators());\r\n\r\n    this.container = carousel;\r\n\r\n    // Set up event listeners\r\n    this.setupEventListeners();\r\n\r\n    // Start auto-rotation if enabled\r\n    if (this.layoutConfig.autoRotate !== false) {\r\n      this.startAutoRotate();\r\n    }\r\n\r\n    // Show first slide\r\n    this.updateSlidePosition(false);\r\n\r\n    return carousel;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial slide\r\n   */\r\n  private renderSlide(testimonial: Testimonial, index: number): HTMLElement {\r\n    const slide = document.createElement('div');\r\n    slide.className = 'tresta-carousel-slide';\r\n    slide.id = `testimonial-slide-${index}`;\r\n    slide.setAttribute('role', 'tabpanel');\r\n    slide.setAttribute('aria-roledescription', 'slide');\r\n    slide.setAttribute('aria-label', `Testimonial ${index + 1} of ${this.testimonials.length}`);\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    slide.appendChild(card.render());\r\n\r\n    return slide;\r\n  }\r\n\r\n  /**\r\n   * Renders navigation buttons (previous/next)\r\n   */\r\n  private renderNavigationButtons(): HTMLElement {\r\n    const nav = document.createElement('div');\r\n    nav.className = 'tresta-carousel-nav';\r\n\r\n    // Previous button\r\n    const prevButton = document.createElement('button');\r\n    prevButton.className = 'tresta-carousel-button tresta-carousel-prev';\r\n    prevButton.setAttribute('aria-label', 'Previous testimonial');\r\n    prevButton.setAttribute('type', 'button');\r\n    prevButton.innerHTML = `\r\n      <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path d=\"M15 18L9 12L15 6\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n      </svg>\r\n    `;\r\n    prevButton.addEventListener('click', () => this.previous());\r\n\r\n    // Next button\r\n    const nextButton = document.createElement('button');\r\n    nextButton.className = 'tresta-carousel-button tresta-carousel-next';\r\n    nextButton.setAttribute('aria-label', 'Next testimonial');\r\n    nextButton.setAttribute('type', 'button');\r\n    nextButton.innerHTML = `\r\n      <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" aria-hidden=\"true\" focusable=\"false\">\r\n        <path d=\"M9 18L15 12L9 6\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\r\n      </svg>\r\n    `;\r\n    nextButton.addEventListener('click', () => this.next());\r\n\r\n    nav.appendChild(prevButton);\r\n    nav.appendChild(nextButton);\r\n\r\n    return nav;\r\n  }\r\n\r\n  /**\r\n   * Renders dot indicators for position tracking\r\n   */\r\n  private renderDotIndicators(): HTMLElement {\r\n    const indicators = document.createElement('div');\r\n    indicators.className = 'tresta-carousel-indicators';\r\n    indicators.setAttribute('role', 'tablist');\r\n    indicators.setAttribute('aria-label', 'Testimonial navigation');\r\n\r\n    this.testimonials.forEach((_, index) => {\r\n      const dot = document.createElement('button');\r\n      dot.className = 'tresta-carousel-dot';\r\n      dot.setAttribute('type', 'button');\r\n      dot.setAttribute('role', 'tab');\r\n      dot.setAttribute('aria-label', `Go to testimonial ${index + 1}`);\r\n      dot.setAttribute('aria-selected', index === 0 ? 'true' : 'false');\r\n      dot.setAttribute('tabindex', index === 0 ? '0' : '-1');\r\n      dot.setAttribute('aria-controls', `testimonial-slide-${index}`);\r\n      \r\n      if (index === 0) {\r\n        dot.classList.add('active');\r\n      }\r\n\r\n      dot.addEventListener('click', () => this.goToSlide(index));\r\n\r\n      indicators.appendChild(dot);\r\n    });\r\n\r\n    return indicators;\r\n  }\r\n\r\n  /**\r\n   * Sets up event listeners for touch gestures, keyboard navigation, and pause-on-hover\r\n   */\r\n  private setupEventListeners(): void {\r\n    if (!this.container) return;\r\n\r\n    // Touch gesture support\r\n    this.container.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });\r\n    this.container.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });\r\n\r\n    // Pause on hover\r\n    this.container.addEventListener('mouseenter', () => this.pause());\r\n    this.container.addEventListener('mouseleave', () => this.resume());\r\n\r\n    // Keyboard navigation\r\n    this.container.addEventListener('keydown', (e) => this.handleKeyDown(e));\r\n\r\n    // Focus management\r\n    this.container.addEventListener('focusin', () => this.pause());\r\n    this.container.addEventListener('focusout', () => this.resume());\r\n  }\r\n\r\n  /**\r\n   * Handles touch start event\r\n   */\r\n  private handleTouchStart(e: TouchEvent): void {\r\n    const touch = e.touches[0];\r\n    if (!touch) return;\r\n    \r\n    this.touchStartX = touch.clientX;\r\n    this.pause();\r\n  }\r\n\r\n  /**\r\n   * Handles touch end event and detects swipe gestures\r\n   */\r\n  private handleTouchEnd(e: TouchEvent): void {\r\n    const touch = e.changedTouches[0];\r\n    if (!touch) return;\r\n    \r\n    this.touchEndX = touch.clientX;\r\n    this.handleSwipe();\r\n    this.resume();\r\n  }\r\n\r\n  /**\r\n   * Processes swipe gesture\r\n   */\r\n  private handleSwipe(): void {\r\n    const swipeThreshold = 50; // Minimum distance for a swipe\r\n    const diff = this.touchStartX - this.touchEndX;\r\n\r\n    if (Math.abs(diff) < swipeThreshold) {\r\n      return; // Not a swipe\r\n    }\r\n\r\n    if (diff > 0) {\r\n      // Swipe left - go to next\r\n      this.next();\r\n    } else {\r\n      // Swipe right - go to previous\r\n      this.previous();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handles keyboard navigation\r\n   */\r\n  private handleKeyDown(e: KeyboardEvent): void {\r\n    switch (e.key) {\r\n      case 'ArrowLeft':\r\n        e.preventDefault();\r\n        this.previous();\r\n        break;\r\n      case 'ArrowRight':\r\n        e.preventDefault();\r\n        this.next();\r\n        break;\r\n      case 'Home':\r\n        e.preventDefault();\r\n        this.goToSlide(0);\r\n        break;\r\n      case 'End':\r\n        e.preventDefault();\r\n        this.goToSlide(this.testimonials.length - 1);\r\n        break;\r\n      case 'Escape':\r\n        e.preventDefault();\r\n        this.pause();\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Navigates to the previous slide\r\n   */\r\n  previous(): void {\r\n    if (this.isTransitioning) return;\r\n    \r\n    this.currentIndex = (this.currentIndex - 1 + this.testimonials.length) % this.testimonials.length;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Navigates to the next slide\r\n   */\r\n  next(): void {\r\n    if (this.isTransitioning) return;\r\n    \r\n    this.currentIndex = (this.currentIndex + 1) % this.testimonials.length;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Navigates to a specific slide by index\r\n   */\r\n  goToSlide(index: number): void {\r\n    if (this.isTransitioning || index === this.currentIndex) return;\r\n    if (index < 0 || index >= this.testimonials.length) return;\r\n\r\n    this.currentIndex = index;\r\n    this.updateSlidePosition();\r\n  }\r\n\r\n  /**\r\n   * Updates the carousel position to show the current slide\r\n   */\r\n  private updateSlidePosition(animate: boolean = true): void {\r\n    if (!this.container) return;\r\n\r\n    const track = this.container.querySelector('.tresta-carousel-track') as HTMLElement;\r\n    const slides = this.container.querySelectorAll('.tresta-carousel-slide');\r\n    const dots = this.container.querySelectorAll('.tresta-carousel-dot');\r\n\r\n    if (!track || slides.length === 0) return;\r\n\r\n    // Update track position\r\n    const offset = -this.currentIndex * 100;\r\n    track.style.transform = `translateX(${offset}%)`;\r\n    track.style.transition = animate ? 'transform 0.3s ease-in-out' : 'none';\r\n\r\n    // Update slide visibility and ARIA attributes\r\n    slides.forEach((slide, index) => {\r\n      const isActive = index === this.currentIndex;\r\n      slide.setAttribute('aria-hidden', isActive ? 'false' : 'true');\r\n      \r\n      if (isActive) {\r\n        slide.classList.add('active');\r\n      } else {\r\n        slide.classList.remove('active');\r\n      }\r\n    });\r\n\r\n    // Update dot indicators\r\n    dots.forEach((dot, index) => {\r\n      const isActive = index === this.currentIndex;\r\n      dot.setAttribute('aria-selected', isActive ? 'true' : 'false');\r\n      dot.setAttribute('tabindex', isActive ? '0' : '-1');\r\n      \r\n      if (isActive) {\r\n        dot.classList.add('active');\r\n      } else {\r\n        dot.classList.remove('active');\r\n      }\r\n    });\r\n\r\n    // Set transitioning flag after DOM updates\r\n    if (animate) {\r\n      this.isTransitioning = true;\r\n      setTimeout(() => {\r\n        this.isTransitioning = false;\r\n      }, 300); // Match CSS transition duration\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts auto-rotation\r\n   */\r\n  private startAutoRotate(): void {\r\n    if (this.layoutConfig.autoRotate === false) return;\r\n\r\n    const interval = this.layoutConfig.rotateInterval || 5000; // Default 5 seconds\r\n\r\n    this.autoRotateTimer = window.setInterval(() => {\r\n      if (!this.isPaused) {\r\n        this.next();\r\n      }\r\n    }, interval);\r\n  }\r\n\r\n  /**\r\n   * Stops auto-rotation\r\n   */\r\n  private stopAutoRotate(): void {\r\n    if (this.autoRotateTimer !== null) {\r\n      clearInterval(this.autoRotateTimer);\r\n      this.autoRotateTimer = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Pauses auto-rotation\r\n   */\r\n  pause(): void {\r\n    if (!this.isPaused) {\r\n      this.isPaused = true;\r\n      \r\n      // Update ARIA live region to announce pause\r\n      if (this.container) {\r\n        this.container.setAttribute('aria-live', 'off');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resumes auto-rotation\r\n   */\r\n  resume(): void {\r\n    if (this.isPaused) {\r\n      this.isPaused = false;\r\n      \r\n      // Update ARIA live region to announce resume\r\n      if (this.container) {\r\n        this.container.setAttribute('aria-live', 'polite');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleans up event listeners and timers\r\n   */\r\n  destroy(): void {\r\n    this.stopAutoRotate();\r\n\r\n    if (this.container) {\r\n      // Remove event listeners\r\n      const clonedContainer = this.container.cloneNode(true) as HTMLElement;\r\n      this.container.parentNode?.replaceChild(clonedContainer, this.container);\r\n      this.container = null;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Grid Layout\r\n * \r\n * Responsive grid layout with CSS Grid and equal-height cards.\r\n * Supports 1-4 columns based on screen size.\r\n * Implements Requirements: 3.2, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface GridConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Grid {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: GridConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the grid layout\r\n   */\r\n  render(): HTMLElement {\r\n    const grid = document.createElement('div');\r\n    grid.className = 'tresta-grid';\r\n    grid.setAttribute('role', 'list');\r\n    grid.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      grid.appendChild(emptyState);\r\n      return grid;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      grid.style.setProperty('--grid-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      grid.appendChild(item);\r\n    });\r\n\r\n    return grid;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial grid item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-grid-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for grid layout\r\n  }\r\n}\r\n","/**\r\n * Masonry Layout\r\n * \r\n * Pinterest-style layout with dynamic height cards and optimal spacing.\r\n * Uses CSS Grid with auto-flow dense for efficient packing.\r\n * Implements Requirements: 3.3, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface MasonryConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Masonry {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n  private container: HTMLElement | null = null;\r\n  private resizeObserver: ResizeObserver | null = null;\r\n\r\n  constructor(config: MasonryConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the masonry layout\r\n   */\r\n  render(): HTMLElement {\r\n    const masonry = document.createElement('div');\r\n    masonry.className = 'tresta-masonry';\r\n    masonry.setAttribute('role', 'list');\r\n    masonry.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      masonry.appendChild(emptyState);\r\n      return masonry;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      masonry.style.setProperty('--masonry-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      masonry.appendChild(item);\r\n    });\r\n\r\n    this.container = masonry;\r\n\r\n    // Set up resize observer to recalculate layout on size changes\r\n    this.setupResizeObserver();\r\n\r\n    return masonry;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial masonry item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-masonry-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Sets up ResizeObserver to handle dynamic height changes\r\n   */\r\n  private setupResizeObserver(): void {\r\n    if (!this.container) return;\r\n\r\n    // Check if ResizeObserver is supported\r\n    if (typeof ResizeObserver === 'undefined') {\r\n      return; // Graceful degradation - layout will still work without dynamic adjustments\r\n    }\r\n\r\n    this.resizeObserver = new ResizeObserver((entries) => {\r\n      entries.forEach((entry) => {\r\n        const item = entry.target as HTMLElement;\r\n        const height = entry.contentRect.height;\r\n        \r\n        // Calculate grid row span based on item height\r\n        // Each row is approximately 10px, so we calculate how many rows this item needs\r\n        const rowSpan = Math.ceil(height / 10);\r\n        item.style.gridRowEnd = `span ${rowSpan}`;\r\n      });\r\n    });\r\n\r\n    // Observe all masonry items\r\n    const items = this.container.querySelectorAll('.tresta-masonry-item');\r\n    items.forEach((item) => {\r\n      this.resizeObserver!.observe(item);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    if (this.resizeObserver) {\r\n      this.resizeObserver.disconnect();\r\n      this.resizeObserver = null;\r\n    }\r\n    this.container = null;\r\n  }\r\n}\r\n","/**\r\n * Wall Layout\r\n * \r\n * Dense grid layout with varied card sizes for visual interest.\r\n * Featured testimonials (high ratings or verified) get larger cards.\r\n * Implements Requirements: 3.4, 7.2, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface WallConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class Wall {\r\n  private testimonials: Testimonial[];\r\n  private layoutConfig: LayoutConfig;\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: WallConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.layoutConfig = config.layoutConfig;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the wall layout\r\n   */\r\n  render(): HTMLElement {\r\n    const wall = document.createElement('div');\r\n    wall.className = 'tresta-wall';\r\n    wall.setAttribute('role', 'list');\r\n    wall.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      wall.appendChild(emptyState);\r\n      return wall;\r\n    }\r\n\r\n    // Apply column configuration if specified\r\n    if (this.layoutConfig.columns) {\r\n      wall.style.setProperty('--wall-columns', this.layoutConfig.columns.toString());\r\n    }\r\n\r\n    // Render testimonial items with varied sizes\r\n    this.testimonials.forEach((testimonial, index) => {\r\n      const item = this.renderItem(testimonial, index);\r\n      wall.appendChild(item);\r\n    });\r\n\r\n    return wall;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial wall item with size variation\r\n   */\r\n  private renderItem(testimonial: Testimonial, index: number): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-wall-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Determine if this should be a featured (larger) card\r\n    const isFeatured = this.shouldBeFeatured(testimonial, index);\r\n    \r\n    if (isFeatured) {\r\n      item.classList.add('tresta-wall-item-featured');\r\n    }\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Determines if a testimonial should be featured (larger card)\r\n   * Based on rating, verification status, and position\r\n   */\r\n  private shouldBeFeatured(testimonial: Testimonial, index: number): boolean {\r\n    // Feature every 5th testimonial for visual variety\r\n    const isPositionFeatured = index % 5 === 0;\r\n    \r\n    // Feature high-rated testimonials (5 stars)\r\n    const isHighRated = testimonial.rating === 5;\r\n    \r\n    // Feature OAuth verified testimonials\r\n    const isVerified = testimonial.isOAuthVerified;\r\n    \r\n    // A testimonial is featured if it meets any of these criteria\r\n    return isPositionFeatured || (isHighRated && isVerified);\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for wall layout\r\n  }\r\n}\r\n","/**\r\n * List Layout\r\n * \r\n * Simple vertical list layout with minimal JavaScript.\r\n * Serves as a fallback for older browsers.\r\n * Implements Requirements: 3.5, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { TestimonialCard } from '../components/testimonial-card';\r\n\r\nexport interface ListConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\nexport class List {\r\n  private testimonials: Testimonial[];\r\n  private displayOptions: DisplayOptions;\r\n  private theme: ThemeConfig;\r\n\r\n  constructor(config: ListConfig) {\r\n    this.testimonials = config.testimonials;\r\n    this.displayOptions = config.displayOptions;\r\n    this.theme = config.theme;\r\n  }\r\n\r\n  /**\r\n   * Renders the list layout\r\n   */\r\n  render(): HTMLElement {\r\n    const list = document.createElement('div');\r\n    list.className = 'tresta-list';\r\n    list.setAttribute('role', 'list');\r\n    list.setAttribute('aria-label', 'Customer testimonials');\r\n\r\n    // Handle empty state\r\n    if (this.testimonials.length === 0) {\r\n      const emptyState = document.createElement('div');\r\n      emptyState.className = 'tresta-empty-state';\r\n      emptyState.textContent = 'No testimonials to display yet.';\r\n      list.appendChild(emptyState);\r\n      return list;\r\n    }\r\n\r\n    // Render testimonial items\r\n    this.testimonials.forEach((testimonial) => {\r\n      const item = this.renderItem(testimonial);\r\n      list.appendChild(item);\r\n    });\r\n\r\n    return list;\r\n  }\r\n\r\n  /**\r\n   * Renders a single testimonial list item\r\n   */\r\n  private renderItem(testimonial: Testimonial): HTMLElement {\r\n    const item = document.createElement('div');\r\n    item.className = 'tresta-list-item';\r\n    item.setAttribute('role', 'listitem');\r\n\r\n    // Create testimonial card\r\n    const card = new TestimonialCard({\r\n      testimonial,\r\n      displayOptions: this.displayOptions,\r\n      theme: this.theme,\r\n    });\r\n\r\n    item.appendChild(card.render());\r\n\r\n    return item;\r\n  }\r\n\r\n  /**\r\n   * Cleans up resources\r\n   */\r\n  destroy(): void {\r\n    // No cleanup needed for list layout\r\n  }\r\n}\r\n","/**\r\n * Layout Engine\r\n * \r\n * Factory for creating different layout types.\r\n * Implements Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 7.5\r\n */\r\n\r\nimport type { Testimonial, LayoutConfig, DisplayOptions, ThemeConfig } from '../types';\r\nimport { Carousel } from './carousel';\r\nimport { Grid } from './grid';\r\nimport { Masonry } from './masonry';\r\nimport { Wall } from './wall';\r\nimport { List } from './list';\r\n\r\nexport { Carousel } from './carousel';\r\nexport { Grid } from './grid';\r\nexport { Masonry } from './masonry';\r\nexport { Wall } from './wall';\r\nexport { List } from './list';\r\n\r\nexport type { CarouselConfig } from './carousel';\r\nexport type { GridConfig } from './grid';\r\nexport type { MasonryConfig } from './masonry';\r\nexport type { WallConfig } from './wall';\r\nexport type { ListConfig } from './list';\r\n\r\n/**\r\n * Layout interface that all layouts must implement\r\n */\r\nexport interface Layout {\r\n  render(): HTMLElement;\r\n  destroy(): void;\r\n}\r\n\r\n/**\r\n * Configuration for creating a layout\r\n */\r\nexport interface LayoutEngineConfig {\r\n  testimonials: Testimonial[];\r\n  layoutConfig: LayoutConfig;\r\n  displayOptions: DisplayOptions;\r\n  theme: ThemeConfig;\r\n}\r\n\r\n/**\r\n * LayoutEngine - Factory for creating layout instances\r\n */\r\nexport class LayoutEngine {\r\n  /**\r\n   * Creates a layout instance based on the specified type\r\n   * \r\n   * @param config - Configuration including layout type and testimonials\r\n   * @returns Layout instance\r\n   * @throws Error if layout type is not supported\r\n   */\r\n  static create(config: LayoutEngineConfig): Layout {\r\n    const { layoutConfig } = config;\r\n\r\n    switch (layoutConfig.type) {\r\n      case 'carousel':\r\n        return new Carousel(config);\r\n      \r\n      case 'grid':\r\n        return new Grid(config);\r\n      \r\n      case 'masonry':\r\n        return new Masonry(config);\r\n      \r\n      case 'wall':\r\n        return new Wall(config);\r\n      \r\n      case 'list':\r\n        return new List(config);\r\n      \r\n      default:\r\n        // Fallback to list layout for unknown types (graceful degradation)\r\n        console.warn(`[TrestaWidget] Unknown layout type: ${layoutConfig.type}. Falling back to list layout.`);\r\n        return new List(config);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Testimonial Limiter Utility\r\n * \r\n * Handles limiting and sorting of testimonials based on configuration.\r\n * Implements Requirements: 12.1, 12.2, 12.3, 12.4, 12.5\r\n */\r\n\r\nimport type { Testimonial } from '../types';\r\n\r\n/**\r\n * Limits testimonials to the specified maximum count, prioritizing most recent.\r\n * \r\n * @param testimonials - Array of testimonials to limit\r\n * @param maxTestimonials - Maximum number of testimonials to return (default: 100)\r\n * @returns Limited array of testimonials, sorted by createdAt descending\r\n */\r\nexport function limitTestimonials(\r\n  testimonials: Testimonial[],\r\n  maxTestimonials?: number\r\n): Testimonial[] {\r\n  // Handle empty or invalid input\r\n  if (!testimonials || testimonials.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  // Default to 100 if not specified\r\n  const limit = maxTestimonials ?? 100;\r\n\r\n  // If limit is 0 or negative, return empty array\r\n  if (limit <= 0) {\r\n    return [];\r\n  }\r\n\r\n  // If we have fewer testimonials than the limit, just sort and return all\r\n  if (testimonials.length <= limit) {\r\n    return sortByCreatedAtDesc(testimonials);\r\n  }\r\n\r\n  // Sort by createdAt descending and take the first 'limit' items\r\n  return sortByCreatedAtDesc(testimonials).slice(0, limit);\r\n}\r\n\r\n/**\r\n * Sorts testimonials by createdAt in descending order (most recent first)\r\n * \r\n * @param testimonials - Array of testimonials to sort\r\n * @returns Sorted array (does not mutate original)\r\n */\r\nfunction sortByCreatedAtDesc(testimonials: Testimonial[]): Testimonial[] {\r\n  // Create a copy to avoid mutating the original array\r\n  return [...testimonials].sort((a, b) => {\r\n    const dateA = new Date(a.createdAt).getTime();\r\n    const dateB = new Date(b.createdAt).getTime();\r\n    \r\n    // Sort descending (most recent first)\r\n    return dateB - dateA;\r\n  });\r\n}\r\n","/**\r\n * CSP Validator - Ensures Content Security Policy compliance\r\n * \r\n * Features:\r\n * - Validates that all resources load from allowed domains\r\n * - Detects CSP violations at runtime\r\n * - Provides nonce support for strict CSP environments\r\n * - Validates no inline scripts or eval() usage\r\n */\r\n\r\nexport interface CSPConfig {\r\n  allowedDomains: string[];\r\n  nonce?: string;\r\n  reportViolations?: boolean;\r\n}\r\n\r\n// Default allowed domains per requirements\r\nconst DEFAULT_ALLOWED_DOMAINS = [\r\n  'cdn.tresta.com',\r\n  'api.tresta.com',\r\n];\r\n\r\n/**\r\n * CSP Validator class\r\n */\r\nexport class CSPValidator {\r\n  private config: CSPConfig;\r\n  private violations: CSPViolation[] = [];\r\n\r\n  constructor(config: Partial<CSPConfig> = {}) {\r\n    this.config = {\r\n      allowedDomains: DEFAULT_ALLOWED_DOMAINS,\r\n      reportViolations: true,\r\n      ...config,\r\n    };\r\n\r\n    // Set up CSP violation listener if reporting is enabled\r\n    if (this.config.reportViolations && typeof document !== 'undefined') {\r\n      this.setupViolationListener();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validates that a URL is from an allowed domain\r\n   */\r\n  validateURL(url: string): boolean {\r\n    if (!url) {\r\n      return false;\r\n    }\r\n\r\n    // Allow relative URLs\r\n    if (url.startsWith('/') || url.startsWith('./') || url.startsWith('../')) {\r\n      return true;\r\n    }\r\n\r\n    // Allow data URLs for inline images (common for small icons)\r\n    if (url.startsWith('data:')) {\r\n      return true;\r\n    }\r\n\r\n    try {\r\n      const parsed = new URL(url);\r\n      const hostname = parsed.hostname;\r\n\r\n      // Check if hostname matches any allowed domain\r\n      return this.config.allowedDomains.some(domain => {\r\n        // Exact match or subdomain match\r\n        return hostname === domain || hostname.endsWith(`.${domain}`);\r\n      });\r\n    } catch {\r\n      // Invalid URL\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validates that all resources in the widget are from allowed domains\r\n   */\r\n  validateResources(root: HTMLElement): CSPValidationResult {\r\n    const violations: CSPViolation[] = [];\r\n\r\n    // Check all images\r\n    const images = root.querySelectorAll('img');\r\n    images.forEach(img => {\r\n      const src = img.getAttribute('src');\r\n      if (src && !this.validateURL(src)) {\r\n        violations.push({\r\n          type: 'image',\r\n          url: src,\r\n          element: img,\r\n          message: `Image source not from allowed domain: ${src}`,\r\n        });\r\n      }\r\n    });\r\n\r\n    // Check all scripts (should not exist in widget content)\r\n    const scripts = root.querySelectorAll('script');\r\n    scripts.forEach(script => {\r\n      violations.push({\r\n        type: 'script',\r\n        url: script.getAttribute('src') || 'inline',\r\n        element: script,\r\n        message: 'Script tag found in widget content (CSP violation)',\r\n      });\r\n    });\r\n\r\n    // Check all iframes (should not exist in widget content)\r\n    const iframes = root.querySelectorAll('iframe');\r\n    iframes.forEach(iframe => {\r\n      violations.push({\r\n        type: 'iframe',\r\n        url: iframe.getAttribute('src') || 'inline',\r\n        element: iframe,\r\n        message: 'Iframe found in widget content (CSP violation)',\r\n      });\r\n    });\r\n\r\n    // Check all links\r\n    const links = root.querySelectorAll('a');\r\n    links.forEach(link => {\r\n      const href = link.getAttribute('href');\r\n      if (href && href.startsWith('javascript:')) {\r\n        violations.push({\r\n          type: 'link',\r\n          url: href,\r\n          element: link,\r\n          message: 'JavaScript URL in link (CSP violation)',\r\n        });\r\n      }\r\n    });\r\n\r\n    // Check for inline event handlers\r\n    const elementsWithEvents = root.querySelectorAll('[onclick], [onload], [onerror], [onmouseover]');\r\n    elementsWithEvents.forEach(element => {\r\n      violations.push({\r\n        type: 'inline-event',\r\n        url: 'inline',\r\n        element: element as HTMLElement,\r\n        message: 'Inline event handler found (CSP violation)',\r\n      });\r\n    });\r\n\r\n    return {\r\n      valid: violations.length === 0,\r\n      violations,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Checks if the current environment has a strict CSP\r\n   */\r\n  async detectStrictCSP(): Promise<boolean> {\r\n    // Try to detect CSP by attempting to create an inline script\r\n    // This is a non-invasive check that doesn't actually execute anything\r\n    try {\r\n      const meta = document.querySelector('meta[http-equiv=\"Content-Security-Policy\"]');\r\n      if (meta) {\r\n        const content = meta.getAttribute('content') || '';\r\n        // Check for strict CSP directives\r\n        return content.includes(\"'strict-dynamic'\") || \r\n               (!content.includes(\"'unsafe-inline'\") && !content.includes(\"'unsafe-eval'\"));\r\n      }\r\n    } catch {\r\n      // If we can't check, assume no strict CSP\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Gets the nonce value from the current script tag or config\r\n   */\r\n  getNonce(): string | null {\r\n    // First check config\r\n    if (this.config.nonce) {\r\n      return this.config.nonce;\r\n    }\r\n\r\n    // Try to find nonce from the widget script tag\r\n    if (typeof document !== 'undefined') {\r\n      const scripts = document.querySelectorAll('script[data-widget-id]');\r\n      for (const script of Array.from(scripts)) {\r\n        const nonce = script.getAttribute('nonce');\r\n        if (nonce) {\r\n          return nonce;\r\n        }\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Applies nonce to dynamically created elements if needed\r\n   */\r\n  applyNonce(element: HTMLElement): void {\r\n    const nonce = this.getNonce();\r\n    if (nonce) {\r\n      // Apply nonce to script and style tags\r\n      if (element.tagName === 'SCRIPT' || element.tagName === 'STYLE') {\r\n        element.setAttribute('nonce', nonce);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets all recorded violations\r\n   */\r\n  getViolations(): CSPViolation[] {\r\n    return [...this.violations];\r\n  }\r\n\r\n  /**\r\n   * Clears all recorded violations\r\n   */\r\n  clearViolations(): void {\r\n    this.violations = [];\r\n  }\r\n\r\n  /**\r\n   * Sets up a listener for CSP violations\r\n   */\r\n  private setupViolationListener(): void {\r\n    if (typeof document === 'undefined') {\r\n      return;\r\n    }\r\n\r\n    document.addEventListener('securitypolicyviolation', (event) => {\r\n      // Only track violations related to our widget\r\n      if (event.blockedURI && this.isWidgetRelated(event)) {\r\n        this.violations.push({\r\n          type: 'csp-violation',\r\n          url: event.blockedURI,\r\n          message: `CSP violation: ${event.violatedDirective} - ${event.blockedURI}`,\r\n          directive: event.violatedDirective,\r\n        });\r\n\r\n        console.warn('[TrestaWidget] CSP violation detected:', {\r\n          directive: event.violatedDirective,\r\n          blockedURI: event.blockedURI,\r\n          sourceFile: event.sourceFile,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Checks if a CSP violation is related to our widget\r\n   */\r\n  private isWidgetRelated(event: SecurityPolicyViolationEvent): boolean {\r\n    // Check if the violation is from our widget domains\r\n    const blockedURI = event.blockedURI;\r\n    const sourceFile = event.sourceFile;\r\n\r\n    return (\r\n      this.config.allowedDomains.some(domain => \r\n        blockedURI.includes(domain) || sourceFile?.includes(domain)\r\n      ) ||\r\n      sourceFile?.includes('tresta-widget') ||\r\n      blockedURI.includes('tresta-widget')\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * CSP Violation interface\r\n */\r\nexport interface CSPViolation {\r\n  type: 'image' | 'script' | 'iframe' | 'link' | 'inline-event' | 'csp-violation';\r\n  url: string;\r\n  element?: HTMLElement;\r\n  message: string;\r\n  directive?: string;\r\n}\r\n\r\n/**\r\n * CSP Validation Result\r\n */\r\nexport interface CSPValidationResult {\r\n  valid: boolean;\r\n  violations: CSPViolation[];\r\n}\r\n\r\n/**\r\n * Validates CSP compliance for required directives\r\n */\r\nexport function getRequiredCSPDirectives(): string[] {\r\n  return [\r\n    \"script-src 'self' https://cdn.tresta.com\",\r\n    \"connect-src https://api.tresta.com\",\r\n    \"img-src https://cdn.tresta.com https://api.tresta.com data:\",\r\n    \"style-src 'self' https://cdn.tresta.com\",\r\n  ];\r\n}\r\n\r\n/**\r\n * Generates CSP-friendly embed code with nonce support\r\n */\r\nexport function generateCSPFriendlyEmbedCode(\r\n  widgetId: string,\r\n  version: string,\r\n  integrity?: string,\r\n  nonce?: string\r\n): string {\r\n  const nonceAttr = nonce ? ` nonce=\"${nonce}\"` : '';\r\n  const integrityAttr = integrity ? ` integrity=\"${integrity}\" crossorigin=\"anonymous\"` : '';\r\n\r\n  return `<!-- Tresta Testimonial Widget (CSP-friendly) -->\r\n<div id=\"tresta-widget-${widgetId}\" data-widget-id=\"${widgetId}\"></div>\r\n<script async \r\n        src=\"https://cdn.tresta.com/widget/v${version}/tresta-widget.iife.js\"${integrityAttr}${nonceAttr}\r\n        data-widget-id=\"${widgetId}\"></script>`;\r\n}\r\n\r\n// Export singleton instance\r\nexport const defaultCSPValidator = new CSPValidator();\r\n","/**\r\n * Main Widget class - orchestrates all widget functionality\r\n */\r\n\r\nimport type { WidgetConfig, WidgetInstance, WidgetState, WidgetData } from '../types';\r\nimport { WidgetError } from '../types';\r\nimport { StyleManager } from '../styles/style-manager';\r\nimport { APIClient } from '../api/client';\r\nimport { StorageManager } from '../storage/cache-manager';\r\nimport { createErrorState, createEmptyState } from '../components/error-state';\r\nimport { TelemetryTracker } from '../telemetry';\r\nimport { LayoutEngine } from '../layouts';\r\nimport { limitTestimonials } from '../utils/testimonial-limiter';\r\nimport { Logger } from '../utils/logger';\r\nimport { CSPValidator } from '../security/csp-validator';\r\n\r\n// Track all widget instances for proper cleanup and isolation\r\nconst widgetInstances = new WeakMap<HTMLElement, Widget>();\r\n\r\nexport class Widget implements WidgetInstance {\r\n  private config: WidgetConfig;\r\n  private state: WidgetState;\r\n  private container: HTMLElement | null = null;\r\n  private root: HTMLElement | null = null;\r\n  private styleManager: StyleManager | null = null;\r\n  private contentRoot: HTMLElement | null = null;\r\n  private liveRegion: HTMLElement | null = null;\r\n  private eventListeners: Array<{ element: HTMLElement; event: string; handler: EventListener }> = [];\r\n  private currentLayout: { destroy: () => void } | null = null;\r\n  private apiClient: APIClient;\r\n  private storageManager: StorageManager;\r\n  private telemetryTracker: TelemetryTracker;\r\n  private logger: Logger;\r\n  private cspValidator: CSPValidator;\r\n\r\n  constructor(config: WidgetConfig) {\r\n    this.config = config;\r\n    this.state = {\r\n      mounted: false,\r\n      loading: false,\r\n      error: null,\r\n      data: null,\r\n    };\r\n\r\n    // Initialize logger\r\n    this.logger = new Logger(\r\n      config.widgetId,\r\n      config.version || '1.0.0',\r\n      config.debug || false\r\n    );\r\n\r\n    // Initialize API client with API key and custom base URL if provided\r\n    const apiClientConfig = config.apiUrl ? { baseURL: config.apiUrl } : {};\r\n    this.apiClient = new APIClient(apiClientConfig, config.apiKey, this.logger);\r\n    this.storageManager = new StorageManager();\r\n\r\n    // Initialize telemetry tracker\r\n    this.telemetryTracker = new TelemetryTracker(\r\n      config.widgetId,\r\n      config.version || '1.0.0',\r\n      {\r\n        enabled: config.telemetry !== false,\r\n      }\r\n    );\r\n\r\n    // Initialize CSP validator\r\n    this.cspValidator = new CSPValidator({\r\n      reportViolations: config.debug || false,\r\n    });\r\n\r\n    this.logger.debug('Initialized with config:', {\r\n      widgetId: config.widgetId,\r\n      apiKey: config.apiKey ? `${config.apiKey.substring(0, 15)}...` : 'NOT PROVIDED',\r\n      apiUrl: config.apiUrl || 'default (https://api.tresta.com)',\r\n      debug: config.debug,\r\n      telemetry: config.telemetry,\r\n      version: config.version,\r\n    });\r\n    this.logger.debug('Telemetry enabled:', this.telemetryTracker.isEnabled());\r\n  }\r\n\r\n  async mount(container: HTMLElement): Promise<void> {\r\n    try {\r\n      // Start telemetry load tracking\r\n      this.telemetryTracker.startLoadTracking();\r\n\r\n      // Check if widget is already mounted in this container\r\n      if (widgetInstances.has(container)) {\r\n        const existingWidget = widgetInstances.get(container);\r\n        if (existingWidget && existingWidget !== this) {\r\n          console.warn(`[TrestaWidget] Container already has a widget instance. Unmounting existing widget.`);\r\n          existingWidget.unmount();\r\n        }\r\n      }\r\n\r\n      this.container = container;\r\n      this.state.mounted = true;\r\n      this.state.loading = true;\r\n\r\n      // Create widget root\r\n      this.root = document.createElement('div');\r\n      this.root.setAttribute('data-tresta-widget', this.config.widgetId);\r\n      this.root.setAttribute('data-version', this.config.version || '1.0.0');\r\n      this.root.setAttribute('data-instance-id', this.generateInstanceId());\r\n      \r\n      // Add lang attribute for localization support\r\n      if (this.config.lang) {\r\n        this.root.setAttribute('lang', this.config.lang);\r\n      }\r\n      \r\n      // Add role for semantic structure\r\n      this.root.setAttribute('role', 'region');\r\n      this.root.setAttribute('aria-label', 'Testimonials widget');\r\n\r\n      // Initialize style manager and get content root\r\n      this.styleManager = new StyleManager({\r\n        debug: this.config.debug ?? false,\r\n        theme: this.config.theme,\r\n        ...(this.config.useShadowDOM !== undefined && { useShadowDOM: this.config.useShadowDOM }),\r\n      });\r\n      this.contentRoot = this.styleManager.initializeStyles(this.root);\r\n      \r\n      // Create ARIA live region for dynamic content announcements\r\n      this.liveRegion = document.createElement('div');\r\n      this.liveRegion.setAttribute('role', 'status');\r\n      this.liveRegion.setAttribute('aria-live', 'polite');\r\n      this.liveRegion.setAttribute('aria-atomic', 'true');\r\n      this.liveRegion.className = 'tresta-sr-only';\r\n      this.contentRoot.appendChild(this.liveRegion);\r\n\r\n      container.appendChild(this.root);\r\n\r\n      // Register this instance\r\n      widgetInstances.set(container, this);\r\n\r\n      // Fetch and render widget data\r\n      await this.fetchAndRender();\r\n\r\n      this.logger.debug('Mounted successfully to container', container);\r\n    } catch (error) {\r\n      this.state.loading = false;\r\n      this.state.error = error as Error;\r\n\r\n      // Track error in telemetry\r\n      if (error instanceof WidgetError) {\r\n        this.telemetryTracker.trackError(error.code);\r\n      } else {\r\n        this.telemetryTracker.trackError('MOUNT_ERROR');\r\n      }\r\n\r\n      // Log error with widget ID and version\r\n      this.logError('Mount failed', error);\r\n\r\n      // Render error state - don't throw to prevent breaking host page\r\n      this.renderErrorState(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data with cache fallback\r\n   */\r\n  private async fetchAndRender(): Promise<void> {\r\n    try {\r\n      this.logger.debug('Starting fetchAndRender');\r\n\r\n      this.state.loading = true;\r\n      \r\n      // Announce loading state to screen readers\r\n      this.announceToScreenReader('Loading testimonials');\r\n\r\n      // Try to fetch from API\r\n      const data = await this.fetchWithFallback();\r\n\r\n      this.logger.debug('Data fetched successfully:', {\r\n        widgetId: data.widgetId,\r\n        testimonialCount: data.testimonials?.length || 0,\r\n      });\r\n\r\n      this.state.data = data;\r\n      this.state.error = null;\r\n      this.state.loading = false;\r\n\r\n      // Render the widget content\r\n      this.renderContent(data);\r\n\r\n      // Track successful load with layout type\r\n      this.telemetryTracker.trackLoad(data.config?.layout?.type);\r\n      \r\n      // Announce successful load to screen readers\r\n      const count = data.testimonials?.length || 0;\r\n      this.announceToScreenReader(`${count} testimonial${count !== 1 ? 's' : ''} loaded`);\r\n\r\n    } catch (error) {\r\n      this.state.loading = false;\r\n      this.state.error = error as Error;\r\n\r\n      // Track error in telemetry\r\n      if (error instanceof WidgetError) {\r\n        this.telemetryTracker.trackError(error.code);\r\n      } else {\r\n        this.telemetryTracker.trackError('FETCH_ERROR');\r\n      }\r\n\r\n      // Log error with widget ID and version\r\n      this.logError('Failed to fetch widget data', error);\r\n\r\n      // Render error state\r\n      this.renderErrorState(error);\r\n      \r\n      // Announce error to screen readers\r\n      this.announceToScreenReader('Failed to load testimonials', 'assertive');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch widget data with cache fallback on errors\r\n   */\r\n  private async fetchWithFallback(): Promise<WidgetData> {\r\n    try {\r\n      // Fetch from API\r\n      const data = await this.apiClient.fetchWidgetData(this.config.widgetId);\r\n\r\n      // Cache the successful response\r\n      await this.storageManager.set(this.config.widgetId, data);\r\n\r\n      this.logger.debug('Fetched widget data from API');\r\n\r\n      return data;\r\n    } catch (error) {\r\n      // Try to use cached data as fallback\r\n      const cached = await this.storageManager.get(this.config.widgetId);\r\n\r\n      if (cached) {\r\n        this.logger.warn('Using cached data due to API error');\r\n        return cached;\r\n      }\r\n\r\n      // No cache available, re-throw the error\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render widget content\r\n   */\r\n  private renderContent(data: WidgetData): void {\r\n    this.logger.debug('renderContent called', {\r\n      hasContentRoot: !!this.contentRoot,\r\n      testimonialCount: data.testimonials?.length || 0,\r\n      widgetData: data,\r\n    });\r\n\r\n    if (!this.contentRoot) {\r\n      this.logger.error('No content root available for rendering');\r\n      return;\r\n    }\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Check if there are any testimonials\r\n    if (!data.testimonials || data.testimonials.length === 0) {\r\n      this.logger.logEmpty();\r\n      this.renderEmptyState();\r\n      return;\r\n    }\r\n\r\n    // Apply maxTestimonials limit before rendering\r\n    // Check both layoutConfig and displayOptions for maxTestimonials\r\n    const maxTestimonials = data.config.layout.maxTestimonials ?? data.config.display.maxTestimonials;\r\n    const limitedTestimonials = limitTestimonials(data.testimonials, maxTestimonials);\r\n\r\n    this.logger.debug(`Rendering ${limitedTestimonials.length} testimonials (limited from ${data.testimonials.length}) with layout: ${data.config.layout.type}`);\r\n\r\n    // Clean up previous layout if exists\r\n    if (this.currentLayout) {\r\n      this.currentLayout.destroy();\r\n      this.currentLayout = null;\r\n    }\r\n\r\n    // Use LayoutEngine to render the limited testimonials\r\n    const layout = LayoutEngine.create({\r\n      testimonials: limitedTestimonials,\r\n      layoutConfig: data.config.layout,\r\n      displayOptions: data.config.display,\r\n      theme: data.config.theme,\r\n    });\r\n\r\n    const layoutElement = layout.render();\r\n    this.contentRoot.appendChild(layoutElement);\r\n\r\n    // Track the current layout for cleanup\r\n    this.currentLayout = layout;\r\n\r\n    this.logger.debug(`Widget rendered successfully with ${data.config.layout.type} layout`);\r\n\r\n    // Validate CSP compliance in debug mode\r\n    if (this.config.debug && this.contentRoot) {\r\n      const cspResult = this.cspValidator.validateResources(this.contentRoot);\r\n      if (!cspResult.valid) {\r\n        this.logger.warn('CSP violations detected:', cspResult.violations);\r\n      } else {\r\n        this.logger.debug('CSP validation passed');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Render error state\r\n   */\r\n  private renderErrorState(error: unknown): void {\r\n    if (!this.contentRoot) return;\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Determine error message\r\n    let message = this.config.errorMessage;\r\n\r\n    if (!message) {\r\n      if (error instanceof WidgetError) {\r\n        message = error.message;\r\n      } else {\r\n        message = 'Unable to load testimonials. Please try again later.';\r\n      }\r\n    }\r\n\r\n    // Create and append error state\r\n    const errorState = createErrorState({\r\n      type: 'error',\r\n      message,\r\n      widgetId: this.config.widgetId,\r\n      version: this.config.version || \"N/A\",\r\n    });\r\n\r\n    this.contentRoot.appendChild(errorState);\r\n  }\r\n\r\n  /**\r\n   * Render empty state\r\n   */\r\n  private renderEmptyState(): void {\r\n    if (!this.contentRoot) return;\r\n\r\n    // Clear existing content\r\n    this.contentRoot.innerHTML = '';\r\n\r\n    // Create and append empty state\r\n    const emptyState = createEmptyState(this.config.emptyMessage);\r\n\r\n    this.contentRoot.appendChild(emptyState);\r\n  }\r\n\r\n  /**\r\n   * Log error with widget ID and version\r\n   */\r\n  private logError(context: string, error: unknown): void {\r\n    if (error instanceof WidgetError) {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        `[${error.code}]`,\r\n        error.message\r\n      );\r\n    } else if (error instanceof Error) {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        error.message\r\n      );\r\n    } else {\r\n      this.logger.error(\r\n        `${context} for widget ${this.config.widgetId}:`,\r\n        error\r\n      );\r\n    }\r\n  }\r\n\r\n  unmount(): void {\r\n    try {\r\n      // Clean up current layout (timers, event listeners, etc.)\r\n      if (this.currentLayout) {\r\n        this.currentLayout.destroy();\r\n        this.currentLayout = null;\r\n      }\r\n\r\n      // Remove all event listeners\r\n      this.cleanupEventListeners();\r\n\r\n      // Clean up style manager\r\n      if (this.styleManager) {\r\n        this.styleManager.cleanup();\r\n        this.styleManager = null;\r\n      }\r\n\r\n      // Remove widget root from DOM\r\n      if (this.root && this.root.parentNode) {\r\n        this.root.parentNode.removeChild(this.root);\r\n        this.root = null;\r\n      }\r\n\r\n      // Unregister instance\r\n      if (this.container) {\r\n        widgetInstances.delete(this.container);\r\n      }\r\n\r\n      this.state.mounted = false;\r\n      this.container = null;\r\n      this.contentRoot = null;\r\n\r\n      this.logger.debug('Unmounted successfully');\r\n    } catch (error) {\r\n      console.error('[TrestaWidget] Unmount failed:', error);\r\n    }\r\n  }\r\n\r\n  async refresh(): Promise<void> {\r\n    try {\r\n      this.logger.debug('Refresh requested');\r\n\r\n      if (!this.state.mounted) {\r\n        this.logger.warn('Cannot refresh: widget not mounted');\r\n        return;\r\n      }\r\n\r\n      // Fetch and render fresh data\r\n      await this.fetchAndRender();\r\n    } catch (error) {\r\n      // Error is already handled in fetchAndRender\r\n      // Just log for debugging\r\n      this.logError('Refresh failed', error);\r\n    }\r\n  }\r\n\r\n  getState(): WidgetState {\r\n    return { ...this.state };\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    this.eventListeners.forEach(({ element, event, handler }) => {\r\n      element.removeEventListener(event, handler);\r\n    });\r\n    this.eventListeners = [];\r\n  }\r\n\r\n  /**\r\n   * Generate a unique instance ID for this widget\r\n   */\r\n  private generateInstanceId(): string {\r\n    return `${this.config.widgetId}-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;\r\n  }\r\n\r\n  /**\r\n   * Announces a message to screen readers via ARIA live region\r\n   */\r\n  private announceToScreenReader(\r\n    message: string,\r\n    priority: 'polite' | 'assertive' = 'polite'\r\n  ): void {\r\n    if (!this.liveRegion) return;\r\n\r\n    // Update the priority if needed\r\n    this.liveRegion.setAttribute('aria-live', priority);\r\n\r\n    // Update the message\r\n    this.liveRegion.textContent = message;\r\n\r\n    // Clear the message after a delay to allow for repeated announcements\r\n    setTimeout(() => {\r\n      if (this.liveRegion) {\r\n        this.liveRegion.textContent = '';\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  /**\r\n   * Get the widget instance for a container\r\n   */\r\n  static getInstance(container: HTMLElement): Widget | undefined {\r\n    return widgetInstances.get(container);\r\n  }\r\n\r\n  /**\r\n   * Get the style manager (for testing)\r\n   */\r\n  getStyleManager(): StyleManager | null {\r\n    return this.styleManager;\r\n  }\r\n\r\n  /**\r\n   * Get the content root element (for testing)\r\n   */\r\n  getContentRoot(): HTMLElement | null {\r\n    return this.contentRoot;\r\n  }\r\n\r\n  /**\r\n   * Get the telemetry tracker (for testing and debugging)\r\n   */\r\n  getTelemetryTracker(): TelemetryTracker {\r\n    return this.telemetryTracker;\r\n  }\r\n}\r\n","/**\r\n * Auto-initialization logic for widgets embedded via script tag\r\n */\r\n\r\nimport { Widget } from './widget';\r\nimport { parseWidgetConfig, validateConfig } from './config';\r\nimport type { WidgetConfig } from '../types';\r\n\r\n/**\r\n * Parse configuration from data attributes on script tag or container\r\n */\r\nfunction parseConfig(element: HTMLScriptElement | HTMLElement): WidgetConfig {\r\n  const config = parseWidgetConfig(element);\r\n  \r\n  // Validate the configuration\r\n  if (!validateConfig(config)) {\r\n    throw new Error('[TrestaWidget] Invalid widget configuration');\r\n  }\r\n  \r\n  return config;\r\n}\r\n\r\n/**\r\n * Find container for widget\r\n */\r\nfunction findContainer(script: HTMLScriptElement, widgetId: string): HTMLElement {\r\n  const containerSelector = script.getAttribute('data-container');\r\n  \r\n  if (containerSelector) {\r\n    const container = document.querySelector(containerSelector);\r\n    if (!container) {\r\n      throw new Error(`[TrestaWidget] Container not found: ${containerSelector}`);\r\n    }\r\n    return container as HTMLElement;\r\n  }\r\n\r\n  // Look for div with matching widget ID\r\n  const defaultContainer = document.getElementById(`tresta-widget-${widgetId}`);\r\n  if (defaultContainer) {\r\n    return defaultContainer;\r\n  }\r\n\r\n  // Create container inline after script tag\r\n  const container = document.createElement('div');\r\n  container.id = `tresta-widget-${widgetId}`;\r\n  script.parentNode?.insertBefore(container, script.nextSibling);\r\n  \r\n  return container;\r\n}\r\n\r\n/**\r\n * Initialize a single widget from a script tag\r\n */\r\nfunction initializeWidget(script: HTMLScriptElement): void {\r\n  try {\r\n    const config = parseConfig(script);\r\n    const container = findContainer(script, config.widgetId);\r\n    \r\n    // Check if already initialized\r\n    const existingInstance = Widget.getInstance(container);\r\n    if (existingInstance) {\r\n      if (config.debug) {\r\n        console.debug(`[TrestaWidget v${config.version || '1.0.0'}] Widget ${config.widgetId} already initialized in container`);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Create and mount new widget instance\r\n    const widget = new Widget(config);\r\n    widget.mount(container);\r\n  } catch (error) {\r\n    console.error('[TrestaWidget] Failed to initialize widget:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Auto-initialize all widgets on the page\r\n */\r\nexport function autoInitialize(): void {\r\n  try {\r\n    // Find all script tags with data-widget-id attribute\r\n    const scripts = document.querySelectorAll('script[data-widget-id]');\r\n    \r\n    if (scripts.length === 0) {\r\n      // No widgets to initialize\r\n      return;\r\n    }\r\n\r\n    // Initialize each widget independently\r\n    scripts.forEach((script) => {\r\n      initializeWidget(script as HTMLScriptElement);\r\n    });\r\n  } catch (error) {\r\n    console.error('[TrestaWidget] Auto-initialization failed:', error);\r\n  }\r\n}\r\n","/**\r\n * Configuration parser and validator\r\n */\r\n\r\nimport type { WidgetConfig, ThemeConfig } from '../types';\r\nimport { ThemeManager } from '../styles/theme-manager';\r\n\r\nexport function parseWidgetConfig(element: HTMLElement): Partial<WidgetConfig> {\r\n  const widgetId = element.getAttribute('data-widget-id');\r\n  const apiKey = element.getAttribute('data-api-key');\r\n  const version = element.getAttribute('data-version');\r\n  const apiUrl = element.getAttribute('data-api-url');\r\n  \r\n  const config: Partial<WidgetConfig> = {\r\n    debug: element.getAttribute('data-debug') === 'true',\r\n    telemetry: element.getAttribute('data-telemetry') !== 'false',\r\n  };\r\n\r\n  if (widgetId) {\r\n    config.widgetId = widgetId;\r\n  }\r\n\r\n  if (apiKey) {\r\n    config.apiKey = apiKey;\r\n  }\r\n\r\n  if (version) {\r\n    config.version = version;\r\n  } else {\r\n    config.version = '1.0.0';\r\n  }\r\n\r\n  if (apiUrl) {\r\n    config.apiUrl = apiUrl;\r\n  }\r\n\r\n  // Parse theme configuration from data attributes\r\n  const themeConfig = ThemeManager.parseThemeFromElement(element);\r\n  if (Object.keys(themeConfig).length > 0) {\r\n    config.theme = themeConfig as ThemeConfig;\r\n  }\r\n\r\n  return config;\r\n}\r\n\r\nexport function validateConfig(config: Partial<WidgetConfig>): config is WidgetConfig {\r\n  if (!config.widgetId) {\r\n    throw new Error('[TrestaWidget] widgetId is required');\r\n  }\r\n  if (!config.apiKey) {\r\n    throw new Error('[TrestaWidget] apiKey is required');\r\n  }\r\n  return true;\r\n}\r\n","/**\r\n * Tresta Widget - CDN-delivered testimonial widget system\r\n * @version 1.0.0\r\n */\r\n\r\nimport { Widget } from './core/widget';\r\nimport { autoInitialize } from './core/loader';\r\nimport type { WidgetConfig, WidgetInstance } from './types';\r\n\r\n// Expose global API\r\nexport const TrestaWidget = {\r\n  /**\r\n   * Programmatically mount a widget instance\r\n   * @param element - Container element or CSS selector\r\n   * @param config - Widget configuration\r\n   * @returns Widget instance\r\n   */\r\n  async mount(element: string | HTMLElement, config: WidgetConfig): Promise<WidgetInstance> {\r\n    const container = typeof element === 'string' \r\n      ? document.querySelector(element) \r\n      : element;\r\n    \r\n    if (!container) {\r\n      throw new Error(`[TrestaWidget] Container not found: ${element}`);\r\n    }\r\n\r\n    const widget = new Widget(config);\r\n    await widget.mount(container as HTMLElement);\r\n    return widget;\r\n  },\r\n\r\n  /**\r\n   * Unmount a widget instance\r\n   * @param element - Container element or CSS selector\r\n   */\r\n  unmount(element: string | HTMLElement): void {\r\n    const container = typeof element === 'string' \r\n      ? document.querySelector(element) \r\n      : element;\r\n    \r\n    if (!container) {\r\n      console.warn(`[TrestaWidget] Container not found: ${element}`);\r\n      return;\r\n    }\r\n\r\n    // Get the widget instance and unmount it properly\r\n    const instance = Widget.getInstance(container as HTMLElement);\r\n    if (instance) {\r\n      instance.unmount();\r\n    } else {\r\n      console.warn(`[TrestaWidget] No widget instance found in container`);\r\n    }\r\n  },\r\n\r\n  version: '1.0.0',\r\n};\r\n\r\n// Auto-initialize widgets on page load\r\nif (typeof window !== 'undefined') {\r\n  // Expose to global scope\r\n  (window as any).TrestaWidget = TrestaWidget;\r\n  \r\n  // Initialize when DOM is ready\r\n  if (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', autoInitialize);\r\n  } else {\r\n    // DOM is already ready, initialize immediately\r\n    autoInitialize();\r\n  }\r\n}\r\n\r\nexport { Widget };\r\nexport type { WidgetConfig, WidgetInstance };\r\n"],"names":["WidgetErrorCode","WidgetError","Error","constructor","code","message","recoverable","super","this","name","ThemeManager","config","__publicField","theme","getDefaultTheme","debug","console","log","mode","primaryColor","secondaryColor","cardStyle","applyTheme","root","applyThemeMode","applyColors","applyFontFamily","applyCardStyle","effectiveMode","detectPreferredColorScheme","setAttribute","window","matchMedia","matches","style","setProperty","fontFamily","fontFamilyWithFallback","updateTheme","getTheme","parseThemeFromElement","element","getAttribute","BASE_STYLES","trim","StyleManager","useShadowDOM","detectShadowDOMSupport","themeConfig","themeManager","Element","prototype","initializeStyles","container","initializeShadowDOM","initializeNamespacedCSS","shadowRoot","attachShadow","styleElement","document","createElement","textContent","getShadowDOMStyles","appendChild","contentWrapper","classList","add","getElementById","id","getNamespacedStyles","head","namespacedStyles","replace","cleanup","getThemeManager","isShadowDOM","getShadowRoot","NetworkClient","addRequestInterceptor","interceptor","requestInterceptors","push","addResponseInterceptor","responseInterceptors","request","url","options","modifiedUrl","modifiedOptions","result","response","async","method","headers","body","timeout","controller","AbortController","timeoutId","setTimeout","abort","fetchOptions","signal","credentials","JSON","stringify","fetch","data","clearTimeout","contentType","get","includes","json","text","status","error","API_TIMEOUT","TypeError","NETWORK_ERROR","fetchWithTimeout","DEFAULT_RETRY_CONFIG","maxRetries","baseDelay","maxDelay","jitter","calculateDelay","attempt","exponentialDelay","Math","pow","random","min","sleep","ms","Promise","resolve","isRetryableError","retryableCodes","API_ERROR","DEFAULT_RATE_LIMITER_CONFIG","maxRequests","windowMs","RateLimiter","Map","isAllowed","key","now","Date","record","getOrCreateRecord","timestamps","filter","timestamp","length","getRetryAfter","records","oldestTimestamp","retryAfter","max","reset","delete","resetAll","clear","getRequestCount","set","updateConfig","getConfig","Logger","widgetId","version","debugEnabled","args","info","warn","logEmpty","isDebugEnabled","getWidgetId","getVersion","DEFAULT_API_CLIENT_CONFIG","baseURL","APIClient","apiKey","logger","networkClient","rateLimiter","fetchWidgetData","UNAUTHORIZED","ceil","RATE_LIMITED","fn","retryConfig","lastError","delay","round","retry","substring","Authorization","rawData","handleResponse","transformApiResponse","errorMessage","apiResponse","widget","errorDetails","hasData","hasWidget","PARSE_ERROR","testimonialCount","testimonials","layout","type","maxTestimonials","settings","autoRotate","rotateInterval","showNavigation","columns","display","showRating","showDate","showAvatar","showAuthorRole","showAuthorCompany","map","t","content","rating","createdAt","isPublished","isApproved","isOAuthVerified","oauthProvider","author","authorName","email","avatar","authorAvatar","role","authorRole","company","authorCompany","media","videoUrl","INVALID_WIDGET_ID","retryAfterHeader","parseInt","getNetworkClient","getRateLimiter","STORE_NAME","IndexedDBAdapter","isAvailable","available","reject","indexedDB","open","onerror","onsuccess","onupgradeneeded","createObjectStore","close","deleteDatabase","getDB","dbPromise","event","db","target","objectStoreNames","contains","keyPath","createIndex","unique","transaction","objectStore","entry","expiresAt","catch","_key","value","put","clearExpired","index","range","IDBKeyRange","upperBound","openCursor","cursor","continue","STORAGE_PREFIX","LocalStorageAdapter","testKey","localStorage","setItem","removeItem","storageKey","item","getItem","parse","serialized","DOMException","retryError","keysToRemove","i","startsWith","forEach","parseError","DEFAULT_TTL","StorageManager","init","initPromise","indexedDBAdapter","adapter","localStorageAdapter","getAdapter","getCacheKey","getTTL","ttl","createErrorState","className","TelemetrySampler","samplingRate","shouldSample","setSamplingRate","rate","getSamplingRate","TelemetryTracker","telemetryDisabled","enabled","dntEnabled","isDNTEnabled","endpoint","sampler","navigator","dnt","doNotTrack","msDoNotTrack","startLoadTracking","loadStartTime","performance","trackLoad","layoutType","loadTime","eventType","send","trackError","errorCode","currentCount","errorCounts","trackInteraction","getTelemetryData","count","sendBeacon","blob","Blob","keepalive","isEnabled","disable","enable","TestimonialCard","testimonial","displayOptions","render","card","renderHeader","renderRating","renderContent","renderDate","innerHTML","join","parts","renderAvatar","escapeHtml","renderVerificationBadge","avatarUrl","provider","fullStars","floor","hasHalfStar","emptyStars","stars","renderStar","fillClass","formattedDate","formatDate","dateString","date","isNaN","getTime","year","month","day","toLocaleDateString","div","Carousel","layoutConfig","carousel","emptyState","track","slide","renderSlide","instructions","renderNavigationButtons","renderDotIndicators","setupEventListeners","startAutoRotate","updateSlidePosition","nav","prevButton","addEventListener","previous","nextButton","next","indicators","_","dot","goToSlide","e","handleTouchStart","passive","handleTouchEnd","pause","resume","handleKeyDown","touch","touches","touchStartX","clientX","changedTouches","touchEndX","handleSwipe","diff","abs","preventDefault","isTransitioning","currentIndex","animate","querySelector","slides","querySelectorAll","dots","offset","transform","transition","isActive","remove","interval","autoRotateTimer","setInterval","isPaused","stopAutoRotate","clearInterval","destroy","clonedContainer","cloneNode","parentNode","replaceChild","Grid","grid","toString","renderItem","Masonry","masonry","setupResizeObserver","ResizeObserver","resizeObserver","entries","height","contentRect","rowSpan","gridRowEnd","observe","disconnect","Wall","wall","shouldBeFeatured","isPositionFeatured","isHighRated","isVerified","List","list","LayoutEngine","create","sortByCreatedAtDesc","sort","a","b","dateA","DEFAULT_ALLOWED_DOMAINS","CSPValidator","allowedDomains","reportViolations","setupViolationListener","validateURL","hostname","URL","some","domain","endsWith","validateResources","violations","img","src","script","iframe","link","href","valid","detectStrictCSP","meta","getNonce","nonce","scripts","Array","from","applyNonce","tagName","getViolations","clearViolations","blockedURI","isWidgetRelated","violatedDirective","directive","sourceFile","widgetInstances","WeakMap","Widget","state","mounted","loading","apiClientConfig","apiUrl","apiClient","storageManager","telemetryTracker","telemetry","cspValidator","mount","has","existingWidget","unmount","generateInstanceId","lang","styleManager","contentRoot","liveRegion","fetchAndRender","logError","renderErrorState","announceToScreenReader","fetchWithFallback","cached","hasContentRoot","widgetData","renderEmptyState","limitedTestimonials","limit","slice","limitTestimonials","currentLayout","layoutElement","cspResult","errorState","emptyMessage","context","cleanupEventListeners","removeChild","refresh","getState","eventListeners","handler","removeEventListener","priority","getInstance","getStyleManager","getContentRoot","getTelemetryTracker","initializeWidget","Object","keys","parseWidgetConfig","validateConfig","parseConfig","containerSelector","defaultContainer","insertBefore","nextSibling","findContainer","autoInitialize","TrestaWidget","instance","readyState"],"mappings":"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"}