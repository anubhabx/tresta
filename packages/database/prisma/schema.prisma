// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String  @id @default(cuid()) // Clerk user Id
  email     String  @unique
  firstName String?
  lastName  String?
  avatar    String? @db.VarChar(1000) // Avatar URL from Azure Blob Storage

  plan         UserPlan      @default(FREE)
  projects     Project[]
  testimonials Testimonial[]
  apiKeys      ApiKey[]
  subscription Subscription? // null for free tier users

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id                   String             @id @default(cuid())
  userId               String
  name                 String             @db.VarChar(255)
  shortDescription     String?            @db.VarChar(500)
  description          String?            @db.Text
  slug                 String             @unique @db.VarChar(255)
  logoUrl              String?            @db.VarChar(1000)
  projectType          ProjectType?       @default(OTHER)
  websiteUrl           String?            @db.VarChar(1000)
  collectionFormUrl    String?            @db.VarChar(1000)
  brandColorPrimary    String?            @db.VarChar(7) // Hex color code
  brandColorSecondary  String?            @db.VarChar(7) // Hex color code
  socialLinks          Json? // { twitter: "...", linkedin: "...", github: "..." }
  tags                 String[] // Array of tags for internal categorization
  visibility           ProjectVisibility  @default(PRIVATE)
  isActive             Boolean            @default(true)
  
  // Auto-Moderation Settings
  autoModeration       Boolean            @default(true) // Enable auto-moderation
  autoApproveVerified  Boolean            @default(false) // Auto-approve verified users
  profanityFilterLevel String?            @default("MODERATE") // STRICT, MODERATE, LENIENT
  moderationSettings   Json?              // Custom moderation rules
  
  testimonials         Testimonial[]
  widgets              Widget[]
  apiKeys              ApiKey[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([visibility])
  @@index([projectType])
}

model Subscription {
  id        String             @id @default(cuid())
  userId    String             @unique
  status    SubscriptionStatus // e.g., "active", "canceled", etc.
  plan      UserPlan           @default(FREE) // e.g., "free", "pro", etc.
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  externalSubscriptionId String?   @unique
  externalCustomerId     String?
  priceId                String?
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean   @default(false)

  amount   Int?    // Amount in smallest currency units
  currency String? @default("INR") // Currency Code
  interval String? // "month", "year"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Testimonial {
  id          String          @id @default(cuid())
  userId      String?
  projectId   String?
  authorName  String          @db.VarChar(255)
  authorEmail String?         @db.VarChar(255)
  authorRole  String?         @db.VarChar(255) // e.g., "CEO", "Marketing Manager"
  authorCompany String?       @db.VarChar(255) // e.g., "Acme Inc."
  authorAvatar String?        @db.VarChar(1000) // Avatar URL from Azure Blob Storage
  content     String          @db.Text
  type        TestimonialType @default(TEXT)
  videoUrl    String?
  mediaUrl    String?
  source      String?         @db.VarChar(100) // e.g., "manual", "twitter", etc.
  sourceUrl   String?         @db.VarChar(500) // e.g., URL of the tweet if sourced from Twitter
  oembedData  Json? // Store oEmbed (Extracted Embed Info)
  isPublished Boolean         @default(false)
  rating      Int?            @db.SmallInt // e.g., 1 to 5 stars
  isApproved  Boolean         @default(false) // For moderation purposes
  ipAddress   String?         @db.VarChar(45) // To store IPv6 addresses if needed
  userAgent   String?         @db.Text // To store user agent string if needed
  
  // OAuth Verification
  isOAuthVerified Boolean       @default(false) // True if verified via OAuth
  oauthProvider   String?       @db.VarChar(50) // e.g., "google", "github"
  oauthSubject    String?       @db.VarChar(255) // OAuth subject/user ID for verification

  // Auto-Moderation
  moderationStatus  ModerationStatus @default(PENDING)
  moderationScore   Float?           // 0-1, higher = more likely spam
  moderationFlags   Json?            // Array of detected issues
  autoPublished     Boolean          @default(false) // True if auto-approved by moderation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tags    Tag[]    @relation("TestimonialTags")

  @@index([userId])
  @@index([projectId])
  @@index([isPublished])
  @@index([createdAt])
  @@index([isOAuthVerified])
}

enum TestimonialType {
  TEXT
  VIDEO
  AUDIO
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model Widget {
  id        String   @id @default(cuid())
  projectId String?
  config    Json // Customization tokens, colors, layout, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ApiKey {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(255) // e.g., "Production Widget Key", "Development Key"
  keyHash     String   @unique @db.VarChar(255) // Hashed API key (bcrypt)
  keyPrefix   String   @db.VarChar(20) // Visible prefix for identification (e.g., "tresta_live_abcd1234")
  
  // Relations
  userId      String
  projectId   String
  
  // Permissions & Limits
  permissions Json?    // { widgets: true, testimonials: false, analytics: false }
  usageCount  Int      @default(0) // Total number of requests
  usageLimit  Int?     // Maximum allowed requests (null = unlimited)
  rateLimit   Int      @default(100) // Requests per hour
  
  // Status & Lifecycle
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime? // null = never expires
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([keyHash])
  @@index([isActive])
}

model Tag {
  id           String        @id @default(cuid())
  name         String        @unique
  testimonials Testimonial[] @relation("TestimonialTags")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  PAUSED
  INCOMPLETE
  TRIALING
}

enum UserPlan {
  FREE
  PRO
}

enum ProjectType {
  SAAS_APP
  PORTFOLIO
  MOBILE_APP
  CONSULTING_SERVICE
  E_COMMERCE
  AGENCY
  FREELANCE
  PRODUCT
  COURSE
  COMMUNITY
  OTHER
}

enum ProjectVisibility {
  PUBLIC
  PRIVATE
  INVITE_ONLY
}
