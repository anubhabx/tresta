// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  engineType    = "binary"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String  @id @default(cuid()) // Clerk user Id
  email     String  @unique
  firstName String?
  lastName  String?
  avatar    String? @db.VarChar(1000) // Avatar URL from Azure Blob Storage

  plan         UserPlan      @default(FREE)
  projects     Project[]
  testimonials Testimonial[]
  apiKeys      ApiKey[]
  subscription Subscription? // null for free tier users
  subscriptionPayments SubscriptionPayment[]

  // Notification system relations
  notifications           Notification[]
  notificationPreferences NotificationPreferences?

  // Admin tracking
  lastLogin DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Project {
  id                  String            @id @default(cuid())
  userId              String
  name                String            @db.VarChar(255)
  shortDescription    String?           @db.VarChar(500)
  description         String?           @db.Text
  slug                String            @unique @db.VarChar(255)
  logoUrl             String?           @db.VarChar(1000)
  projectType         ProjectType?      @default(OTHER)
  websiteUrl          String?           @db.VarChar(1000)
  collectionFormUrl   String?           @db.VarChar(1000)
  brandColorPrimary   String?           @db.VarChar(7) // Hex color code
  brandColorSecondary String?           @db.VarChar(7) // Hex color code
  socialLinks         Json? // { twitter: "...", linkedin: "...", github: "..." }
  tags                String[] // Array of tags for internal categorization
  visibility          ProjectVisibility @default(PRIVATE)
  isActive            Boolean           @default(true)

  // Auto-Moderation Settings
  autoModeration       Boolean @default(true) // Enable auto-moderation
  autoApproveVerified  Boolean @default(false) // Auto-approve verified users
  profanityFilterLevel String? @default("MODERATE") // STRICT, MODERATE, LENIENT
  moderationSettings   Json? // Custom moderation rules

  testimonials Testimonial[]
  widgets      Widget[]
  apiKeys      ApiKey[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([visibility])
  @@index([projectType])
}

model Plan {
  id             String   @id @default(cuid())
  name           String   @db.VarChar(255) // e.g., "Pro Plan", "Starter"
  description    String?  @db.Text
  price          Int // Amount in smallest currency unit (e.g., paise)
  currency       String   @default("INR") @db.VarChar(3)
  interval       String // "month", "year"
  isActive       Boolean  @default(true)
  limits         Json // { "projects": 5, "teamMembers": 2 }
  razorpayPlanId String?  @unique // ID from Razorpay
  type           UserPlan @default(FREE) // Mapping to enum for code compatibility

  subscriptions Subscription[]
  subscriptionPayments SubscriptionPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Subscription {
  id     String             @id @default(cuid())
  userId String             @unique
  status SubscriptionStatus // e.g., "active", "canceled", etc.

  // Mirror of provider lifecycle states (Razorpay)
  // Expected values: created, authenticated, active, pending, halted, paused, cancelled, completed, expired
  providerStatus String? @db.VarChar(32)

  // Relations
  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  // Legacy/Code Enum fallback (optional, but good to keep synced)
  userPlan UserPlan @default(FREE) @map("plan")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalSubscriptionId String? @unique // Razorpay Subscription ID
  externalCustomerId     String? // Razorpay Customer ID (optional)

  // Razorpay Specifics
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  lastPaymentStatus String? @db.VarChar(32)
  lastInvoiceStatus String? @db.VarChar(32)
  lastWebhookEventId   String?   @db.VarChar(255)
  lastWebhookEventType String?   @db.VarChar(128)
  lastWebhookAt        DateTime?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  // Snapshot of price at time of subscription
  amount   Int? // Amount in smallest currency units
  currency String? @default("INR")
  interval String? // "month", "year"

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments SubscriptionPayment[]

  @@index([userId])
  @@index([userId, externalSubscriptionId])
  @@index([planId])
  @@index([status])
  @@index([providerStatus])
  @@index([lastWebhookAt])
}

model SubscriptionPayment {
  id                     String    @id @default(cuid())
  provider               String    @default("razorpay") @db.VarChar(32)
  externalPaymentId      String?   @db.VarChar(64)
  externalInvoiceId      String?   @db.VarChar(64)
  externalSubscriptionId String?   @db.VarChar(64)
  userId                 String
  subscriptionId         String
  planId                 String?
  paymentStatus          String?   @db.VarChar(32)
  invoiceStatus          String?   @db.VarChar(32)
  amount                 Int?
  currency               String?   @db.VarChar(8)
  eventType              String    @db.VarChar(128)
  eventCreatedAt         DateTime?
  paidAt                 DateTime?
  failedAt               DateTime?
  rawSnapshot            Json?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  plan         Plan?        @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@unique([provider, externalPaymentId])
  @@unique([provider, externalInvoiceId])
  @@index([userId, createdAt])
  @@index([subscriptionId, createdAt])
  @@index([planId])
  @@index([paymentStatus])
  @@index([invoiceStatus])
  @@index([eventType, eventCreatedAt])
}

model PaymentWebhookEvent {
  id              String    @id @default(cuid())
  provider        String    @db.VarChar(32)
  providerEventId String    @unique @db.VarChar(255)
  eventType       String    @db.VarChar(128)
  subscriptionId  String?
  payload         Json
  status          String    @default("processed") @db.VarChar(32)
  error           String?   @db.Text
  receivedAt      DateTime  @default(now())
  processedAt     DateTime?

  @@index([provider, eventType])
  @@index([subscriptionId])
  @@index([receivedAt])
}

model Testimonial {
  id            String          @id @default(cuid())
  userId        String?
  projectId     String?
  authorName    String          @db.VarChar(255)
  authorEmail   String?         @db.VarChar(255)
  authorRole    String?         @db.VarChar(255) // e.g., "CEO", "Marketing Manager"
  authorCompany String?         @db.VarChar(255) // e.g., "Acme Inc."
  authorAvatar  String?         @db.VarChar(1000) // Avatar URL from Azure Blob Storage
  content       String          @db.Text
  type          TestimonialType @default(TEXT)
  videoUrl      String?
  mediaUrl      String?
  source        String?         @db.VarChar(100) // e.g., "manual", "twitter", etc.
  sourceUrl     String?         @db.VarChar(500) // e.g., URL of the tweet if sourced from Twitter
  oembedData    Json? // Store oEmbed (Extracted Embed Info)
  isPublished   Boolean         @default(false)
  rating        Int?            @db.SmallInt // e.g., 1 to 5 stars
  isApproved    Boolean         @default(false) // For moderation purposes
  ipAddress     String?         @db.VarChar(45) // To store IPv6 addresses if needed
  userAgent     String?         @db.Text // To store user agent string if needed

  // OAuth Verification
  isOAuthVerified Boolean @default(false) // True if verified via OAuth
  oauthProvider   String? @db.VarChar(50) // e.g., "google", "github"
  oauthSubject    String? @db.VarChar(255) // OAuth subject/user ID for verification

  // Auto-Moderation
  moderationStatus ModerationStatus @default(PENDING)
  moderationScore  Float? // 0-1, higher = more likely spam
  moderationFlags  Json? // Array of detected issues
  autoPublished    Boolean          @default(false) // True if auto-approved by moderation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  Project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tags    Tag[]    @relation("TestimonialTags")

  @@index([userId])
  @@index([projectId])
  @@index([isPublished])
  @@index([createdAt])
  @@index([isOAuthVerified])
}

enum TestimonialType {
  TEXT
  VIDEO
  AUDIO
}

enum ModerationStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model Widget {
  id        String   @id @default(cuid())
  projectId String?
  config    Json // Customization tokens, colors, layout, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ApiKey {
  id        String @id @default(cuid())
  name      String @db.VarChar(255) // e.g., "Production Widget Key", "Development Key"
  keyHash   String @unique @db.VarChar(255) // Hashed API key (bcrypt)
  keyPrefix String @db.VarChar(20) // Visible prefix for identification (e.g., "tresta_live_abcd1234")

  // Relations
  userId    String
  projectId String

  // Permissions & Limits
  permissions Json? // { widgets: true, testimonials: false, analytics: false }
  usageCount  Int   @default(0) // Total number of requests
  usageLimit  Int? // Maximum allowed requests (null = unlimited)
  rateLimit   Int   @default(100) // Requests per hour

  // Status & Lifecycle
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime? // null = never expires

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([keyHash])
  @@index([isActive])
}

model Tag {
  id           String        @id @default(cuid())
  name         String        @unique
  testimonials Testimonial[] @relation("TestimonialTags")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  PAUSED
  INCOMPLETE
  TRIALING
}

enum UserPlan {
  FREE
  PRO
}

enum ProjectType {
  SAAS_APP
  PORTFOLIO
  MOBILE_APP
  CONSULTING_SERVICE
  E_COMMERCE
  AGENCY
  FREELANCE
  PRODUCT
  COURSE
  COMMUNITY
  OTHER
}

enum ProjectVisibility {
  PUBLIC
  PRIVATE
  INVITE_ONLY
}

// ============================================
// Notification System Models
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text // Sanitized HTML-safe content
  link      String?
  metadata  Json? // Additional data (testimonialId, projectId, etc.)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([createdAt])
}

enum NotificationType {
  NEW_TESTIMONIAL
  TESTIMONIAL_FLAGGED
  TESTIMONIAL_APPROVED
  TESTIMONIAL_REJECTED
  SECURITY_ALERT
}

model NotificationPreferences {
  id           String   @id @default(cuid())
  userId       String   @unique
  emailEnabled Boolean  @default(true)
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailUsage {
  id                String   @id @default(cuid())
  date              String   @unique // Format: YYYY-MM-DD (UTC timezone)
  count             Int      @default(0)
  lastSnapshotCount Int      @default(0) // Track last snapshot for reconciliation
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([date])
}

// Transactional outbox pattern - ensures reliable job enqueuing
model NotificationOutbox {
  id             String    @id @default(cuid())
  notificationId String
  jobType        String // 'send-notification' or 'send-email'
  payload        Json
  status         String    @default("pending") // pending, enqueued, failed
  attempts       Int       @default(0)
  createdAt      DateTime  @default(now())
  enqueuedAt     DateTime?

  @@index([status, createdAt])
  @@index([notificationId])
}

// Dead Letter Queue for failed jobs
model DeadLetterJob {
  id               String    @id @default(cuid())
  jobId            String
  queue            String // 'notifications' or 'send-email'
  data             Json
  error            String    @db.Text
  errorType        String // 'transient' or 'permanent'
  statusCode       Int?
  providerResponse String?   @db.Text // Truncated provider response
  failedAt         DateTime
  retried          Boolean   @default(false)
  retriedAt        DateTime?
  retryHistory     Json? // Array of retry attempts with timestamps

  @@index([queue, failedAt])
  @@index([retried])
  @@index([errorType])
}

// Job idempotency tracking (durable across restarts)
model JobIdempotency {
  id          String    @id @default(cuid())
  jobKey      String    @unique // Format: {jobType}:{entityId}
  jobId       String // BullMQ job ID
  status      String // 'processing', 'completed', 'failed'
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([jobKey, status])
  @@index([createdAt])
}

// ============================================
// Admin Panel Models
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String // Clerk user ID of admin
  action      String // e.g., "PATCH /admin/testimonials/:id/status"
  method      String // HTTP method (GET, POST, PUT, PATCH, DELETE)
  path        String // Request path
  targetType  String? // e.g., "user", "project", "testimonial"
  targetId    String? // ID of the affected resource
  requestBody Json? // Sanitized request body
  statusCode  Int? // HTTP response status code
  success     Boolean  @default(true)
  requestId   String // X-Request-ID for correlation with Sentry
  ipAddress   String?
  userAgent   String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([adminId, createdAt])
  @@index([targetType, targetId])
  @@index([requestId])
  @@index([createdAt])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique // e.g., "email_quota_limit", "ably_connection_limit"
  value     String   @db.Text // JSON-encoded value
  version   Int      @default(1) // For optimistic locking
  updatedBy String? // Admin user ID who last updated
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([key])
}

model AlertConfig {
  id                     String   @id @default(cuid())
  emailQuotaThreshold    Int      @default(80) // Percentage (0-100)
  dlqCountThreshold      Int      @default(100)
  failedJobRateThreshold Float    @default(0.1) // 0-1 (10%)
  updatedBy              String? // Admin user ID
  updatedAt              DateTime @updatedAt
  createdAt              DateTime @default(now())
}

model AlertHistory {
  id         String        @id @default(cuid())
  alertType  String // e.g., "EMAIL_QUOTA_EXCEEDED", "DLQ_THRESHOLD_EXCEEDED"
  severity   AlertSeverity
  message    String        @db.Text
  metadata   Json? // Additional context
  resolved   Boolean       @default(false)
  resolvedAt DateTime?
  resolvedBy String? // Admin user ID
  createdAt  DateTime      @default(now())

  @@index([alertType, createdAt])
  @@index([resolved])
  @@index([createdAt])
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

model ErrorLog {
  id            String        @id @default(cuid())
  severity      ErrorSeverity
  errorType     String // e.g., "DatabaseError", "ValidationError"
  message       String        @db.Text
  stackTrace    String?       @db.Text
  requestId     String? // X-Request-ID for correlation
  sentryEventId String? // Sentry event ID
  userId        String? // Affected user ID
  metadata      Json? // Additional context
  archived      Boolean       @default(false)
  archivedAt    DateTime?
  createdAt     DateTime      @default(now())

  @@index([severity, createdAt])
  @@index([errorType])
  @@index([requestId])
  @@index([sentryEventId])
  @@index([archived, createdAt])
}

enum ErrorSeverity {
  ERROR
  WARNING
  CRITICAL
}

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "auto_moderation", "bulk_operations"
  name        String // Human-readable name
  description String?  @db.Text
  enabled     Boolean  @default(false)
  metadata    Json? // Additional configuration
  updatedBy   String? // Admin user ID
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([key])
  @@index([enabled])
}

// ============================================
// Widget Analytics Models
// ============================================

model WidgetAnalytics {
  id         String   @id @default(cuid())
  widgetId   String
  projectId  String
  loadTime   Int // Load time in milliseconds
  layoutType String // carousel, grid, masonry, wall, list
  browser    String? // Browser name
  device     String? // desktop, mobile, tablet
  country    String? // ISO country code
  errorCode  String? // Error code if load failed
  version    String // Widget version
  timestamp  DateTime @default(now())

  @@index([widgetId, timestamp])
  @@index([projectId, timestamp])
  @@index([timestamp])
  @@index([errorCode])
}

model WidgetPerformanceAlert {
  id          String          @id @default(cuid())
  widgetId    String
  projectId   String
  alertType   WidgetAlertType
  severity    AlertSeverity
  message     String          @db.Text
  threshold   Float // The threshold that was exceeded
  actualValue Float // The actual value that triggered the alert
  resolved    Boolean         @default(false)
  resolvedAt  DateTime?
  createdAt   DateTime        @default(now())

  @@index([widgetId, createdAt])
  @@index([projectId, createdAt])
  @@index([resolved])
}

enum WidgetAlertType {
  LOAD_TIME_EXCEEDED
  ERROR_RATE_EXCEEDED
}
